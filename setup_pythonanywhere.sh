#!/bin/bash

# ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° FocusFlow Ð½Ð° PythonAnywhere
# Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð½ÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ FocusFlow - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð´Ð»Ñ PythonAnywhere"
echo "============================================================"
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑƒÑÐ¿ÐµÑ…Ð°
success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ
warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸
error() {
    echo -e "${RED}âœ—${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "wsgi.py" ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ°: wsgi.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ FocusFlow"
    exit 1
fi

success "ÐÐ°Ð¹Ð´ÐµÐ½Ð° ÐºÐ¾Ñ€Ð½ÐµÐ²Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"

# Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
echo ""
echo "ðŸ“¦ Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
if [ -d "$HOME/.virtualenvs/focusflow-env" ]; then
    warning "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼"
else
    mkvirtualenv --python=/usr/bin/python3.10 focusflow-env
    success "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾"
fi

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
source $HOME/.virtualenvs/focusflow-env/bin/activate

# Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
echo ""
echo "ðŸ“š Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install --upgrade pip
pip install -r requirements-pythonanywhere.txt
success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# Ð¨Ð°Ð³ 3: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° .env
echo ""
echo "ðŸ”§ Ð¨Ð°Ð³ 3: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
cd backend

if [ -f ".env" ]; then
    warning ".env Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    read -p "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        warning "ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env"
        cd ..
    else
        cp .env.example .env
        success ".env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
        cd ..
    fi
else
    cp .env.example .env
    success ".env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
    cd ..
fi

# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ SECRET_KEY
echo ""
echo "ðŸ”‘ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ SECRET_KEY..."
SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))")
echo "Ð’Ð°Ñˆ SECRET_KEY: $SECRET_KEY"
echo ""
warning "Ð’ÐÐ–ÐÐž: Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÐºÐ»ÑŽÑ‡ Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÐµÐ³Ð¾ Ð² backend/.env"
echo "ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»: nano backend/.env"
echo "Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ 'your-secret-key-here' Ð½Ð° ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡"
echo ""
read -p "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚Ðµ SECRET_KEY Ð² .env..."

# Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo ""
echo "ðŸ“ Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p backend/uploads/music
mkdir -p backend/uploads/avatars
mkdir -p backend/uploads/chat_avatars
mkdir -p instance

chmod 755 backend/uploads
chmod 755 backend/uploads/music
chmod 755 backend/uploads/avatars
chmod 755 backend/uploads/chat_avatars
chmod 755 instance

success "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"

# Ð¨Ð°Ð³ 5: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo ""
echo "ðŸ—„ï¸  Ð¨Ð°Ð³ 5: Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
cd backend

if [ -f "../instance/focus_app.db" ]; then
    warning "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    read -p "ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f ../instance/focus_app.db
        python3 -c "from app import app, db; app.app_context().push(); db.create_all(); print('Database created!')"
        success "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð°"
    else
        warning "ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ð‘Ð”"
    fi
else
    python3 -c "from app import app, db; app.app_context().push(); db.create_all(); print('Database created!')"
    success "Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
fi

cd ..

# Ð¨Ð°Ð³ 6: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ username
echo ""
echo "ðŸ‘¤ Ð¨Ð°Ð³ 6: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° WSGI..."
echo ""
echo "Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ WSGI Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð½Ð°Ñ‚ÑŒ Ð²Ð°Ñˆ username Ð½Ð° PythonAnywhere"
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ username: " PA_USERNAME

if [ -z "$PA_USERNAME" ]; then
    error "Username Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ð¾Ð³Ð¾ WSGI Ñ„Ð°Ð¹Ð»Ð°
cat > wsgi_configured.py << EOF
"""
WSGI configuration for PythonAnywhere deployment
Configured for user: $PA_USERNAME
"""
import sys
import os

# Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ðº Ð²Ð°ÑˆÐµÐ¼Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
path = '/home/$PA_USERNAME/FocusFlow'
if path not in sys.path:
    sys.path.insert(0, path)

# Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑ‚ÑŒ Ðº backend
backend_path = os.path.join(path, 'backend')
if backend_path not in sys.path:
    sys.path.insert(0, backend_path)

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð½Ð° backend
os.chdir(backend_path)

# Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
from app import app as application

# Ð”Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
app = application
EOF

success "Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ WSGI Ñ„Ð°Ð¹Ð»: wsgi_configured.py"

# Ð¨Ð°Ð³ 7: Ð’Ñ‹Ð²Ð¾Ð´ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¹ Ð´Ð»Ñ Web tab
echo ""
echo "============================================================"
echo "ðŸŽ‰ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "============================================================"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸ (Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð² Web tab):"
echo ""
echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Web tab Ð½Ð° PythonAnywhere"
echo "2. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Add a new web app'"
echo "3. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ 'Manual configuration' â†’ 'Python 3.10'"
echo ""
echo "4. Ð’ Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ 'Code' â†’ 'WSGI configuration file':"
echo "   - ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»"
echo "   - Ð£Ð´Ð°Ð»Ð¸Ñ‚Ðµ Ð²ÑÑ‘ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ"
echo "   - Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¸Ð·: ~/FocusFlow/wsgi_configured.py"
echo "   - Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ"
echo ""
echo "5. Ð’ Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ 'Virtualenv':"
echo "   Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ: /home/$PA_USERNAME/.virtualenvs/focusflow-env"
echo ""
echo "6. Ð’ Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ 'Static files' Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ:"
echo "   URL: /static/"
echo "   Directory: /home/$PA_USERNAME/FocusFlow/backend/static/"
echo ""
echo "   URL: /uploads/"
echo "   Directory: /home/$PA_USERNAME/FocusFlow/backend/uploads/"
echo ""
echo "7. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð·ÐµÐ»ÐµÐ½ÑƒÑŽ ÐºÐ½Ð¾Ð¿ÐºÑƒ 'Reload'"
echo ""
echo "============================================================"
echo ""
echo "ðŸ“– ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: PYTHONANYWHERE_DEPLOYMENT.md"
echo "âœ… Ð§ÐµÐºÐ»Ð¸ÑÑ‚: DEPLOYMENT_CHECKLIST.md"
echo ""
echo "ðŸŒ Ð’Ð°Ñˆ ÑÐ°Ð¹Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:"
echo "   https://$PA_USERNAME.pythonanywhere.com"
echo ""
success "Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð£Ð´Ð°Ñ‡Ð¸! ðŸš€"
