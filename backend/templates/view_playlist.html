<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ playlist.name }} - FocusFlow</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #0ea5e9;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        [data-theme="dark"] {
            --bg-main: #050510;
            --bg-card: rgba(15, 15, 35, 0.8);
            --bg-input: rgba(10, 10, 30, 0.6);
            --text-primary: #f0f0ff;
            --text-secondary: #8888aa;
            --border-color: rgba(99, 102, 241, 0.2);
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(14, 165, 233, 0.1) 0%, transparent 50%);
            filter: blur(60px);
            z-index: -1;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
            padding-bottom: 120px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        .back-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-btn:hover { background: rgba(99, 102, 241, 0.1); }
        .header-title { font-size: 1.2rem; font-weight: 600; }
        
        .playlist-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .playlist-cover {
            width: 100px; height: 100px;
            background: var(--gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            flex-shrink: 0;
        }
        .playlist-info { flex: 1; min-width: 0; }
        .playlist-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .playlist-owner {
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .playlist-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .play-all-btn {
            width: 56px; height: 56px;
            border-radius: 50%;
            background: var(--gradient);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        .play-all-btn:hover { transform: scale(1.1); }
        
        .tracks-list {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .track-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .track-item:last-child { border-bottom: none; }
        .track-item:hover { background: rgba(99, 102, 241, 0.1); }
        .track-item.playing { background: rgba(99, 102, 241, 0.15); }
        .track-num {
            width: 28px; height: 28px;
            background: var(--bg-input);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .track-item.playing .track-num {
            background: var(--gradient);
            color: white;
        }
        .track-info { flex: 1; min-width: 0; }
        .track-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-artist {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .track-duration {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .player-panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 100;
        }
        .player-info { flex: 1; min-width: 0; }
        .player-track-name { font-weight: 600; }
        .player-artist { font-size: 0.85rem; color: var(--text-secondary); }
        .player-controls { display: flex; align-items: center; gap: 12px; }
        .player-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-btn:hover { background: rgba(99, 102, 241, 0.2); }
        .player-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .player-btn-main {
            width: 52px; height: 52px;
            background: var(--gradient);
            border: none;
            color: white;
        }
        .player-btn-main svg { width: 24px; height: 24px; }
        .player-progress {
            flex: 1;
            max-width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--gradient);
            width: 0%;
        }
        .player-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 90px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="history.back()">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <span class="header-title">–ü–ª–µ–π–ª–∏—Å—Ç</span>
        </div>
        
        <div class="playlist-header">
            <div class="playlist-cover">üéµ</div>
            <div class="playlist-info">
                <h1 class="playlist-title">{{ playlist.name }}</h1>
                <p class="playlist-owner">{{ owner.name or owner.username }}</p>
                <p class="playlist-meta" id="trackCount">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="play-all-btn" onclick="playAll()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </button>
        </div>
        
        <div class="tracks-list" id="tracksList"></div>
    </div>
    
    <div class="player-panel" id="playerPanel" style="display: none;">
        <div class="player-info">
            <div class="player-track-name" id="playerTrackName">-</div>
            <div class="player-artist" id="playerArtist">-</div>
        </div>
        <div class="player-controls">
            <button class="player-btn" onclick="prevTrack()">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>
            <button class="player-btn player-btn-main" onclick="togglePlay()">
                <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="player-btn" onclick="nextTrack()">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
        </div>
        <div class="player-progress" onclick="seekTrack(event)">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="player-time" id="playerTime">0:00 / 0:00</div>
    </div>
    
    <audio id="audioPlayer"></audio>
    
    <script>
        const userId = {{ owner.id }};
        const playlistId = {{ playlist.id }};
        let tracks = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        const audio = document.getElementById('audioPlayer');
        
        async function loadTracks() {
            const res = await fetch(`/api/users/${userId}/pinned-playlist`);
            const data = await res.json();
            if (data.playlist && data.playlist.id === playlistId) {
                tracks = data.playlist.tracks;
                renderTracks();
            }
        }
        
        function renderTracks() {
            document.getElementById('trackCount').textContent = `${tracks.length} —Ç—Ä–µ–∫–æ–≤`;
            const list = document.getElementById('tracksList');
            list.innerHTML = tracks.map((t, i) => `
                <div class="track-item ${currentTrackIndex === i ? 'playing' : ''}" onclick="playTrack(${i})">
                    <div class="track-num">${i + 1}</div>
                    <div class="track-info">
                        <div class="track-title">${escapeHtml(t.title)}</div>
                        <div class="track-artist">${escapeHtml(t.artist || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')}</div>
                    </div>
                    <div class="track-duration">${formatTime(t.duration)}</div>
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function playTrack(index) {
            currentTrackIndex = index;
            const track = tracks[index];
            audio.src = track.url;
            audio.play();
            isPlaying = true;
            document.getElementById('playerPanel').style.display = 'flex';
            document.getElementById('playerTrackName').textContent = track.title;
            document.getElementById('playerArtist').textContent = track.artist || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
            updatePlayIcon();
            renderTracks();
        }
        
        function playAll() { if (tracks.length) playTrack(0); }
        function togglePlay() {
            if (isPlaying) audio.pause(); else audio.play();
            isPlaying = !isPlaying;
            updatePlayIcon();
        }
        function updatePlayIcon() {
            document.getElementById('playIcon').innerHTML = isPlaying 
                ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' 
                : '<path d="M8 5v14l11-7z"/>';
        }
        function prevTrack() { if (currentTrackIndex > 0) playTrack(currentTrackIndex - 1); }
        function nextTrack() { if (currentTrackIndex < tracks.length - 1) playTrack(currentTrackIndex + 1); }
        function seekTrack(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
        }
        audio.addEventListener('timeupdate', () => {
            document.getElementById('progressBar').style.width = ((audio.currentTime / audio.duration) * 100 || 0) + '%';
            document.getElementById('playerTime').textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration || 0)}`;
        });
        audio.addEventListener('ended', nextTrack);
        
        loadTracks();
    </script>
</body>
</html>
