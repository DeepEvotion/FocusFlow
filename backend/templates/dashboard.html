<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FocusFlow</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/emerald-theme.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Кастомный скроллбар */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.4);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.6);
        }
        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(16, 185, 129, 0.4) rgba(16, 185, 129, 0.1);
        }
        :root {
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --secondary: #14b8a6;
            --accent: #06b6d4;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        [data-theme="dark"] {
            --bg-main: #000000;
            --bg-card: rgba(10, 20, 15, 0.8);
            --bg-sidebar: rgba(5, 15, 10, 0.95);
            --bg-input: rgba(5, 15, 10, 0.6);
            --text-primary: #e0f2e9;
            --text-secondary: #6b8f7a;
            --border-color: rgba(16, 185, 129, 0.2);
        }
        [data-theme="light"] {
            --bg-main: #f5f7ff;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-sidebar: rgba(255, 255, 255, 0.98);
            --bg-input: rgba(240, 242, 255, 0.8);
            --text-primary: #1a1a2e;
            --text-secondary: #6b7280;
            --border-color: rgba(99, 102, 241, 0.25);
        }
        [data-theme="light"] body::before {
            background: radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(14, 165, 233, 0.06) 0%, transparent 50%),
                        radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.04) 0%, transparent 60%);
        }
        [data-theme="light"] .stars-bg { opacity: 0.3; }
        [data-theme="light"] .stars-bg .star { background: var(--primary); }
        [data-theme="light"] .nebula { opacity: 0.08; }
        [data-theme="light"] .modal { background: #ffffff; }
        [data-theme="light"] .player-panel { background: rgba(255, 255, 255, 0.85); }
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Контейнер фона - как на главной */
        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        /* Nebula эффекты - как на главной с блюром */
        .nebula {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.12;
            animation: float 20s ease-in-out infinite;
        }
        .nebula-1 {
            width: 600px;
            height: 600px;
            background: #10b981;
            top: -10%;
            left: -10%;
        }
        .nebula-2 {
            width: 500px;
            height: 500px;
            background: #14b8a6;
            bottom: 10%;
            right: -5%;
            animation-delay: -10s;
        }
        .nebula-3 {
            width: 400px;
            height: 400px;
            background: #06b6d4;
            top: 40%;
            left: 25%;
            animation-delay: -5s;
        }
        .nebula-4 {
            width: 350px;
            height: 350px;
            background: #10b981;
            bottom: 30%;
            left: 60%;
            animation-delay: -15s;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -20px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }
        
        /* Звёздный фон */
        .stars-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background: rgba(16, 185, 129, 0.9);
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: 0;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.5); }
            50% { opacity: var(--opacity); transform: scale(1); }
        }
        
        /* Анимация перемешивания треков */
        .track-item.shuffling {
            animation: shuffleTrack 0.4s ease-out;
        }
        @keyframes shuffleTrack {
            0% { opacity: 0; transform: translateX(-20px) scale(0.95); }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }
        .tracks-list.shuffling .track-item {
            animation: shuffleTrack 0.3s ease-out backwards;
        }
        .tracks-list.shuffling .track-item:nth-child(1) { animation-delay: 0s; }
        .tracks-list.shuffling .track-item:nth-child(2) { animation-delay: 0.03s; }
        .tracks-list.shuffling .track-item:nth-child(3) { animation-delay: 0.06s; }
        .tracks-list.shuffling .track-item:nth-child(4) { animation-delay: 0.09s; }
        .tracks-list.shuffling .track-item:nth-child(5) { animation-delay: 0.12s; }
        .tracks-list.shuffling .track-item:nth-child(6) { animation-delay: 0.15s; }
        .tracks-list.shuffling .track-item:nth-child(7) { animation-delay: 0.18s; }
        .tracks-list.shuffling .track-item:nth-child(8) { animation-delay: 0.21s; }
        .tracks-list.shuffling .track-item:nth-child(9) { animation-delay: 0.24s; }
        .tracks-list.shuffling .track-item:nth-child(10) { animation-delay: 0.27s; }
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        /* Сайдбар */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
            padding: 0 12px;
            margin-bottom: 32px;
        }
        .logo-icon {
            color: var(--primary);
            font-size: 1.5rem;
            text-shadow: 0 0 20px var(--primary);
        }
        .nav-menu {
            flex: 1;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .nav-item.active {
            background: rgba(16, 185, 129, 0.15);
            color: var(--primary-light);
        }
        .nav-icon { font-size: 1.2rem; }
        
        /* Переключатель темы - как на главной */
        .theme-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            margin-top: 8px;
        }
        .theme-toggle {
            width: 56px;
            height: 30px;
            background: var(--bg-input);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }
        .theme-toggle:hover {
            border-color: var(--primary);
        }
        .toggle-slider {
            position: absolute;
            width: 22px;
            height: 22px;
            top: 2px;
            left: 2px;
            background: #1a1a2e;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        [data-theme="light"] .toggle-slider {
            left: 28px;
            background: #87ceeb;
        }
        .icon-moon {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #f5f5f5;
            transition: all 0.4s;
        }
        .icon-moon::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: #1a1a2e;
            border-radius: 50%;
            top: -2px;
            left: 4px;
        }
        .icon-sun {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fbbf24;
            border-radius: 50%;
            opacity: 0;
            transform: scale(0) rotate(-180deg);
            transition: all 0.4s;
            box-shadow: 
                0 0 0 2px #87ceeb,
                0 -8px 0 -3px #fbbf24,
                0 8px 0 -3px #fbbf24,
                8px 0 0 -3px #fbbf24,
                -8px 0 0 -3px #fbbf24,
                5px -5px 0 -3.5px #fbbf24,
                -5px 5px 0 -3.5px #fbbf24,
                5px 5px 0 -3.5px #fbbf24,
                -5px -5px 0 -3.5px #fbbf24;
        }
        [data-theme="light"] .icon-moon {
            opacity: 0;
            transform: scale(0) rotate(180deg);
        }
        [data-theme="light"] .icon-sun {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        [data-theme="dark"] .icon-sun {
            opacity: 0;
            transform: scale(0) rotate(-180deg);
        }
        [data-theme="dark"] .icon-moon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        .theme-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .theme-toggle-wrapper:hover .theme-label {
            color: var(--text-primary);
        }
        
        .user-section {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            margin-top: auto;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
        }
        .user-info:hover { background: var(--bg-card); }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #ffffff;
        }
        .user-name { font-weight: 600; color: #ffffff; }
        .user-username { font-size: 0.85rem; color: #ffffff; }
        /* Основной контент */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 32px;
            padding-bottom: 120px; /* Отступ для плеера */
        }
        .main-content.player-active {
            padding-bottom: 120px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }
        .page-title { font-size: 1.8rem; font-weight: 700; }
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        .btn:hover { transform: scale(1.02); }
        .btn-primary { 
            background: var(--gradient); 
            color: #000000;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-primary:hover {
            color: #ffffff;
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.6);
        }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover {
            border-color: var(--primary-light);
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-light);
        }
        /* Карточки */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .focus-task-card {
            cursor: pointer;
            transition: all 0.2s;
        }
        .focus-task-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .focus-task-card .task-meta {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .focus-task-card .task-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .focus-task-card .task-meta svg {
            color: var(--primary-light);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .card-title { font-weight: 600; font-size: 1.1rem; }
        .card-actions { display: flex; gap: 8px; }
        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-input);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { color: var(--text-primary); background: var(--border-color); }
        .task-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .status-in_progress { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .status-completed { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .task-meta {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Подзадачи */
        .subtasks-section {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        .subtasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .subtasks-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .subtasks-progress {
            font-size: 0.75rem;
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .subtasks-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .subtask-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .subtask-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .subtask-checkbox:hover {
            border-color: var(--primary);
        }
        .subtask-checkbox.completed {
            background: var(--gradient);
            border-color: transparent;
        }
        .subtask-checkbox.completed::after {
            content: '✓';
            color: white;
            font-size: 11px;
            font-weight: bold;
        }
        .subtask-title {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .subtask-item.completed .subtask-title {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .subtask-delete {
            opacity: 0;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }
        .subtask-item:hover .subtask-delete {
            opacity: 1;
        }
        .subtask-delete:hover {
            color: #ef4444;
        }
        .add-subtask-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            width: 100%;
            margin-top: 8px;
        }
        .add-subtask-btn:hover {
            border-color: var(--primary);
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.05);
        }
        .subtask-input-wrapper {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .subtask-input {
            flex: 1;
            min-width: 0;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .subtask-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .subtask-input-wrapper .btn {
            padding: 8px 12px;
            flex-shrink: 0;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .subtask-input-wrapper .btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Напоминания о здоровье */
        .health-reminder-modal {
            text-align: center;
            padding: 20px;
        }
        .health-reminder-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .health-reminder-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .health-reminder-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }
        .health-reminder-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        /* Упражнения для глаз */
        .eye-exercise-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .eye-exercise-visual {
            width: 200px;
            height: 200px;
            position: relative;
            margin-bottom: 24px;
        }
        .eye-dot {
            width: 24px;
            height: 24px;
            background: var(--gradient);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        .eye-dot.moving {
            animation: eyeMove 4s ease-in-out infinite;
        }
        @keyframes eyeMove {
            0%, 100% { top: 50%; left: 50%; }
            12.5% { top: 10%; left: 50%; }
            25% { top: 10%; left: 90%; }
            37.5% { top: 50%; left: 90%; }
            50% { top: 90%; left: 90%; }
            62.5% { top: 90%; left: 50%; }
            75% { top: 90%; left: 10%; }
            87.5% { top: 50%; left: 10%; }
        }
        .eye-exercise-track {
            width: 100%;
            height: 100%;
            border: 2px dashed var(--border-color);
            border-radius: 50%;
            position: absolute;
        }
        .eye-exercise-timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 12px;
        }
        .eye-exercise-instruction {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* Модальное окно */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #0f0f23;
            border-radius: 20px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-title { font-size: 1.3rem; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        /* ========== РЕЖИМ ФОКУСИРОВКИ ========== */
        .focus-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .focus-layout { grid-template-columns: 1fr; }
        }
        
        /* Дерево концентрации */
        .focus-tree-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .tree-container { margin-bottom: 20px; }
        .tree-visual {
            width: 220px;
            height: 260px;
            margin: 0 auto 16px;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .tree-visual svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.3));
        }
        .tree-branch {
            transition: all 0.8s ease;
            transform-origin: bottom center;
        }
        .tree-leaf {
            transition: all 0.5s ease;
        }
        .tree-visual.growing .tree-branch {
            animation: branchGrow 1s ease-out;
        }
        .tree-visual.growing .tree-leaf {
            animation: leafAppear 0.8s ease-out 0.3s backwards;
        }
        @keyframes branchGrow {
            0% { transform: scaleY(0); opacity: 0; }
            100% { transform: scaleY(1); opacity: 1; }
        }
        @keyframes leafAppear {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .tree-visual.wilting .tree-leaf {
            animation: leafWilt 2s ease-in-out infinite;
        }
        @keyframes leafWilt {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        @keyframes leafFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            25% { transform: translateY(20px) rotate(45deg); }
            50% { transform: translateY(40px) rotate(-30deg); opacity: 0.4; }
            75% { transform: translateY(60px) rotate(60deg); }
            100% { transform: translateY(80px) rotate(0deg); opacity: 0; }
        }
        .falling-leaf {
            animation: leafFall 3s ease-in-out infinite;
        }
        .tree-ground {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 20px;
            background: radial-gradient(ellipse at center, rgba(139, 92, 246, 0.3) 0%, transparent 70%);
            border-radius: 50%;
        }
        .tree-health-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
        }
        .tree-health-bar::before {
            content: 'Здоровье';
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .tree-health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 40%, #22c55e 100%);
            transition: width 0.5s ease;
            border-radius: 5px;
            position: relative;
        }
        .tree-health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
            border-radius: 5px 5px 0 0;
        }
        .tree-info { 
            margin-top: 16px;
            padding: 16px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 16px;
        }
        .tree-level {
            font-size: 1.3rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tree-level::before {
            content: '';
            -webkit-text-fill-color: initial;
        }
        .tree-level span {
            font-size: 1.5rem;
        }
        .tree-exp { 
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        .exp-bar {
            flex: 1;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .exp-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
        }
        .exp-fill {
            height: 100%;
            background: var(--gradient);
            transition: width 0.5s ease;
            position: relative;
            border-radius: 5px;
        }
        .exp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
            border-radius: 5px 5px 0 0;
        }
        #expText {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-light);
            white-space: nowrap;
        }
        .tree-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .stat-item {
            text-align: center;
            padding: 12px 8px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 12px;
            transition: all 0.2s;
        }
        .stat-item:hover {
            background: rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }
        .stat-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%);
            border-radius: 10px;
            color: var(--primary-light);
        }
        .stat-icon svg {
            width: 18px;
            height: 18px;
        }
        .stat-value {
            display: block;
            font-size: 1.4rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2px;
        }
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Таймер панель */
        .focus-timer-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .focus-mode-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .focus-tab {
            padding: 8px 20px;
            border-radius: 20px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .focus-tab:hover { border-color: var(--primary); }
        .focus-tab.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }
        .timer-display {
            font-size: 5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 16px 0;
            font-variant-numeric: tabular-nums;
        }
        .timer-session-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }
        .timer-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .focus-task-name {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        /* Ambient звуки */
        .ambient-sounds {
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .ambient-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .ambient-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 12px;
        }
        .ambient-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .ambient-btn svg {
            width: 22px;
            height: 22px;
        }
        .ambient-btn:hover { 
            border-color: var(--primary); 
            transform: scale(1.05);
            color: var(--primary-light);
        }
        .ambient-btn.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .ambient-volume {
            width: 150px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
        }
        .ambient-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
        }
        
        /* Пресеты фокуса в модалке задачи */
        .focus-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .preset-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .preset-btn svg {
            width: 24px;
            height: 24px;
        }
        .preset-btn span {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .preset-btn small {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        .preset-btn:hover {
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .preset-btn.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .preset-btn.active span { color: var(--primary-light); }
        
        .custom-focus-settings {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .settings-row {
            display: flex;
            gap: 12px;
        }
        .settings-row .form-group { margin-bottom: 0; }
        
        .ambient-select {
            display: flex;
            gap: 8px;
        }
        .ambient-select-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .ambient-select-btn svg {
            width: 20px;
            height: 20px;
        }
        .ambient-select-btn:hover {
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .ambient-select-btn.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary-light);
        }
        
        /* Статистика */
        .focus-stats-panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .focus-stats-panel h3 { margin-bottom: 16px; }
        
        /* Табы статистики */
        .stats-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .stats-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .stats-tab:hover { border-color: var(--primary); }
        .stats-tab.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }
        
        /* Сводка статистики */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-light);
        }
        .summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Журнал настроения */
        .mood-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .mood-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .mood-today {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .mood-emoji-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .mood-emoji-btn svg {
            transition: all 0.2s;
        }
        .mood-emoji-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .mood-emoji-btn.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.2);
            transform: scale(1.15);
            color: var(--primary-light);
        }
        .mood-emoji-btn[data-mood="1"] { color: #ef4444; }
        .mood-emoji-btn[data-mood="2"] { color: #f97316; }
        .mood-emoji-btn[data-mood="3"] { color: #eab308; }
        .mood-emoji-btn[data-mood="4"] { color: #22c55e; }
        .mood-emoji-btn[data-mood="5"] { color: #10b981; }
        .mood-emoji-btn[data-mood="1"]:hover, .mood-emoji-btn[data-mood="1"].selected { border-color: #ef4444; background: rgba(239, 68, 68, 0.15); }
        .mood-emoji-btn[data-mood="2"]:hover, .mood-emoji-btn[data-mood="2"].selected { border-color: #f97316; background: rgba(249, 115, 22, 0.15); }
        .mood-emoji-btn[data-mood="3"]:hover, .mood-emoji-btn[data-mood="3"].selected { border-color: #eab308; background: rgba(234, 179, 8, 0.15); }
        .mood-emoji-btn[data-mood="4"]:hover, .mood-emoji-btn[data-mood="4"].selected { border-color: #22c55e; background: rgba(34, 197, 94, 0.15); }
        .mood-emoji-btn[data-mood="5"]:hover, .mood-emoji-btn[data-mood="5"].selected { border-color: #10b981; background: rgba(16, 185, 129, 0.15); }
        .mood-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 80px;
            margin-top: 16px;
        }
        .mood-bar {
            flex: 1;
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .mood-bar:hover { filter: brightness(1.2); }
        .mood-1 { background: #ef4444; }
        .mood-2 { background: #f97316; }
        .mood-3 { background: #eab308; }
        .mood-4 { background: #84cc16; }
        .mood-5 { background: #22c55e; }
        
        /* Шаблоны задач */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .template-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .template-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-radius: 12px;
            color: var(--primary-light);
        }
        .template-icon svg {
            width: 28px;
            height: 28px;
        }
        /* Сетка иконок в модалке */
        .template-icons-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        .template-icon-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .template-icon-btn:hover {
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .template-icon-btn.selected {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary-light);
        }
        .template-icon-btn svg {
            width: 24px;
            height: 24px;
        }
        .template-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .template-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .template-meta {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .template-meta svg {
            color: var(--primary-light);
        }
        .template-delete {
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .template-delete:hover {
            opacity: 1;
            color: #ef4444;
        }
        .stats-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            gap: 10px;
            padding: 10px 0 25px;
        }
        .chart-bar {
            flex: 1;
            background: rgba(99, 102, 241, 0.3);
            border-radius: 6px 6px 0 0;
            min-height: 4px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .chart-bar.has-data {
            background: var(--gradient);
        }
        .chart-bar.today {
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        .chart-bar.today::after {
            color: var(--primary-light);
            font-weight: 600;
        }
        .chart-bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .chart-bar:hover {
            transform: scaleY(1.05);
            filter: brightness(1.1);
        }
        .chart-bar:hover::before {
            content: attr(data-value);
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            background: #0f0f23;
            padding: 4px 10px;
            border-radius: 6px;
            white-space: nowrap;
            border: 1px solid var(--border-color);
            z-index: 10;
        }
        
        /* Полноэкранный режим фокуса */
        .focus-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-main);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        .focus-fullscreen .timer-display {
            font-size: 10rem;
        }
        .focus-fullscreen .tree-visual {
            width: 300px;
            height: 340px;
        }
        .focus-fullscreen .tree-ground {
            width: 160px;
            height: 30px;
        }
        /* Секции */
        .section { display: none; }
        .section.active { display: block; }
        /* Пустое состояние */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-icon { font-size: 3rem; margin-bottom: 16px; }
        
        /* Плеер - фиксированный внизу с эффектом стекла */
        .player-panel {
            position: fixed;
            bottom: 0;
            left: 260px;
            right: 0;
            background: rgba(5, 15, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(16, 185, 129, 0.3);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 24px;
            z-index: 100;
            box-shadow: 0 -4px 30px rgba(16, 185, 129, 0.15);
        }
        .player-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.5), transparent);
        }
        .player-info { flex: 1; min-width: 0; }
        .player-track-name {
            font-weight: 600;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-artist {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .player-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .player-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-light);
        }
        .player-btn:hover { 
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--primary);
            transform: scale(1.08);
        }
        .player-btn:active {
            transform: scale(0.95);
        }
        .player-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        .player-btn-main {
            width: 64px;
            height: 64px;
            background: var(--gradient);
            border: none;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            color: white;
        }
        .player-btn-main:hover { 
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(16, 185, 129, 0.5);
        }
        .player-btn-main svg {
            width: 26px;
            height: 26px;
        }
        .player-progress {
            flex: 1;
            max-width: 400px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            transition: height 0.2s;
        }
        .player-progress:hover {
            height: 8px;
        }
        .progress-bar-player {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 0.1s linear;
        }
        .player-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 90px;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }
        
        /* Дополнительные контролы плеера */
        .player-extra {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .player-btn-small {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        .player-btn-small:hover {
            color: var(--text-primary);
            background: rgba(16, 185, 129, 0.1);
        }
        .player-btn-small.active {
            color: var(--primary-light);
            background: rgba(16, 185, 129, 0.2);
        }
        
        /* Громкость */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            border: none;
        }
        
        /* Меню настроек плеера */
        .player-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 12px;
            background: #0f0f23;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }
        .player-menu.show { display: block; }
        .player-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            transition: background 0.2s;
            color: var(--text-primary);
        }
        .player-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .player-menu-item.active {
            color: var(--primary-light);
        }
        .player-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }
        .player-menu-header {
            padding: 8px 16px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Эквалайзер */
        .eq-container {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            align-items: flex-end;
            height: 80px;
        }
        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .eq-slider {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            width: 20px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .eq-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        
        /* Модальное окно информации о треке */
        .track-info-modal {
            max-width: 400px;
        }
        .track-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .track-info-row:last-child { border-bottom: none; }
        .track-info-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .track-info-value {
            font-weight: 500;
            text-align: right;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Список треков */
        .tracks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .track-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .track-item:hover {
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
        }
        .track-item.playing {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .track-number {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .track-item.playing .track-number {
            background: var(--gradient);
            color: white;
        }
        .track-info { flex: 1; min-width: 0; }
        .track-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-artist {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .track-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .track-item:hover .track-actions { opacity: 1; }
        
        /* Облако - секция */
        .cloud-status-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .cloud-status-icon {
            color: var(--text-secondary);
            opacity: 0.5;
        }
        .cloud-status-card.connected .cloud-status-icon {
            color: #22c55e;
            opacity: 1;
        }
        .cloud-status-info h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
        }
        .cloud-status-info p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .cloud-storage-bar {
            width: 300px;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            margin: 16px auto 8px;
            overflow: hidden;
        }
        .cloud-storage-used {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            border-radius: 4px;
            transition: width 0.3s;
        }
        .cloud-storage-text {
            font-size: 0.85rem !important;
            color: var(--text-secondary) !important;
        }
        .btn-lg {
            padding: 14px 28px;
            font-size: 1rem;
        }
        .cloud-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--bg-input);
            border-radius: 12px;
            width: fit-content;
        }
        .cloud-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .cloud-tab:hover {
            color: var(--text-primary);
        }
        .cloud-tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .cloud-files-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .cloud-file-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s;
        }
        .cloud-file-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        .cloud-file-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        .cloud-file-info {
            flex: 1;
            min-width: 0;
        }
        .cloud-file-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cloud-file-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .cloud-file-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Табы источника трека */
        .track-source-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .track-source-tab:hover {
            color: var(--text-primary);
        }
        .track-source-tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .track-source-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Выбор файлов из облака */
        .cloud-file-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cloud-file-select-item:hover {
            border-color: var(--primary);
        }
        .cloud-file-select-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .cloud-file-select-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }
        
        /* Иконки типов файлов */
        .cloud-file-icon.music { background: linear-gradient(135deg, #ec4899, #8b5cf6); }
        .cloud-file-icon.image { background: linear-gradient(135deg, #10b981, #14b8a6); }
        .cloud-file-icon.document { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .cloud-file-icon.video { background: linear-gradient(135deg, #ef4444, #ec4899); }
        .cloud-file-icon.archive { background: linear-gradient(135deg, #10b981, #14b8a6); }
        .cloud-file-icon.other { background: linear-gradient(135deg, #6b7280, #9ca3af); }
        
        /* Превью изображения */
        .cloud-file-thumb {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        /* Просмотр изображения */
        .image-preview-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .image-preview-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }
        .image-preview-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .image-preview-close:hover { opacity: 1; }
        #imagePreviewImg {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .image-preview-info {
            text-align: center;
            color: white;
            margin-top: 16px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Кнопки выбора типа загрузки */
        .cloud-upload-type {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .cloud-upload-type:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }
        .cloud-upload-type.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Яндекс.Диск баннер */
        .yandex-disk-banner {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.1) 0%, rgba(255, 170, 0, 0.1) 100%);
            border: 1px solid rgba(255, 204, 0, 0.3);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .yandex-disk-banner.connected {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border-color: rgba(34, 197, 94, 0.3);
        }
        .yandex-disk-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .yandex-disk-info svg {
            color: #ffcc00;
            flex-shrink: 0;
        }
        .yandex-disk-banner.connected .yandex-disk-info svg {
            color: #22c55e;
        }
        .yandex-disk-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .yandex-disk-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .btn-yandex {
            background: linear-gradient(135deg, #ffcc00 0%, #ffaa00 100%);
            color: #000;
            border: none;
            font-weight: 600;
        }
        .btn-yandex:hover {
            background: linear-gradient(135deg, #ffdd33 0%, #ffbb33 100%);
            transform: translateY(-1px);
        }
        .btn-yandex-disconnect {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        .btn-yandex-disconnect:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Карточка плейлиста */
        .playlist-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .playlist-card:hover {
            transform: translateY(-4px);
            border-color: var(--border-hover);
        }
        .playlist-cover {
            width: 100%;
            height: 120px;
            background: var(--gradient);
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        .playlist-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        .playlist-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Загрузка файлов */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            transition: all 0.3s;
        }
        .file-upload.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .file-upload-content {
            padding: 32px;
            text-align: center;
            cursor: pointer;
        }
        .file-upload-content:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        .file-upload-text {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .file-upload-hint {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .file-selected {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
        }
        .file-name {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px 8px;
        }
        .file-remove:hover {
            color: #ef4444;
        }
        .upload-progress {
            margin: 16px 0;
            background: var(--bg-input);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-upload {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            position: absolute;
            right: 8px;
            top: -20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Время трека */
        .track-duration {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 45px;
            text-align: right;
        }
        
        /* Прогресс плеера кликабельный */
        .player-progress {
            cursor: pointer;
        }
        .player-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 80px;
            text-align: center;
        }
        
        /* ========== ЧАТЫ (Telegram-style) ========== */
        .chat-container {
            display: flex;
            height: calc(100vh - 190px);
            background: transparent;
            border-radius: 0;
            border: none;
            overflow: hidden;
        }
        
        /* Список чатов - левая панель */
        .chat-sidebar {
            width: 350px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: var(--bg-sidebar);
        }
        .chat-sidebar-header {
            padding: 10px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chat-search {
            flex: 1;
            padding: 8px 14px;
            background: var(--bg-input);
            border: none;
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .chat-search:focus {
            outline: none;
            background: rgba(99, 102, 241, 0.1);
        }
        .chat-search::placeholder {
            color: var(--text-secondary);
        }
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        .chat-item:hover {
            background: rgba(99, 102, 241, 0.08);
        }
        .chat-item.active {
            background: rgba(99, 102, 241, 0.15);
        }
        .chat-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            border-radius: 0 2px 2px 0;
        }
        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .chat-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .chat-item-info {
            flex: 1;
            min-width: 0;
        }
        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
        }
        .chat-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-item-time {
            font-size: 0.72rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-left: 8px;
        }
        .chat-item.active .chat-item-time,
        .chat-item.unread .chat-item-time {
            color: var(--primary-light);
        }
        .chat-item-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .chat-item-preview-sender {
            color: var(--primary-light);
            font-weight: 500;
        }
        .chat-unread {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 7px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            margin-left: auto;
        }
        
        /* Область сообщений - центральная панель */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
            position: relative;
        }
        .chat-header {
            padding: 10px 16px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 60px;
        }
        .chat-header .chat-avatar {
            width: 42px;
            height: 42px;
            font-size: 1rem;
            cursor: pointer;
        }
        .chat-header-info {
            flex: 1;
            cursor: pointer;
        }
        .chat-header-name {
            font-weight: 600;
            font-size: 1rem;
        }
        .chat-header-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .chat-header-status.online {
            color: #22c55e;
        }
        .chat-header-actions {
            display: flex;
            gap: 4px;
        }
        .chat-header-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .chat-header-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px 60px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: linear-gradient(180deg, var(--bg-main) 0%, rgba(99, 102, 241, 0.02) 100%);
        }
        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--text-secondary);
        }
        .chat-empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        /* Сообщения в стиле Telegram */
        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 18px;
            position: relative;
            animation: messageIn 0.2s ease;
            margin: 1px 0;
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(8px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message-incoming {
            align-self: flex-start;
            background: var(--bg-card);
            border-radius: 18px 18px 18px 4px;
        }
        .message-outgoing {
            align-self: flex-end;
            background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .message-content {
            word-wrap: break-word;
            line-height: 1.45;
            font-size: 0.95rem;
        }
        .message-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 2px;
        }
        .message-time {
            font-size: 0.68rem;
            opacity: 0.6;
        }
        .message-status {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        .message-status.read {
            color: #34d399;
        }
        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 2px;
        }
        .message-edited {
            font-size: 0.65rem;
            opacity: 0.5;
            font-style: italic;
        }
        
        /* Группировка сообщений */
        .message-group-start { margin-top: 8px; }
        .message-group-end { margin-bottom: 8px; }
        
        /* Дата разделитель */
        .message-date {
            text-align: center;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        .message-date span {
            background: rgba(99, 102, 241, 0.15);
            padding: 5px 14px;
            border-radius: 16px;
            font-weight: 500;
        }
        
        /* Ответ на сообщение в пузыре */
        .message-reply {
            background: rgba(0, 0, 0, 0.1);
            border-left: 2px solid var(--primary-light);
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .message-reply-name {
            font-weight: 600;
            color: var(--primary-light);
            font-size: 0.75rem;
        }
        .message-reply-text {
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Ввод сообщения - Telegram style */
        .chat-input-area {
            padding: 8px 60px 12px;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .chat-input-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-end;
            background: var(--bg-input);
            border-radius: 22px;
            padding: 4px 4px 4px 16px;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .chat-input-wrapper:focus-within {
            border-color: var(--primary);
        }
        .chat-input {
            flex: 1;
            padding: 8px 0;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
        }
        .chat-input:focus {
            outline: none;
        }
        .chat-input::placeholder {
            color: var(--text-secondary);
        }
        .chat-attach-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .chat-attach-btn:hover {
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
        }
        .chat-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--gradient);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .chat-send-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
            margin-left: 2px;
        }
        
        /* Emoji и стикеры */
        .emoji-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .emoji-btn:hover {
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
        }
        .emoji-btn svg {
            width: 22px;
            height: 22px;
        }
        .emoji-picker-container {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
            width: 340px;
            max-height: 400px;
            overflow: hidden;
        }
        .emoji-picker-container.show {
            display: block;
            animation: fadeInUp 0.2s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .emoji-picker-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            padding: 8px;
            gap: 4px;
        }
        .emoji-picker-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .emoji-picker-tab:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .emoji-picker-tab.active {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
        }
        .emoji-picker-content {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .emoji-category {
            margin-bottom: 16px;
        }
        .emoji-category-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }
        .emoji-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
            border: none;
            background: transparent;
        }
        .emoji-item:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: scale(1.15);
        }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .sticker-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.15);
            padding: 10px;
            min-height: 72px;
            position: relative;
            overflow: hidden;
        }
        .sticker-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .sticker-item:hover {
            border-color: var(--primary);
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.35), 0 0 0 1px rgba(99, 102, 241, 0.2);
        }
        .sticker-item:hover::before {
            opacity: 0.15;
        }
        .sticker-item:active {
            transform: scale(0.95);
        }
        .sticker-item svg {
            width: 48px;
            height: 48px;
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .sticker-item .sticker-emoji {
            font-size: 2.5rem;
            position: relative;
            z-index: 1;
        }
        .sticker-message {
            font-size: 4rem;
            line-height: 1;
            padding: 8px;
        }
        .sticker-message svg {
            width: 80px;
            height: 80px;
        }
        .message.sticker-msg {
            background: transparent !important;
            box-shadow: none !important;
            padding: 4px 8px;
        }
        .message.sticker-msg .sticker-message {
            font-size: 4rem;
            line-height: 1.2;
        }
        .message.sticker-msg .sticker-message svg {
            width: 100px;
            height: 100px;
            filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.4));
        }
        /* Анимация для кастомных стикеров */
        @keyframes stickerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .sticker-item:hover svg {
            animation: stickerPulse 0.6s ease-in-out;
        }
        .emoji-search {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 12px;
        }
        .emoji-search:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Выбор типа чата */
        .chat-type-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .chat-type-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }
        .chat-type-btn.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary-light);
        }
        .chat-type-btn span {
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Выбранные участники */
        .selected-member-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            font-size: 0.85rem;
            color: var(--primary-light);
        }
        .selected-member-chip .remove-chip {
            cursor: pointer;
            opacity: 0.7;
        }
        .selected-member-chip .remove-chip:hover {
            opacity: 1;
        }
        
        /* Вкладки настроек */
        .settings-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .settings-tab:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .settings-tab.active {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
        }
        
        /* Элемент участника в настройках */
        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            transition: background 0.2s;
        }
        .member-item:hover {
            background: var(--bg-input);
        }
        .member-item .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .member-item .member-info {
            flex: 1;
        }
        .member-item .member-name {
            font-weight: 500;
        }
        .member-item .member-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .member-item .member-actions {
            display: flex;
            gap: 8px;
        }
        .role-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .role-badge.owner {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }
        .role-badge.admin {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary-light);
        }
        
        /* Редактирование аватара чата */
        .chat-avatar-edit {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            background: var(--bg-input);
            border: 2px dashed var(--border-color);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .chat-avatar-edit:hover {
            border-color: var(--primary);
        }
        .chat-avatar-preview {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        .chat-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-edit-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .chat-avatar-edit:hover .avatar-edit-overlay {
            opacity: 1;
        }
        .avatar-edit-overlay svg {
            color: white;
        }
        
        /* Новый чат кнопка */
        .new-chat-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--gradient);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .new-chat-btn:hover {
            transform: scale(1.05);
        }
        
        /* Результаты поиска пользователей */
        .user-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f0f23;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .user-search-results.show {
            display: block;
        }
        .user-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-result-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .user-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .user-result-info {
            flex: 1;
        }
        .user-result-name {
            font-weight: 600;
        }
        .user-result-username {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Навигация в чате с бейджем */
        .nav-badge {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }
        
        /* Меню действий чата (три точки) */
        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .chat-action-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
        }
        .chat-action-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .chat-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #0f0f23;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 220px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }
        .chat-menu.show { display: block; }
        .chat-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            transition: background 0.2s;
            color: var(--text-primary);
        }
        .chat-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .chat-menu-item.danger { color: #ef4444; }
        .chat-menu-item svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }
        .chat-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }
        
        /* Поиск по чату */
        .chat-search-panel {
            padding: 12px 24px;
            background: #0f0f23;
            border-bottom: 1px solid var(--border-color);
            display: none;
        }
        .chat-search-panel.show { display: block; }
        .chat-search-input {
            width: 100%;
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .chat-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        
        /* Профиль пользователя в чате */
        .profile-panel {
            width: 260px;
            flex-shrink: 0;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border-color);
            padding: 20px 14px;
            display: none;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .profile-panel.show { display: flex; }
        #profileContent {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .profile-name-large {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 2px;
            text-align: center;
            word-break: break-word;
            width: 100%;
        }
        .profile-username-large {
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-size: 0.85rem;
            text-align: center;
        }
        .profile-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
            flex-shrink: 0;
        }
        .status-dot.online { background: #22c55e; }
        .profile-bio {
            color: var(--text-secondary);
            text-align: center;
            font-size: 0.8rem;
            margin-bottom: 10px;
            line-height: 1.4;
            word-break: break-word;
            width: 100%;
            padding: 0 4px;
        }
        .profile-info-item {
            width: 100%;
            padding: 8px 0;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }
        .profile-info-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        .profile-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        /* Секция информации в профиле группы */
        .profile-info-section {
            width: 100%;
            margin-top: 12px;
        }
        .profile-section-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .profile-members-section {
            width: 100%;
        }
        .profile-members-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .profile-member-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .profile-member-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .member-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        .member-avatar-small img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Закреплённый плейлист в профиле */
        .profile-pinned-playlist {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .profile-pinned-playlist:hover {
            background: rgba(99, 102, 241, 0.15);
        }
        .pinned-playlist-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 6px;
        }
        .pinned-playlist-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .pinned-playlist-name {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pinned-playlist-track {
            font-size: 0.7rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .pinned-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .pinned-play-btn:hover {
            transform: scale(1.1);
        }
        
        /* Ответ на сообщение */
        .reply-preview {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--primary);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .reply-preview-content {
            flex: 1;
            min-width: 0;
        }
        .reply-preview-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-light);
        }
        .reply-preview-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reply-cancel {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 1rem;
        }
        .reply-cancel:hover { color: var(--text-primary); }
        
        /* Ответ в сообщении */
        .message-reply {
            background: rgba(0, 0, 0, 0.2);
            border-left: 2px solid var(--primary-light);
            padding: 4px 8px;
            margin-bottom: 6px;
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
        }
        .message-reply-name {
            font-weight: 600;
            color: var(--primary-light);
        }
        .message-reply-text {
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-incoming .message-reply {
            background: rgba(99, 102, 241, 0.1);
        }
        .message-reply:hover {
            background: rgba(99, 102, 241, 0.2) !important;
        }
        
        /* Подсветка сообщения */
        .message-highlight-bar {
            position: absolute;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(180deg, 
                rgba(99, 102, 241, 0) 0%,
                rgba(99, 102, 241, 0.25) 50%,
                rgba(99, 102, 241, 0) 100%);
            pointer-events: none;
            z-index: 10;
            animation: highlightBarPulse 2s ease-out forwards;
        }
        @keyframes highlightBarPulse {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        .message-highlight {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.6);
            animation: messagePulse 2s ease-out;
        }
        @keyframes messagePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
            20%, 80% { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.6); }
        }
        
        /* Редактирование сообщения */
        .message-edited {
            font-size: 0.65rem;
            opacity: 0.6;
            margin-left: 4px;
        }
        
        /* Контекстное меню сообщения */
        .message-context-menu {
            position: absolute;
            background: #0f0f23;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 150px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .message-context-menu.show { display: block; }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        .context-menu-item.danger { color: #ef4444; }
        
        /* Статус печатает */
        .typing-indicator {
            font-size: 0.85rem;
            color: var(--primary-light);
            font-style: italic;
        }
        .typing-dots {
            display: inline-flex;
            gap: 2px;
        }
        .typing-dots span {
            width: 4px;
            height: 4px;
            background: var(--primary-light);
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingDot {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-2px); }
        }
        
        /* Кликабельный заголовок чата */
        .chat-header-clickable {
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .chat-header-clickable:hover .chat-header-name {
            color: var(--primary-light);
        }
        
        /* Кастомные уведомления */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #0f0f23;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .toast.toast-out {
            animation: toastOut 0.3s ease forwards;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        .toast-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .toast-content {
            flex: 1;
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            word-break: break-word;
        }
        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            line-height: 1;
        }
        .toast-close:hover { color: var(--text-primary); }
        .toast.success { border-left: 4px solid #22c55e; }
        .toast.success .toast-icon { color: #22c55e; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.error .toast-icon { color: #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        .toast.warning .toast-icon { color: #f59e0b; }
        .toast.info { border-left: 4px solid var(--primary); }
        .toast.info .toast-icon { color: var(--primary); }
        
        /* Кастомный диалог подтверждения */
        .confirm-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .confirm-dialog {
            background: #0f0f23;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            min-width: 320px;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: scaleIn 0.2s ease;
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .confirm-icon {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 16px;
        }
        .confirm-title {
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }
        .confirm-message {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        .confirm-buttons {
            display: flex;
            gap: 12px;
        }
        .confirm-buttons .btn {
            flex: 1;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Список выбранных файлов - прокручиваемый */
        .files-selected {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 10px;
        }
        .files-selected-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .files-selected-header:hover {
            background: rgba(99, 102, 241, 0.15);
        }
        .files-selected-count {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .files-selected-toggle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .files-selected-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .files-selected-list.collapsed {
            display: none;
        }
        .file-item-small {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        .file-item-small .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px;
        }
        
        /* ========== ФАЗА 3: ГЕЙМИФИКАЦИЯ ========== */
        .achievements-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .achievements-progress {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .achievements-progress span {
            color: var(--primary-light);
            font-weight: 600;
        }
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .achievement-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }
        .achievement-card.unlocked {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .achievement-card.unlocked::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient);
        }
        .achievement-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-icon svg {
            width: 100%;
            height: 100%;
            color: var(--text-secondary);
            transition: all 0.3s;
        }
        .achievement-card.unlocked .achievement-icon svg {
            color: var(--primary-light);
            filter: drop-shadow(0 0 6px rgba(99, 102, 241, 0.5));
        }
        .achievement-name {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .achievement-desc {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .achievement-new {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--gradient);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        /* Уведомление о достижении */
        .achievement-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 32px 48px;
            text-align: center;
            z-index: 10002;
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.5);
            animation: achievementPop 0.5s ease forwards;
        }
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .achievement-toast-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            animation: bounce 0.6s ease infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .achievement-toast-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .achievement-toast-name {
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        /* ========== ЖУРНАЛ БЛАГОДАРНОСТИ ========== */
        .gratitude-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .gratitude-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .gratitude-input-wrapper {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .gratitude-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .gratitude-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .gratitude-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .gratitude-cat-btn {
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .gratitude-cat-btn svg {
            flex-shrink: 0;
        }
        .gratitude-cat-btn:hover, .gratitude-cat-btn.active {
            border-color: var(--primary);
            color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
        }
        .gratitude-item-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-light);
        }
        .gratitude-item-icon svg {
            width: 20px;
            height: 20px;
        }
        .gratitude-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .gratitude-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .gratitude-item-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        .gratitude-item-content {
            flex: 1;
        }
        .gratitude-item-text {
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .gratitude-item-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .gratitude-item-delete {
            opacity: 0;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .gratitude-item:hover .gratitude-item-delete {
            opacity: 1;
        }
        .gratitude-item-delete:hover {
            color: #ef4444;
        }
        
        /* ========== ПРОГРЕСС ЗАДАЧ ========== */
        .tasks-progress-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        .progress-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .progress-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-light);
        }
        .progress-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .progress-donut {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            position: relative;
        }
        .progress-donut svg {
            transform: rotate(-90deg);
        }
        .progress-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .progress-donut-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-light);
        }
        .progress-donut-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .progress-weekly-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 100px;
            gap: 8px;
            padding-top: 10px;
        }
        .progress-bar-day {
            flex: 1;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            position: relative;
            transition: all 0.3s;
        }
        .progress-bar-day.has-data {
            background: var(--gradient);
        }
        .progress-bar-day::after {
            content: attr(data-day);
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        /* ========== ИГРА НА ПАМЯТЬ ========== */
        .memory-game-panel {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .memory-game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .memory-game-stats {
            display: flex;
            gap: 20px;
        }
        .memory-stat {
            text-align: center;
        }
        .memory-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-light);
        }
        .memory-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .memory-game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .sequence-display {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            min-height: 60px;
            align-items: center;
        }
        .sequence-item {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }
        .sequence-item.highlight {
            background: var(--gradient);
            border-color: transparent;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        .sequence-item.correct {
            background: #22c55e;
            border-color: transparent;
        }
        .sequence-item.wrong {
            background: #ef4444;
            border-color: transparent;
        }
        .memory-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-width: 300px;
        }
        .memory-btn {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .memory-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .memory-btn:active {
            transform: scale(0.95);
        }
        .memory-btn.flash {
            background: var(--gradient);
            border-color: transparent;
        }
        .memory-game-message {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 16px 0;
            color: var(--primary-light);
        }
        .memory-start-btn {
            padding: 12px 32px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <!-- Фон с nebula эффектами - как на главной -->
    <div class="bg-container">
        <div class="nebula nebula-1"></div>
        <div class="nebula nebula-2"></div>
        <div class="nebula nebula-3"></div>
        <div class="nebula nebula-4"></div>
        <div class="stars-bg" id="starsBg"></div>
    </div>
    
    <div class="app-layout">
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">✦</span>
                <span>FocusFlow</span>
            </div>
            
            <nav class="nav-menu">
                <a class="nav-item active" data-section="tasks">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></span>
                    <span>Задачи</span>
                </a>
                <a class="nav-item" data-section="focus">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
                    <span>Фокус</span>
                </a>
                <a class="nav-item" data-section="playlists">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></span>
                    <span>Плейлисты</span>
                </a>
                <a class="nav-item" data-section="notes">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span>
                    <span>Заметки</span>
                </a>
                <a class="nav-item" data-section="chats">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
                    <span>Чаты</span>
                </a>
                <a class="nav-item" data-section="progress">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg></span>
                    <span>Прогресс</span>
                </a>
                <a class="nav-item" data-section="cloud">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></span>
                    <span>Облако</span>
                </a>
            </nav>
            
            <div class="user-section">
                <!-- Переключатель темы - как на главной -->
                <div class="theme-toggle-wrapper">
                    <div class="theme-toggle" onclick="toggleTheme()" title="Сменить тему">
                        <div class="toggle-slider">
                            <div class="icon-moon"></div>
                            <div class="icon-sun"></div>
                        </div>
                    </div>
                    <span class="theme-label" id="themeLabel">Тёмная тема</span>
                </div>
                
                <a href="/profile" class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div>
                        <div class="user-name" id="userName">Загрузка...</div>
                        <div class="user-username" id="userUsername">@...</div>
                    </div>
                </a>
                <a class="nav-item" onclick="logout()">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></span>
                    <span>Выйти</span>
                </a>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Задачи -->
            <section class="section active" id="tasks-section">
                <div class="page-header">
                    <h1 class="page-title">Мои задачи</h1>
                    <button class="btn btn-primary" onclick="openTaskModal()">+ Новая задача</button>
                </div>
                <div class="cards-grid" id="tasksList"></div>
            </section>
            
            <!-- Фокус -->
            <section class="section" id="focus-section">
                <div class="page-header">
                    <h1 class="page-title">Режим фокуса</h1>
                    <button class="btn btn-outline" onclick="openFocusSettings()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> Настройки</button>
                </div>
                
                <div class="focus-layout">
                    <!-- Дерево концентрации -->
                    <div class="focus-tree-panel">
                        <div class="tree-container" id="treeContainer">
                            <div class="tree-visual" id="treeVisual"></div>
                            <div style="margin-top: 24px;">
                                <div class="tree-health-bar">
                                    <div class="tree-health-fill" id="treeHealthFill"></div>
                                </div>
                            </div>
                            <div class="tree-info">
                                <div class="tree-level">Уровень <span id="treeLevel">1</span></div>
                                <div class="tree-exp">
                                    <div class="exp-bar">
                                        <div class="exp-fill" id="expFill"></div>
                                    </div>
                                    <span id="expText">0/100 XP</span>
                                </div>
                            </div>
                        </div>
                        <div class="tree-stats">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                                </div>
                                <span class="stat-value" id="statStreak">0</span>
                                <span class="stat-label">дней подряд</span>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                </div>
                                <span class="stat-value" id="statTotalMinutes">0</span>
                                <span class="stat-label">минут</span>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                </div>
                                <span class="stat-value" id="statTotalSessions">0</span>
                                <span class="stat-label">сессий</span>
                            </div>
                        </div>
                        

                    </div>
                    
                    <!-- Таймер и управление -->
                    <div class="focus-timer-panel">
                        <div class="focus-mode-tabs">
                            <button class="focus-tab active" data-mode="work">Работа</button>
                            <button class="focus-tab" data-mode="short">Перерыв</button>
                            <button class="focus-tab" data-mode="long">Длинный перерыв</button>
                        </div>
                        
                        <div class="focus-task-name" id="focusTaskName">Выберите задачу для работы</div>
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-session-count">Сессия <span id="sessionCount">1</span> из <span id="totalSessions">4</span></div>
                        
                        <div class="timer-controls">
                            <button class="btn btn-primary" id="startTimerBtn" onclick="startFocusTimer()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Начать</button>
                            <button class="btn btn-outline" onclick="resetFocusTimer()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> Сбросить</button>
                            <button class="btn btn-outline" id="fullscreenBtn" onclick="toggleFullscreen()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button>
                        </div>
                        
                        <!-- Ambient звуки -->
                        <div class="ambient-sounds">
                            <div class="ambient-label">Фоновые звуки</div>
                            <div class="ambient-buttons">
                                <button class="ambient-btn" data-sound="none" title="Без звука">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                </button>
                                <button class="ambient-btn" data-sound="rain" title="Дождь">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8zm0 18c-3.35 0-6-2.57-6-6.2 0-2.34 1.95-5.44 6-9.14 4.05 3.7 6 6.79 6 9.14 0 3.63-2.65 6.2-6 6.2zm-4.17-6c.37 0 .67.26.74.62.41 2.22 2.28 2.98 3.64 2.87.43-.02.79.32.79.75 0 .4-.32.73-.72.75-2.13.13-4.62-1.09-5.19-4.12a.75.75 0 01.74-.87z"/></svg>
                                </button>
                                <button class="ambient-btn" data-sound="forest" title="Лес">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/></svg>
                                </button>
                                <button class="ambient-btn" data-sound="waves" title="Волны">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 16.99c-1.35 0-2.2.42-2.95.8-.65.33-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.95c1.35 0 2.2-.42 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.42 2.95-.8c.65-.33 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8zm0-4.45c-1.35 0-2.2.43-2.95.8-.65.32-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.43-2.95.8c-.65.32-1.17.6-2.05.6v1.95c1.35 0 2.2-.43 2.95-.8.65-.35 1.15-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.35 1.15-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8zm2.95-8.08c-.75-.38-1.58-.8-2.95-.8s-2.2.42-2.95.8c-.65.32-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.37-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.93c1.35 0 2.2-.43 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.32 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8V5.04c-.9 0-1.4-.25-2.05-.58zM17 8.09c-1.35 0-2.2.43-2.95.8-.65.35-1.15.6-2.05.6s-1.4-.25-2.05-.6c-.75-.38-1.57-.8-2.95-.8s-2.2.43-2.95.8c-.65.35-1.15.6-2.05.6v1.95c1.35 0 2.2-.43 2.95-.8.65-.32 1.18-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.32 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8V8.64c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.75-2.95-.75z"/></svg>
                                </button>
                                <button class="ambient-btn" data-sound="cafe" title="Кафе">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/></svg>
                                </button>
                                <button class="ambient-btn" data-sound="fire" title="Камин">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>
                                </button>
                            </div>
                            <input type="range" class="ambient-volume" id="ambientVolume" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>
                
                <!-- Журнал настроения -->
                <div class="mood-section">
                    <div class="mood-header">
                        <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Как вы себя чувствуете сегодня?</h3>
                        <span class="mood-streak" id="moodStreak"></span>
                    </div>
                    <div class="mood-today">
                        <button class="mood-emoji-btn" data-mood="1" onclick="setMood(1)" title="Очень плохо">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 15s1.5-2 4-2 4 2 4 2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                                <line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                                <path d="M9 9l-1-1M15 9l1-1" stroke-width="1.5"/>
                                <path d="M7.5 13l1 1M16.5 13l-1 1" stroke-width="1"/>
                            </svg>
                        </button>
                        <button class="mood-emoji-btn" data-mood="2" onclick="setMood(2)" title="Плохо">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 15s1.5-1 4-1 4 1 4 1"/>
                                <line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                                <line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button class="mood-emoji-btn" data-mood="3" onclick="setMood(3)" title="Нормально">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="8" y1="15" x2="16" y2="15"/>
                                <line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                                <line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button class="mood-emoji-btn" data-mood="4" onclick="setMood(4)" title="Хорошо">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                                <line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </button>
                        <button class="mood-emoji-btn" data-mood="5" onclick="setMood(5)" title="Отлично">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 13s1.5 3 4 3 4-3 4-3"/>
                                <line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                                <line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="mood-chart" id="moodChart"></div>
                </div>
                
                <!-- Расширенная статистика -->
                <div class="focus-stats-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Статистика продуктивности</h3>
                        <div class="stats-tabs">
                            <button class="stats-tab active" data-period="week" onclick="loadStats('week')">Неделя</button>
                            <button class="stats-tab" data-period="month" onclick="loadStats('month')">Месяц</button>
                            <button class="stats-tab" data-period="year" onclick="loadStats('year')">Год</button>
                        </div>
                    </div>
                    <div class="stats-summary" id="statsSummary">
                        <div class="summary-card">
                            <div class="summary-value" id="summaryMinutes">0</div>
                            <div class="summary-label">минут</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="summarySessions">0</div>
                            <div class="summary-label">сессий</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="summaryAvg">0</div>
                            <div class="summary-label">мин/день</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="summaryBestHour">-</div>
                            <div class="summary-label">лучший час</div>
                        </div>
                    </div>
                    <div class="stats-chart" id="weeklyChart"></div>
                </div>
                
                <!-- Шаблоны задач -->
                <div class="focus-stats-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>Шаблоны задач</h3>
                        <button class="btn btn-outline" onclick="openTemplateModal()" style="padding: 8px 16px; font-size: 0.85rem;">+ Создать шаблон</button>
                    </div>
                    <div class="templates-grid" id="templatesGrid">
                        <!-- Шаблоны загружаются динамически -->
                    </div>
                </div>
                
                <h3 style="margin: 24px 0 16px;">Задачи для работы</h3>
                <div class="cards-grid" id="focusTasksList"></div>
            </section>
            
            <!-- Плейлисты -->
            <section class="section" id="playlists-section">
                <!-- Скрытые элементы для совместимости -->
                <div class="yandex-disk-banner" id="yandexDiskBanner" style="display: none !important;">
                    <div class="yandex-disk-info">
                        <div><div class="yandex-disk-status" id="yandexDiskStatus"></div></div>
                    </div>
                    <button id="yandexConnectBtn"></button>
                </div>
                <button id="uploadCloudBtn" style="display: none !important;"></button>
                
                <!-- Заголовок списка плейлистов -->
                <div class="page-header" id="playlistsHeader">
                    <h1 class="page-title">Мои плейлисты</h1>
                    <button class="btn btn-primary" onclick="openPlaylistModal()">+ Новый плейлист</button>
                </div>
                
                <!-- Список плейлистов -->
                <div class="cards-grid" id="playlistsList"></div>
                
                <!-- Треки выбранного плейлиста -->
                <div id="tracksSection" style="display: none;">
                    <div class="page-header">
                        <h2 id="tracksTitle" style="font-size: 1.4rem;">Треки</h2>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn btn-outline" onclick="closeTracksSection()">← Назад</button>
                            <button class="btn btn-primary" onclick="openTrackModal()">+ Добавить трек</button>
                        </div>
                    </div>
                    <div class="tracks-list" id="tracksList"></div>
                </div>
            </section>
            
            <!-- Заметки -->
            <section class="section" id="notes-section">
                <div class="page-header">
                    <h1 class="page-title">Заметки</h1>
                    <button class="btn btn-primary" onclick="openNoteModal()">+ Новая заметка</button>
                </div>
                <div class="cards-grid" id="notesList"></div>
            </section>
            
            <!-- Чаты -->
            <section class="section" id="chats-section">
                <div class="chat-container">
                    <!-- Список чатов -->
                    <div class="chat-sidebar">
                        <div class="chat-sidebar-header">
                            <div style="flex: 1; position: relative;">
                                <input type="text" class="chat-search" id="chatSearch" placeholder="Поиск чатов или пользователей..." autocomplete="off">
                                <div class="user-search-results" id="userSearchResults"></div>
                            </div>
                            <button class="new-chat-btn" onclick="openNewChatModal()" title="Новый чат">+</button>
                        </div>
                        <div class="chat-list" id="chatList">
                            <div class="empty-state" style="padding: 40px 20px;">
                                <div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                                <p>Нет чатов</p>
                                <p style="font-size: 0.85rem; margin-top: 8px;">Найдите пользователя для начала общения</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Область сообщений -->
                    <div class="chat-main" id="chatMain">
                        <div class="chat-empty">
                            <div class="chat-empty-icon"><svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                            <p>Выберите чат для начала общения</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Прогресс и достижения -->
            <section class="section" id="progress-section">
                <div class="page-header">
                    <h1 class="page-title">Прогресс и достижения</h1>
                </div>
                
                <!-- Достижения -->
                <div class="achievements-panel">
                    <div class="achievements-header">
                        <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>Достижения</h3>
                        <div class="achievements-progress">
                            Разблокировано: <span id="achievementsCount">0/0</span>
                        </div>
                    </div>
                    <div class="achievements-grid" id="achievementsGrid">
                        <!-- Достижения загружаются динамически -->
                    </div>
                </div>
                
                <!-- Прогресс задач -->
                <div class="tasks-progress-panel">
                    <h3 style="margin-bottom: 20px;"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Прогресс задач</h3>
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 24px; align-items: center;">
                        <div class="progress-donut">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(99, 102, 241, 0.2)" stroke-width="12"/>
                                <circle id="progressCircle" cx="60" cy="60" r="50" fill="none" stroke="url(#progressGradient)" stroke-width="12" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="314"/>
                                <defs>
                                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#10b981"/>
                                        <stop offset="100%" stop-color="#14b8a6"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="progress-donut-center">
                                <div class="progress-donut-value" id="completionRate">0%</div>
                                <div class="progress-donut-label">выполнено</div>
                            </div>
                        </div>
                        <div class="progress-stats">
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="tasksPending">0</div>
                                <div class="progress-stat-label">Ожидают</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="tasksInProgress">0</div>
                                <div class="progress-stat-label">В работе</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="tasksCompleted">0</div>
                                <div class="progress-stat-label">Завершено</div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-value" id="tasksTotal">0</div>
                                <div class="progress-stat-label">Всего</div>
                            </div>
                        </div>
                    </div>
                    <h4 style="margin: 24px 0 12px; font-size: 0.95rem; color: var(--text-secondary);">Завершено за неделю</h4>
                    <div class="progress-weekly-chart" id="tasksWeeklyChart">
                        <!-- График загружается динамически -->
                    </div>
                </div>
                
                <!-- Журнал благодарности -->
                <div class="gratitude-section">
                    <div class="gratitude-header">
                        <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M12 21c-5-4-9-8-9-12a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 4-4 8-9 12z"/></svg>Журнал благодарности</h3>
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">Записывайте, за что вы благодарны</span>
                    </div>
                    <div class="gratitude-categories">
                        <button class="gratitude-cat-btn active" data-cat="general" onclick="selectGratitudeCategory('general')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg> Общее</button>
                        <button class="gratitude-cat-btn" data-cat="work" onclick="selectGratitudeCategory('work')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg> Работа</button>
                        <button class="gratitude-cat-btn" data-cat="health" onclick="selectGratitudeCategory('health')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 21c-5-4-9-8-9-12a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 4-4 8-9 12z"/></svg> Здоровье</button>
                        <button class="gratitude-cat-btn" data-cat="relationships" onclick="selectGratitudeCategory('relationships')"><svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 21c-5-4-9-8-9-12a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 4-4 8-9 12z"/></svg> Отношения</button>
                        <button class="gratitude-cat-btn" data-cat="growth" onclick="selectGratitudeCategory('growth')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M3 17l6-6 4 4 8-8"/><path d="M17 7h4v4"/></svg> Рост</button>
                    </div>
                    <div class="gratitude-input-wrapper">
                        <input type="text" class="gratitude-input" id="gratitudeInput" placeholder="За что вы благодарны сегодня?" maxlength="500">
                        <button class="btn btn-primary" onclick="addGratitudeEntry()" style="padding: 12px 20px;">Добавить</button>
                    </div>
                    <div class="gratitude-list" id="gratitudeList">
                        <!-- Записи загружаются динамически -->
                    </div>
                </div>
                
                <!-- Игра на память -->
                <div class="memory-game-panel">
                    <div class="memory-game-header">
                        <h3><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><path d="M12 2a4 4 0 0 1 4 4c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2 4 4 0 0 1 4-4z"/><path d="M12 8v6"/><path d="M8 22h8"/><path d="M12 14a6 6 0 0 0 6-6"/><path d="M12 14a6 6 0 0 1-6-6"/><path d="M9 22v-4a3 3 0 0 1 6 0v4"/></svg>Тренировка памяти</h3>
                        <div class="memory-game-stats">
                            <div class="memory-stat">
                                <div class="memory-stat-value" id="memoryLevel">1</div>
                                <div class="memory-stat-label">Уровень</div>
                            </div>
                            <div class="memory-stat">
                                <div class="memory-stat-value" id="memoryBest">0</div>
                                <div class="memory-stat-label">Рекорд</div>
                            </div>
                        </div>
                    </div>
                    <div class="memory-game-area" id="memoryGameArea">
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">Запомните последовательность и повторите её</p>
                        <div class="sequence-display" id="sequenceDisplay">
                            <!-- Последовательность отображается здесь -->
                        </div>
                        <div class="memory-game-message" id="memoryMessage"></div>
                        <div class="memory-buttons" id="memoryButtons" style="display: none;">
                            <button class="memory-btn" data-num="1" onclick="memoryInput(1)">1</button>
                            <button class="memory-btn" data-num="2" onclick="memoryInput(2)">2</button>
                            <button class="memory-btn" data-num="3" onclick="memoryInput(3)">3</button>
                            <button class="memory-btn" data-num="4" onclick="memoryInput(4)">4</button>
                            <button class="memory-btn" data-num="5" onclick="memoryInput(5)">5</button>
                            <button class="memory-btn" data-num="6" onclick="memoryInput(6)">6</button>
                            <button class="memory-btn" data-num="7" onclick="memoryInput(7)">7</button>
                            <button class="memory-btn" data-num="8" onclick="memoryInput(8)">8</button>
                            <button class="memory-btn" data-num="9" onclick="memoryInput(9)">9</button>
                        </div>
                        <button class="btn btn-primary memory-start-btn" id="memoryStartBtn" onclick="startMemoryGame()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Начать игру</button>
                    </div>
                </div>
            </section>
            
            <!-- Облако (Яндекс.Диск) -->
            <section class="section" id="cloud-section">
                <div class="page-header">
                    <h1 class="page-title">Облачное хранилище</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" id="cloudRefreshBtn" onclick="loadCloudFiles()" style="display: none;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                            Обновить
                        </button>
                        <button class="btn btn-primary" id="cloudUploadMainBtn" onclick="openCloudUploadModal()" style="display: none;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Загрузить
                        </button>
                    </div>
                </div>
                
                <!-- Статус подключения -->
                <div class="cloud-status-card" id="cloudStatusCard">
                    <div class="cloud-status-icon">
                        <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                        </svg>
                    </div>
                    <div class="cloud-status-info">
                        <h3 id="cloudStatusTitle">Яндекс.Диск не подключен</h3>
                        <p id="cloudStatusDesc">Подключите Яндекс.Диск для хранения музыки и файлов в облаке</p>
                        <div class="cloud-storage-bar" id="cloudStorageBar" style="display: none;">
                            <div class="cloud-storage-used" id="cloudStorageUsed"></div>
                        </div>
                        <p class="cloud-storage-text" id="cloudStorageText" style="display: none;"></p>
                    </div>
                    <button class="btn btn-yandex btn-lg" id="cloudConnectBtn" onclick="connectYandexDisk()">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Подключить Яндекс.Диск
                    </button>
                </div>
                
                <!-- Файловый менеджер -->
                <div class="cloud-files-container" id="cloudFilesContainer" style="display: none;">
                    <!-- Табы типов файлов -->
                    <div class="cloud-tabs">
                        <button class="cloud-tab active" data-type="all" onclick="switchCloudTab('all')">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                            Все файлы
                        </button>
                        <button class="cloud-tab" data-type="music" onclick="switchCloudTab('music')">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                            Музыка
                        </button>
                        <button class="cloud-tab" data-type="image" onclick="switchCloudTab('image')">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                            Изображения
                        </button>
                        <button class="cloud-tab" data-type="document" onclick="switchCloudTab('document')">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                            Документы
                        </button>
                    </div>
                    
                    <!-- Список файлов -->
                    <div class="cloud-files-list" id="cloudFilesList">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                                </svg>
                            </div>
                            <p>Нет файлов</p>
                            <p style="font-size: 0.85rem; margin-top: 8px; color: var(--text-secondary);">Загрузите первый файл</p>
                        </div>
                    </div>
                </div>
                
                <!-- Просмотр изображения -->
                <div class="image-preview-overlay" id="imagePreviewOverlay" style="display: none;">
                    <div class="image-preview-content">
                        <button class="image-preview-close" onclick="closeImagePreview()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                        <img id="imagePreviewImg" src="" alt="Preview">
                        <div class="image-preview-info" id="imagePreviewInfo"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Контейнер для уведомлений -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Модальное окно задачи -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 class="modal-title">Новая задача</h2>
                <button class="icon-btn" onclick="closeModal('taskModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Название</label>
                    <input type="text" class="form-input" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" name="description" style="min-height: 60px;"></textarea>
                </div>
                
                <!-- Пресеты фокуса -->
                <div class="form-group">
                    <label class="form-label">Пресет фокуса</label>
                    <div class="focus-presets">
                        <button type="button" class="preset-btn active" data-preset="pomodoro" onclick="selectFocusPreset('pomodoro')">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                            <span>Pomodoro</span>
                            <small>25/5 мин</small>
                        </button>
                        <button type="button" class="preset-btn" data-preset="deep" onclick="selectFocusPreset('deep')">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
                            <span>Глубокая работа</span>
                            <small>50/10 мин</small>
                        </button>
                        <button type="button" class="preset-btn" data-preset="short" onclick="selectFocusPreset('short')">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                            <span>Быстрая</span>
                            <small>15/3 мин</small>
                        </button>
                        <button type="button" class="preset-btn" data-preset="custom" onclick="selectFocusPreset('custom')">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                            <span>Своя</span>
                            <small>настроить</small>
                        </button>
                    </div>
                </div>
                
                <!-- Кастомные настройки (скрыты по умолчанию) -->
                <div class="custom-focus-settings" id="customFocusSettings" style="display: none;">
                    <div class="settings-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Работа (мин)</label>
                            <input type="number" class="form-input" name="work_duration" value="25" min="1" max="120">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Перерыв (мин)</label>
                            <input type="number" class="form-input" name="break_duration" value="5" min="1" max="30">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Сессий</label>
                            <input type="number" class="form-input" name="sessions_count" value="4" min="1" max="10">
                        </div>
                    </div>
                </div>
                
                <!-- Выбор плейлиста -->
                <div class="form-group">
                    <label class="form-label">Плейлист для фокуса</label>
                    <select class="form-select" name="playlist_id">
                        <option value="">Без музыки</option>
                    </select>
                </div>
                
                <!-- Ambient звук -->
                <div class="form-group">
                    <label class="form-label">Фоновый звук</label>
                    <div class="ambient-select">
                        <button type="button" class="ambient-select-btn active" data-sound="none">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                        </button>
                        <button type="button" class="ambient-select-btn" data-sound="rain">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/></svg>
                        </button>
                        <button type="button" class="ambient-select-btn" data-sound="forest">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/></svg>
                        </button>
                        <button type="button" class="ambient-select-btn" data-sound="waves">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 16.99c-1.35 0-2.2.42-2.95.8-.65.33-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.95c1.35 0 2.2-.42 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.42 2.95-.8c.65-.33 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8z"/></svg>
                        </button>
                        <button type="button" class="ambient-select-btn" data-sound="cafe">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/></svg>
                        </button>
                        <button type="button" class="ambient-select-btn" data-sound="fire">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67z"/></svg>
                        </button>
                    </div>
                    <input type="hidden" name="ambient_sound" value="none">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Создать задачу</button>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно заметки -->
    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Новая заметка</h2>
                <button class="icon-btn" onclick="closeModal('noteModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <form id="noteForm">
                <div class="form-group">
                    <label class="form-label">Заголовок</label>
                    <input type="text" class="form-input" name="title">
                </div>
                <div class="form-group">
                    <label class="form-label">Содержимое</label>
                    <textarea class="form-textarea" name="content" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Сохранить</button>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно настроек фокуса -->
    <div class="modal-overlay" id="focusSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Настройки фокуса</h2>
                <button class="icon-btn" onclick="closeModal('focusSettingsModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <form id="focusSettingsForm">
                <div class="form-group">
                    <label class="form-label">Время работы (минуты)</label>
                    <input type="number" class="form-input" id="settingWorkDuration" min="1" max="120" value="25">
                </div>
                <div class="form-group">
                    <label class="form-label">Короткий перерыв (минуты)</label>
                    <input type="number" class="form-input" id="settingShortBreak" min="1" max="30" value="5">
                </div>
                <div class="form-group">
                    <label class="form-label">Длинный перерыв (минуты)</label>
                    <input type="number" class="form-input" id="settingLongBreak" min="5" max="60" value="15">
                </div>
                <div class="form-group">
                    <label class="form-label">Сессий до длинного перерыва</label>
                    <input type="number" class="form-input" id="settingSessionsCount" min="2" max="10" value="4">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                    <input type="checkbox" id="settingBlockNotifications" checked>
                    <label for="settingBlockNotifications">Блокировать уведомления</label>
                </div>
                
                <div style="border-top: 1px solid var(--border-color); margin: 20px 0; padding-top: 20px;">
                    <h3 style="font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></span> Напоминания о здоровье
                    </h3>
                    
                    <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="settingWaterReminder" checked>
                        <label for="settingWaterReminder">Напоминать пить воду</label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Интервал напоминания о воде (минуты)</label>
                        <input type="number" class="form-input" id="settingWaterInterval" min="10" max="120" value="30">
                    </div>
                    
                    <div class="form-group" style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="settingEyeReminder" checked>
                        <label for="settingEyeReminder">Напоминать об упражнениях для глаз</label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Интервал для глаз (минуты, правило 20-20-20)</label>
                        <input type="number" class="form-input" id="settingEyeInterval" min="10" max="60" value="20">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Сохранить</button>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно плейлиста -->
    <div class="modal-overlay" id="playlistModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Новый плейлист</h2>
                <button class="icon-btn" onclick="closeModal('playlistModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <form id="playlistForm">
                <div class="form-group">
                    <label class="form-label">Название</label>
                    <input type="text" class="form-input" name="name" required placeholder="Мой плейлист">
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" name="description" placeholder="Описание плейлиста..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Создать</button>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно добавления трека -->
    <div class="modal-overlay" id="trackModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Добавить трек</h2>
                <button class="icon-btn" onclick="closeModal('trackModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            
            <!-- Переключатель источника -->
            <div class="track-source-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; padding: 4px; background: var(--bg-input); border-radius: 12px;">
                <button type="button" class="track-source-tab active" data-source="local" onclick="switchTrackSource('local')">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    С устройства
                </button>
                <button type="button" class="track-source-tab" data-source="cloud" onclick="switchTrackSource('cloud')" id="trackCloudTab">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
                    Из облака
                </button>
            </div>
            
            <!-- Форма загрузки с устройства -->
            <form id="trackForm" enctype="multipart/form-data">
                <input type="hidden" name="playlist_id" id="trackPlaylistId">
                
                <div id="trackLocalUpload">
                    <div class="form-group">
                        <label class="form-label">Аудиофайлы (MP3, WAV, OGG, M4A, FLAC)</label>
                        <div class="file-upload" id="fileUpload">
                            <input type="file" id="audioFile" name="files" accept=".mp3,.wav,.ogg,.m4a,.flac" required hidden multiple>
                            <div class="file-upload-content" onclick="document.getElementById('audioFile').click()">
                                <div class="file-upload-icon"><svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                                <div class="file-upload-text">Нажмите для выбора файлов</div>
                                <div class="file-upload-hint">или перетащите сюда (можно несколько)</div>
                            </div>
                            <div class="files-selected" id="filesSelected" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- Чекбокс для загрузки в облако -->
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; cursor: pointer;" id="uploadToCloudOption">
                        <input type="checkbox" id="uploadToCloud" style="width: 18px; height: 18px; accent-color: var(--primary);">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
                            Сохранить в Яндекс.Диск
                        </span>
                    </label>
                    
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 16px;">
                        Название и исполнитель будут извлечены автоматически из метаданных файлов
                    </p>
                    
                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress-bar-upload" id="progressBarUpload"></div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Загрузить</button>
                </div>
            </form>
            
            <!-- Выбор из облака -->
            <div id="trackCloudSelect" style="display: none;">
                <div id="trackCloudStatus"></div>
                <div class="cloud-files-select" id="trackCloudFiles" style="max-height: 300px; overflow-y: auto;">
                    <!-- Файлы из облака -->
                </div>
                <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="addTracksFromCloud()">Добавить выбранные</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно нового чата -->
    <div class="modal-overlay" id="newChatModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Новый чат</h2>
                <button class="icon-btn" onclick="closeModal('newChatModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            
            <!-- Выбор типа чата -->
            <div class="chat-type-selector" style="display: flex; gap: 12px; margin-bottom: 20px;">
                <button class="chat-type-btn active" data-type="private" onclick="selectChatType('private')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span>Личный чат</span>
                </button>
                <button class="chat-type-btn" data-type="group" onclick="selectChatType('group')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>Группа</span>
                </button>
                <button class="chat-type-btn" data-type="channel" onclick="selectChatType('channel')">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    <span>Канал</span>
                </button>
            </div>
            
            <!-- Форма личного чата -->
            <div id="privateChatForm">
                <div class="form-group">
                    <label class="form-label">Найти пользователя</label>
                    <input type="text" class="form-input" id="newChatUserSearch" placeholder="Введите имя или username..." autocomplete="off">
                </div>
                <div id="newChatUserResults" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
            
            <!-- Форма группы -->
            <div id="groupChatForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Название группы *</label>
                    <input type="text" class="form-input" id="groupName" placeholder="Введите название..." maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" id="groupDescription" placeholder="О чём эта группа..." style="min-height: 60px;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Добавить участников</label>
                    <input type="text" class="form-input" id="groupMemberSearch" placeholder="Поиск пользователей..." autocomplete="off">
                    <div id="groupMemberResults" style="max-height: 150px; overflow-y: auto; margin-top: 8px;"></div>
                    <div id="selectedGroupMembers" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="groupIsPublic" style="width: 18px; height: 18px;">
                        Публичная группа (можно найти в поиске)
                    </label>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="createGroup()">Создать группу</button>
            </div>
            
            <!-- Форма канала -->
            <div id="channelChatForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Название канала *</label>
                    <input type="text" class="form-input" id="channelName" placeholder="Введите название..." maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" id="channelDescription" placeholder="О чём этот канал..." style="min-height: 60px;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Username (опционально)</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="color: var(--text-secondary);">@</span>
                        <input type="text" class="form-input" id="channelUsername" placeholder="myChannel" maxlength="50" style="flex: 1;">
                    </div>
                    <small style="color: var(--text-secondary);">Публичная ссылка: t.me/username</small>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="channelIsPublic" style="width: 18px; height: 18px;">
                        Публичный канал
                    </label>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="createChannel()">Создать канал</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно настроек группы/канала -->
    <div class="modal-overlay" id="chatSettingsModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="chatSettingsTitle">Настройки</h2>
                <button class="icon-btn" onclick="closeModal('chatSettingsModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            
            <div class="settings-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px;">
                <button class="settings-tab active" data-tab="general" onclick="switchSettingsTab('general')">Основные</button>
                <button class="settings-tab" data-tab="permissions" onclick="switchSettingsTab('permissions')">Права</button>
                <button class="settings-tab" data-tab="members" onclick="switchSettingsTab('members')">Участники</button>
            </div>
            
            <!-- Основные настройки -->
            <div id="settingsGeneral">
                <!-- Аватар и название в одной строке -->
                <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                    <div class="chat-avatar-edit" onclick="document.getElementById('chatAvatarInput').click()">
                        <div id="settingsChatAvatar" class="chat-avatar-preview">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </div>
                        <div class="avatar-edit-overlay">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        </div>
                        <input type="file" id="chatAvatarInput" accept="image/*" style="display: none;" onchange="uploadChatAvatar(this)">
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-input" id="settingsChatName" maxlength="100">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" id="settingsChatDescription" style="min-height: 80px;" placeholder="Расскажите о чём этот чат..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Username (публичная ссылка)</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="color: var(--text-secondary);">@</span>
                        <input type="text" class="form-input" id="settingsChatUsername" maxlength="50" style="flex: 1;" placeholder="mygroup">
                    </div>
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Только латинские буквы, цифры и подчёркивания</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Пригласительная ссылка</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="settingsInviteLink" readonly style="flex: 1;">
                        <button class="btn btn-outline" onclick="copyInviteLink()" style="padding: 8px 12px;" title="Копировать">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </button>
                        <button class="btn btn-outline" onclick="regenerateInviteLink()" style="padding: 8px 12px;" title="Обновить ссылку">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="settingsIsPublic" style="width: 18px; height: 18px;">
                        Публичный (можно найти в поиске)
                    </label>
                </div>
                <div class="form-group" id="settingsWorkChatGroup">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="settingsIsWorkChat" style="width: 18px; height: 18px;">
                        Рабочий чат (уведомления в режиме фокуса)
                    </label>
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Сообщения из рабочих чатов приходят даже в режиме фокусировки</small>
                </div>
            </div>
            
            <!-- Права участников -->
            <div id="settingsPermissions" style="display: none;">
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="settingsMembersCanSend" style="width: 18px; height: 18px;">
                        Участники могут отправлять сообщения
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="settingsMembersCanAdd" style="width: 18px; height: 18px;">
                        Участники могут добавлять людей
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="settingsMembersCanPin" style="width: 18px; height: 18px;">
                        Участники могут закреплять сообщения
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Медленный режим</label>
                    <select class="form-select" id="settingsSlowMode">
                        <option value="0">Выключен</option>
                        <option value="10">10 секунд</option>
                        <option value="30">30 секунд</option>
                        <option value="60">1 минута</option>
                        <option value="300">5 минут</option>
                        <option value="900">15 минут</option>
                        <option value="3600">1 час</option>
                    </select>
                </div>
            </div>
            
            <!-- Участники -->
            <div id="settingsMembers" style="display: none;">
                <div class="form-group">
                    <input type="text" class="form-input" id="settingsMemberSearch" placeholder="Добавить участника..." autocomplete="off">
                    <div id="settingsMemberResults" style="max-height: 150px; overflow-y: auto; margin-top: 8px;"></div>
                </div>
                <div id="settingsMembersList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="saveChatSettings()">Сохранить</button>
                <button class="btn btn-outline" style="color: #ef4444; border-color: #ef4444;" onclick="deleteGroupOrChannel()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    Удалить
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно напоминания о воде -->
    <div class="modal-overlay" id="waterReminderModal">
        <div class="modal" style="max-width: 400px;">
            <div class="health-reminder-modal">
                <div class="health-reminder-icon"><svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
                <h2 class="health-reminder-title">Время попить воды!</h2>
                <p class="health-reminder-text">
                    Поддержание водного баланса важно для концентрации и здоровья мозга. 
                    Выпейте стакан воды прямо сейчас.
                </p>
                <div class="health-reminder-actions">
                    <button class="btn btn-outline" onclick="snoozeReminder('water', 10)">Через 10 мин</button>
                    <button class="btn btn-primary" onclick="dismissReminder('water')">Готово!</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно упражнений для глаз -->
    <div class="modal-overlay" id="eyeReminderModal">
        <div class="modal" style="max-width: 450px;">
            <div class="health-reminder-modal">
                <div class="health-reminder-icon"><svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
                <h2 class="health-reminder-title">Правило 20-20-20</h2>
                <p class="health-reminder-text">
                    Каждые 20 минут смотрите на объект в 20 футах (6 метрах) в течение 20 секунд.
                    Это снижает напряжение глаз.
                </p>
                <div class="eye-exercise-container" id="eyeExerciseContainer" style="display: none;">
                    <div class="eye-exercise-visual">
                        <div class="eye-exercise-track"></div>
                        <div class="eye-dot moving" id="eyeDot"></div>
                    </div>
                    <div class="eye-exercise-timer" id="eyeExerciseTimer">20</div>
                    <p class="eye-exercise-instruction">Следите глазами за точкой</p>
                </div>
                <div class="health-reminder-actions" id="eyeExerciseActions">
                    <button class="btn btn-outline" onclick="snoozeReminder('eye', 10)">Через 10 мин</button>
                    <button class="btn btn-primary" onclick="startEyeExercise()">Начать упражнение</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно создания шаблона -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Новый шаблон</h2>
                <button class="icon-btn" onclick="closeModal('templateModal')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <form id="templateForm">
                <div class="form-group">
                    <label class="form-label">Название шаблона</label>
                    <input type="text" class="form-input" name="name" required placeholder="Например: Работа над проектом">
                </div>
                <div class="form-group">
                    <label class="form-label">Иконка</label>
                    <div class="template-icons-grid">
                        <button type="button" class="template-icon-btn selected" data-icon="document" onclick="selectTemplateIcon('document')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="laptop" onclick="selectTemplateIcon('laptop')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="2" y1="20" x2="22" y2="20"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="screens" onclick="selectTemplateIcon('screens')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="9" height="9" rx="1"/><rect x="13" y="2" width="9" height="9" rx="1" fill="currentColor" opacity="0.3"/><rect x="2" y="13" width="9" height="9" rx="1" fill="currentColor" opacity="0.3"/><rect x="13" y="13" width="9" height="9" rx="1"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="pencil" onclick="selectTemplateIcon('pencil')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="palette" onclick="selectTemplateIcon('palette')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="1.5" fill="currentColor"/><circle cx="17.5" cy="10.5" r="1.5" fill="currentColor"/><circle cx="8.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="6.5" cy="12.5" r="1.5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="dumbbell" onclick="selectTemplateIcon('dumbbell')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5h11M6.5 17.5h11"/><rect x="2" y="5" width="4" height="14" rx="1"/><rect x="18" y="5" width="4" height="14" rx="1"/><rect x="5" y="8" width="2" height="8" rx="0.5"/><rect x="17" y="8" width="2" height="8" rx="0.5"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="meditation" onclick="selectTemplateIcon('meditation')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="2.5"/><path d="M12 8v3"/><path d="M8 21c0-3 1-5 4-5s4 2 4 5"/><path d="M6 14c1.5-1 3-1.5 6-1.5s4.5.5 6 1.5"/><path d="M4 17c1-1 2.5-2 4-2.5"/><path d="M20 17c-1-1-2.5-2-4-2.5"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="target" onclick="selectTemplateIcon('target')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2" fill="currentColor"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="book" onclick="selectTemplateIcon('book')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="coffee" onclick="selectTemplateIcon('coffee')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="brain" onclick="selectTemplateIcon('brain')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M12 5v13"/></svg>
                        </button>
                        <button type="button" class="template-icon-btn" data-icon="rocket" onclick="selectTemplateIcon('rocket')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>
                        </button>
                    </div>
                    <input type="hidden" name="icon" id="templateIcon" value="document">
                </div>
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea class="form-textarea" name="description" placeholder="Краткое описание шаблона..." style="min-height: 60px;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Время работы (мин)</label>
                        <input type="number" class="form-input" name="timer_minutes" value="25" min="5" max="120">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Перерыв (мин)</label>
                        <input type="number" class="form-input" name="break_minutes" value="5" min="1" max="30">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Подзадачи по умолчанию (по одной на строку)</label>
                    <textarea class="form-textarea" name="subtasks" placeholder="Подготовка&#10;Основная работа&#10;Проверка" style="min-height: 80px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Создать шаблон</button>
            </form>
        </div>
    </div>
    
    <!-- Скрытый аудио плеер -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script>
        let currentUser = null;
        let timerInterval = null;
        let timerRunning = false;
        let timerSeconds = 25 * 60;
        let currentTask = null;
        
        // ==================== ОБРАБОТКА ОШИБОК API ====================
        function getErrorMessage(status, defaultMsg = 'Произошла ошибка') {
            const errors = {
                400: { title: 'Неверный запрос', msg: 'Проверьте введённые данные' },
                401: { title: 'Не авторизован', msg: 'Необходимо войти в аккаунт' },
                403: { title: 'Доступ запрещён', msg: 'У вас нет прав для этого действия' },
                404: { title: 'Не найдено', msg: 'Запрашиваемый ресурс не найден' },
                413: { title: 'Превышен лимит', msg: 'Файл слишком большой. Максимум: 500 МБ' },
                429: { title: 'Слишком много запросов', msg: 'Подождите немного и попробуйте снова' },
                500: { title: 'Ошибка сервера', msg: 'Внутренняя ошибка. Попробуйте позже' },
                502: { title: 'Сервер недоступен', msg: 'Сервер временно недоступен' },
                503: { title: 'Сервис недоступен', msg: 'Сервис временно недоступен' },
                504: { title: 'Таймаут', msg: 'Сервер не отвечает. Попробуйте позже' }
            };
            return errors[status] || { title: 'Ошибка', msg: defaultMsg };
        }
        
        async function handleApiError(response, customMessages = {}) {
            const status = response.status;
            let errorData = {};
            
            try {
                errorData = await response.json();
            } catch {}
            
            // Проверяем кастомные сообщения для этого статуса
            if (customMessages[status]) {
                showToast(customMessages[status].msg, 'error', customMessages[status].title);
                return;
            }
            
            // Если сервер вернул сообщение об ошибке
            if (errorData.error) {
                const errInfo = getErrorMessage(status);
                showToast(errorData.error, 'error', errInfo.title);
                return;
            }
            
            // Стандартное сообщение по коду
            const errInfo = getErrorMessage(status);
            showToast(errInfo.msg, 'error', errInfo.title);
        }
        
        // ==================== КАСТОМНЫЕ УВЕДОМЛЕНИЯ ====================
        function showToast(message, type = 'info', title = null, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                warning: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                info: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
            };
            const titles = {
                success: 'Успешно',
                error: 'Ошибка',
                warning: 'Внимание',
                info: 'Информация'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${title || titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this.parentElement)"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            `;
            
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => closeToast(toast), duration);
            }
            
            return toast;
        }
        
        function closeToast(toast) {
            if (!toast || toast.classList.contains('toast-out')) return;
            toast.classList.add('toast-out');
            setTimeout(() => toast.remove(), 300);
        }
        
        // Кастомный confirm
        function showConfirm(message, title = 'Подтверждение', options = {}) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-dialog">
                        <div class="confirm-icon">${options.icon || '❓'}</div>
                        <div class="confirm-title">${title}</div>
                        <div class="confirm-message">${message}</div>
                        <div class="confirm-buttons">
                            <button class="btn btn-outline" id="confirmCancel">${options.cancelText || 'Отмена'}</button>
                            <button class="btn ${options.danger ? 'btn-danger' : 'btn-primary'}" id="confirmOk">${options.okText || 'Да'}</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const close = (result) => {
                    overlay.remove();
                    resolve(result);
                };
                
                overlay.querySelector('#confirmCancel').onclick = () => close(false);
                overlay.querySelector('#confirmOk').onclick = () => close(true);
                overlay.onclick = (e) => { if (e.target === overlay) close(false); };
                
                // Фокус на кнопку OK
                overlay.querySelector('#confirmOk').focus();
            });
        }
        
        // Кастомный alert
        function showAlert(message, title = 'Уведомление', icon = '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-dialog">
                        <div class="confirm-icon">${icon}</div>
                        <div class="confirm-title">${title}</div>
                        <div class="confirm-message">${message}</div>
                        <div class="confirm-buttons">
                            <button class="btn btn-primary" id="alertOk" style="flex: 1;">OK</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const close = () => {
                    overlay.remove();
                    resolve();
                };
                
                overlay.querySelector('#alertOk').onclick = close;
                overlay.onclick = (e) => { if (e.target === overlay) close(); };
                overlay.querySelector('#alertOk').focus();
            });
        }
        
        // Кастомный prompt
        function showPrompt(title, defaultValue = '', placeholder = '') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-dialog">
                        <div class="confirm-icon">✏️</div>
                        <div class="confirm-title">${title}</div>
                        <div style="margin-bottom: 20px;">
                            <textarea class="form-textarea" id="promptInput" placeholder="${placeholder}" style="min-height: 80px; resize: vertical;">${defaultValue}</textarea>
                        </div>
                        <div class="confirm-buttons">
                            <button class="btn btn-outline" id="promptCancel">Отмена</button>
                            <button class="btn btn-primary" id="promptOk">Сохранить</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const input = overlay.querySelector('#promptInput');
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
                
                const close = (value) => {
                    overlay.remove();
                    resolve(value);
                };
                
                overlay.querySelector('#promptCancel').onclick = () => close(null);
                overlay.querySelector('#promptOk').onclick = () => close(input.value.trim());
                overlay.onclick = (e) => { if (e.target === overlay) close(null); };
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        close(input.value.trim());
                    }
                    if (e.key === 'Escape') {
                        close(null);
                    }
                });
            });
        }
        
        // Проверка URL параметров при загрузке
        (function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('yandex_connected') === '1') {
                setTimeout(() => showToast('Яндекс.Диск успешно подключен!', 'success'), 500);
                // Убираем параметр из URL
                window.history.replaceState({}, '', window.location.pathname);
            }
            if (params.get('yandex_error')) {
                setTimeout(() => showToast('Ошибка подключения Яндекс.Диска: ' + params.get('yandex_error'), 'error'), 500);
                window.history.replaceState({}, '', window.location.pathname);
            }
        })();
        
        // Загрузка данных
        async function loadUser() {
            const res = await fetch('/api/me');
            currentUser = await res.json();
            document.getElementById('userName').textContent = currentUser.name || currentUser.username;
            document.getElementById('userUsername').textContent = '@' + currentUser.username;
            document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.username)[0].toUpperCase();
        }
        
        async function loadTasks() {
            const res = await fetch('/api/tasks');
            const tasks = await res.json();
            renderTasks(tasks);
            renderFocusTasks(tasks.filter(t => t.status !== 'completed'));
        }
        
        function renderTasks(tasks) {
            const container = document.getElementById('tasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div><p>Нет задач. Создайте первую!</p></div>';
                return;
            }
            container.innerHTML = tasks.map(task => {
                const subtasks = task.subtasks || [];
                const completedCount = task.subtasks_completed || 0;
                const totalCount = task.subtasks_total || 0;
                
                const subtasksHtml = subtasks.length > 0 ? `
                    <div class="subtasks-section">
                        <div class="subtasks-header">
                            <span class="subtasks-title">
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                Подзадачи
                            </span>
                            <span class="subtasks-progress">${completedCount}/${totalCount}</span>
                        </div>
                        <div class="subtasks-list">
                            ${subtasks.map(s => `
                                <div class="subtask-item ${s.is_completed ? 'completed' : ''}">
                                    <div class="subtask-checkbox ${s.is_completed ? 'completed' : ''}" 
                                         onclick="event.stopPropagation(); toggleSubtask(${s.id}, ${!s.is_completed})"></div>
                                    <span class="subtask-title">${s.title}</span>
                                    <span class="subtask-delete" onclick="event.stopPropagation(); deleteSubtask(${s.id})"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="add-subtask-btn" id="addSubtaskBtn-${task.id}" onclick="event.stopPropagation(); showSubtaskInput(${task.id})">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            Добавить подзадачу
                        </button>
                        <div class="subtask-input-wrapper" id="subtaskInputWrapper-${task.id}" style="display: none;">
                            <input type="text" class="subtask-input" id="subtaskInput-${task.id}" 
                                   placeholder="Название подзадачи..." 
                                   onkeypress="if(event.key==='Enter'){event.stopPropagation(); addSubtask(${task.id})}"
                                   onclick="event.stopPropagation()">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); addSubtask(${task.id})">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            </button>
                            <button class="btn btn-outline" onclick="event.stopPropagation(); hideSubtaskInput(${task.id})">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                            </button>
                        </div>
                    </div>
                ` : `
                    <div class="subtasks-section">
                        <button class="add-subtask-btn" id="addSubtaskBtn-${task.id}" onclick="event.stopPropagation(); showSubtaskInput(${task.id})">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            Добавить подзадачу
                        </button>
                        <div class="subtask-input-wrapper" id="subtaskInputWrapper-${task.id}" style="display: none;">
                            <input type="text" class="subtask-input" id="subtaskInput-${task.id}" 
                                   placeholder="Название подзадачи..." 
                                   onkeypress="if(event.key==='Enter'){event.stopPropagation(); addSubtask(${task.id})}"
                                   onclick="event.stopPropagation()">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); addSubtask(${task.id})">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            </button>
                            <button class="btn btn-outline" onclick="event.stopPropagation(); hideSubtaskInput(${task.id})">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                            </button>
                        </div>
                    </div>
                `;
                
                return `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">${task.title}</div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="deleteTask(${task.id})" title="Удалить">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 12px;">${task.description || 'Без описания'}</p>
                    <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                    <div class="task-meta">
                        <span><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ${task.timer_minutes} мин</span>
                        ${totalCount > 0 ? `<span><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg> ${completedCount}/${totalCount}</span>` : ''}
                    </div>
                    ${subtasksHtml}
                </div>
            `}).join('');
        }
        
        function renderFocusTasks(tasks) {
            const container = document.getElementById('focusTasksList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Нет активных задач</p></div>';
                return;
            }
            
            // Сохраняем задачи для передачи в selectTaskForFocus
            window.focusTasksData = {};
            tasks.forEach(t => window.focusTasksData[t.id] = t);
            
            const presetIcons = {
                pomodoro: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>',
                deep: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3z"/></svg>',
                short: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>',
                custom: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>'
            };
            
            container.innerHTML = tasks.map(task => `
                <div class="card focus-task-card" onclick="selectTaskForFocus(${task.id}, '${task.title.replace(/'/g, "\\'")}', ${task.timer_minutes}, window.focusTasksData[${task.id}])">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div class="card-title">${task.title}</div>
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteTask(${task.id})" title="Удалить" style="flex-shrink: 0;">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                    <div class="task-meta">
                        <span>${presetIcons[task.focus_preset] || presetIcons.pomodoro} ${task.timer_minutes}/${task.break_minutes || 5} мин</span>
                        <span>× ${task.sessions_count || 4} сессий</span>
                    </div>
                </div>
            `).join('');
        }
        
        function getStatusText(status) {
            const map = { pending: 'Ожидает', in_progress: 'В работе', completed: 'Завершена' };
            return map[status] || status;
        }
        
        async function loadNotes() {
            const res = await fetch('/api/notes');
            const notes = await res.json();
            const container = document.getElementById('notesList');
            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div><p>Нет заметок</p></div>';
                return;
            }
            container.innerHTML = notes.map(note => `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">${note.title || 'Без заголовка'}</div>
                        <button class="icon-btn" onclick="deleteNote(${note.id})" title="Удалить">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                    <p style="color: var(--text-secondary);">${note.content}</p>
                </div>
            `).join('');
        }
        
        let allPlaylists = [];
        let currentPlaylist = null;
        let currentTracks = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        
        // Яндекс.Диск
        let yandexDiskConnected = false;
        let yandexDiskInfo = null;
        
        // Создаём аудио плеер программно
        const audioPlayer = new Audio();
        
        // Инициализация событий аудио плеера
        audioPlayer.addEventListener('timeupdate', updateProgress);
        audioPlayer.addEventListener('ended', nextTrack);
        audioPlayer.addEventListener('loadedmetadata', updateProgress);
        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            updatePlayPauseIcon();
        });
        audioPlayer.addEventListener('pause', () => {
            isPlaying = false;
            updatePlayPauseIcon();
        });
        audioPlayer.addEventListener('error', (e) => {
            console.error('Audio error:', e);
            showToast('Не удалось воспроизвести аудиофайл. Возможно файл повреждён или формат не поддерживается', 'error', 'Ошибка воспроизведения');
        });
        
        // Клик по прогресс-бару для перемотки
        document.addEventListener('DOMContentLoaded', () => {
            const progressContainer = document.querySelector('.player-progress');
            if (progressContainer) {
                progressContainer.addEventListener('click', (e) => {
                    if (!audioPlayer.duration) return;
                    const rect = e.currentTarget.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                });
            }
        });
        
        function updateProgress() {
            if (!audioPlayer.duration) return;
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('playerProgress').style.width = percent + '%';
            
            // Обновляем время
            const timeEl = document.getElementById('playerTime');
            if (timeEl) {
                timeEl.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;
            }
        }
        
        function seekTrack(e) {
            if (!audioPlayer.duration) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = percent * audioPlayer.duration;
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        async function loadPlaylists() {
            const res = await fetch('/api/playlists');
            allPlaylists = await res.json();
            renderPlaylists();
            // Проверяем статус Яндекс.Диска
            checkYandexDiskStatus();
        }
        
        // ==================== ЯНДЕКС.ДИСК ====================
        
        async function checkYandexDiskStatus() {
            try {
                const res = await fetch('/api/yandex/status');
                const data = await res.json();
                
                // Обновляем баннер в плейлистах (скрытый)
                const banner = document.getElementById('yandexDiskBanner');
                const statusEl = document.getElementById('yandexDiskStatus');
                const connectBtn = document.getElementById('yandexConnectBtn');
                const uploadBtn = document.getElementById('uploadCloudBtn');
                
                // Обновляем секцию облака
                const cloudStatusCard = document.getElementById('cloudStatusCard');
                const cloudStatusTitle = document.getElementById('cloudStatusTitle');
                const cloudStatusDesc = document.getElementById('cloudStatusDesc');
                const cloudConnectBtn = document.getElementById('cloudConnectBtn');
                const cloudFilesContainer = document.getElementById('cloudFilesContainer');
                const cloudStorageBar = document.getElementById('cloudStorageBar');
                const cloudStorageUsed = document.getElementById('cloudStorageUsed');
                const cloudStorageText = document.getElementById('cloudStorageText');
                const cloudRefreshBtn = document.getElementById('cloudRefreshBtn');
                const cloudUploadMainBtn = document.getElementById('cloudUploadMainBtn');
                
                // Проверяем что элементы существуют
                if (!cloudStatusCard) {
                    console.log('[YandexDisk] Cloud section elements not found yet');
                    return;
                }
                
                if (banner) banner.style.display = 'none';
                
                if (data.connected) {
                    yandexDiskConnected = true;
                    yandexDiskInfo = data;
                    
                    const usedGB = (data.used_space / 1024 / 1024 / 1024).toFixed(1);
                    const totalGB = (data.total_space / 1024 / 1024 / 1024).toFixed(0);
                    const usedPercent = (data.used_space / data.total_space * 100).toFixed(1);
                    
                    // Баннер в плейлистах (скрытый, для совместимости)
                    if (banner) banner.classList.add('connected');
                    if (statusEl) statusEl.textContent = `Подключен • ${usedGB} / ${totalGB} ГБ`;
                    if (connectBtn) {
                        connectBtn.textContent = 'Отключить';
                        connectBtn.className = 'btn btn-yandex-disconnect';
                        connectBtn.onclick = disconnectYandexDisk;
                    }
                    if (uploadBtn) uploadBtn.style.display = 'none';
                    
                    // Секция облака
                    cloudStatusCard.classList.add('connected');
                    cloudStatusTitle.textContent = 'Яндекс.Диск подключен';
                    cloudStatusDesc.textContent = data.user?.display_name || 'Ваше облачное хранилище';
                    cloudConnectBtn.textContent = 'Отключить';
                    cloudConnectBtn.className = 'btn btn-yandex-disconnect btn-lg';
                    cloudConnectBtn.onclick = disconnectYandexDisk;
                    cloudStorageBar.style.display = 'block';
                    cloudStorageUsed.style.width = usedPercent + '%';
                    cloudStorageText.style.display = 'block';
                    cloudStorageText.textContent = `Использовано ${usedGB} ГБ из ${totalGB} ГБ`;
                    cloudFilesContainer.style.display = 'block';
                    cloudRefreshBtn.style.display = 'flex';
                    cloudUploadMainBtn.style.display = 'flex';
                    
                    // Загружаем файлы
                    loadCloudFiles();
                } else {
                    yandexDiskConnected = false;
                    
                    // Баннер в плейлистах (скрытый)
                    if (banner) banner.classList.remove('connected');
                    if (statusEl) statusEl.textContent = 'Не подключен';
                    if (connectBtn) {
                        connectBtn.innerHTML = 'Подключить';
                        connectBtn.className = 'btn btn-yandex';
                        connectBtn.onclick = connectYandexDisk;
                    }
                    if (uploadBtn) uploadBtn.style.display = 'none';
                    
                    // Секция облака
                    cloudStatusCard.classList.remove('connected');
                    cloudStatusTitle.textContent = 'Яндекс.Диск не подключен';
                    cloudStatusDesc.textContent = 'Подключите Яндекс.Диск для хранения музыки и файлов в облаке';
                    cloudConnectBtn.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Подключить Яндекс.Диск';
                    cloudConnectBtn.className = 'btn btn-yandex btn-lg';
                    cloudConnectBtn.onclick = connectYandexDisk;
                    cloudStorageBar.style.display = 'none';
                    cloudStorageText.style.display = 'none';
                    cloudFilesContainer.style.display = 'none';
                    cloudRefreshBtn.style.display = 'none';
                    cloudUploadMainBtn.style.display = 'none';
                }
            } catch (e) {
                console.error('Ошибка проверки Яндекс.Диска:', e);
            }
        }
        
        let currentCloudTab = 'all';
        let cloudFiles = [];
        
        function switchCloudTab(type) {
            currentCloudTab = type;
            document.querySelectorAll('.cloud-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.type === type);
            });
            loadCloudFiles();
        }
        
        async function loadCloudFiles() {
            if (!yandexDiskConnected) return;
            
            try {
                const res = await fetch(`/api/yandex/files?type=${currentCloudTab}`);
                cloudFiles = await res.json();
                renderCloudFiles();
            } catch (e) {
                console.error('Ошибка загрузки файлов:', e);
            }
        }
        
        function renderCloudFiles() {
            const container = document.getElementById('cloudFilesList');
            
            if (cloudFiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                            </svg>
                        </div>
                        <p>Нет файлов</p>
                        <p style="font-size: 0.85rem; margin-top: 8px; color: var(--text-secondary);">Загрузите первый файл</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cloudFiles.map(file => {
                const fileType = file.file_type || 'other';
                const icon = getFileIcon(fileType);
                const actions = getFileActions(file);
                
                return `
                    <div class="cloud-file-item" data-id="${file.id}" data-type="${fileType}">
                        <div class="cloud-file-icon ${fileType}">
                            ${icon}
                        </div>
                        <div class="cloud-file-info">
                            <div class="cloud-file-name">${file.title || file.filename}</div>
                            <div class="cloud-file-meta">
                                ${file.artist ? file.artist + ' • ' : ''}
                                ${file.duration ? formatDuration(file.duration) + ' • ' : ''}
                                ${formatFileSize(file.size)}
                            </div>
                        </div>
                        <div class="cloud-file-actions">
                            ${actions}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getFileIcon(type) {
            const icons = {
                music: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
                image: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',
                document: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
                video: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18"/><path d="M10 8l6 4-6 4V8z"/></svg>',
                archive: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8v13H3V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/></svg>',
                other: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>'
            };
            return icons[type] || icons.other;
        }
        
        function getFileActions(file) {
            const type = file.file_type || 'other';
            let actions = '';
            
            // Кнопка воспроизведения для музыки
            if (type === 'music') {
                actions += `<button class="icon-btn" onclick="playCloudFile(${file.id})" title="Воспроизвести">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </button>`;
            }
            
            // Кнопка просмотра для изображений
            if (type === 'image') {
                actions += `<button class="icon-btn" onclick="previewImage(${file.id}, '${file.filename}')" title="Просмотреть">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>`;
            }
            
            // Кнопка скачивания для всех
            actions += `<button class="icon-btn" onclick="downloadCloudFile(${file.id}, '${file.filename}')" title="Скачать">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </button>`;
            
            // Кнопка удаления
            actions += `<button class="icon-btn" onclick="deleteCloudFile(${file.id})" title="Удалить">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>`;
            
            return actions;
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' Б';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' КБ';
            return (bytes / 1024 / 1024).toFixed(1) + ' МБ';
        }
        
        async function playCloudFile(fileId) {
            try {
                // Получаем информацию о файле
                const filesRes = await fetch('/api/yandex/files?type=all');
                const files = await filesRes.json();
                const file = files.find(f => f.id === fileId);
                
                if (!file) {
                    showToast('Файл не найден', 'error');
                    return;
                }
                
                // Показываем панель плеера с информацией о файле
                document.getElementById('playerPanel').style.display = 'flex';
                document.getElementById('playerTrackName').textContent = file.title || file.filename;
                document.getElementById('playerArtist').textContent = file.artist || 'Неизвестный исполнитель';
                
                // Используем прямой эндпоинт для потокового воспроизведения
                const streamUrl = `/api/yandex/play/${fileId}`;
                
                audioPlayer.src = streamUrl;
                audioPlayer.load();
                audioPlayer.play().catch(err => {
                    console.error('Playback error:', err);
                    showToast('Ошибка воспроизведения', 'error');
                });
                
                isPlaying = true;
                updatePlayPauseIcon();
                showToast('Воспроизведение...', 'success');
            } catch (e) {
                console.error('Error playing cloud file:', e);
                showToast('Ошибка воспроизведения', 'error');
            }
        }
        
        async function deleteCloudFile(fileId) {
            if (!confirm('Удалить файл из облака?')) return;
            
            try {
                await fetch(`/api/yandex/delete/${fileId}`, { method: 'DELETE' });
                showToast('Файл удалён', 'success');
                loadCloudFiles();
            } catch (e) {
                showToast('Ошибка удаления', 'error');
            }
        }
        
        async function playCloudTrack(cloudFileId) {
            try {
                // Используем прямой эндпоинт для потокового воспроизведения
                const streamUrl = `/api/yandex/play/${cloudFileId}`;
                
                audioPlayer.src = streamUrl;
                audioPlayer.load();
                audioPlayer.play().catch(err => {
                    console.error('Playback error:', err);
                    showToast('Ошибка воспроизведения', 'error');
                });
                isPlaying = true;
                updatePlayPauseIcon();
            } catch (e) {
                console.error('Error playing cloud track:', e);
                showToast('Ошибка воспроизведения', 'error');
            }
        }
        
        async function downloadCloudFile(fileId, filename) {
            try {
                // Используем прямое скачивание через сервер
                const a = document.createElement('a');
                a.href = `/api/yandex/download/${fileId}`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast('Скачивание началось', 'success');
            } catch (e) {
                showToast('Ошибка скачивания', 'error');
            }
        }
        
        async function previewImage(fileId, filename) {
            try {
                const res = await fetch(`/api/yandex/stream/${fileId}`);
                const data = await res.json();
                
                if (data.url) {
                    document.getElementById('imagePreviewImg').src = data.url;
                    document.getElementById('imagePreviewInfo').textContent = filename;
                    document.getElementById('imagePreviewOverlay').style.display = 'flex';
                } else {
                    showToast(data.error || 'Ошибка загрузки изображения', 'error');
                }
            } catch (e) {
                showToast('Ошибка просмотра', 'error');
            }
        }
        
        function closeImagePreview() {
            document.getElementById('imagePreviewOverlay').style.display = 'none';
            document.getElementById('imagePreviewImg').src = '';
        }
        
        // Закрытие по клику вне изображения
        document.getElementById('imagePreviewOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'imagePreviewOverlay') {
                closeImagePreview();
            }
        });
        
        function connectYandexDisk() {
            window.location.href = '/auth/yandex';
        }
        
        let currentUploadType = 'music';
        
        function selectUploadType(type) {
            currentUploadType = type;
            
            // Обновляем активную кнопку
            document.querySelectorAll('.cloud-upload-type').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Обновляем подсказку и accept
            const hints = {
                music: 'MP3, WAV, OGG, M4A, FLAC',
                image: 'JPG, PNG, GIF, WEBP, SVG',
                document: 'PDF, DOC, DOCX, XLS, XLSX, TXT',
                other: 'Любые файлы до 50 МБ'
            };
            
            const accepts = {
                music: '.mp3,.wav,.ogg,.m4a,.flac',
                image: '.jpg,.jpeg,.png,.gif,.webp,.svg',
                document: '.pdf,.doc,.docx,.xls,.xlsx,.txt,.rtf',
                other: '*'
            };
            
            const hintEl = document.getElementById('cloudAcceptHint');
            const inputEl = document.getElementById('cloudFileInput');
            
            if (hintEl) hintEl.textContent = hints[type];
            if (inputEl) inputEl.accept = accepts[type];
        }
        
        async function disconnectYandexDisk() {
            if (!confirm('Отключить Яндекс.Диск? Файлы на диске останутся, но вы не сможете их воспроизводить.')) return;
            
            try {
                await fetch('/api/yandex/disconnect', { method: 'POST' });
                showToast('Яндекс.Диск отключен', 'success');
                checkYandexDiskStatus();
            } catch (e) {
                showToast('Ошибка отключения', 'error');
            }
        }
        
        function openCloudUploadModal() {
            if (!yandexDiskConnected) {
                showToast('Сначала подключите Яндекс.Диск', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'cloudUploadModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>Загрузить файлы в облако</h2>
                        <button class="icon-btn" onclick="closeModal('cloudUploadModal')"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                    <div class="modal-body">
                        <div class="file-upload" id="cloudDropZone">
                            <div class="file-upload-content">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="var(--primary)" stroke-width="1.5">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                <p style="margin-top: 12px; color: var(--text-secondary);">Перетащите файлы сюда или нажмите для выбора</p>
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">Любые файлы</p>
                                <input type="file" id="cloudFileInput" multiple style="display: none;">
                            </div>
                        </div>
                        <div id="cloudUploadProgress" style="margin-top: 16px; display: none;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span id="cloudUploadFileName">Загрузка...</span>
                                <span id="cloudUploadPercent">0%</span>
                            </div>
                            <div style="height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden;">
                                <div id="cloudUploadBar" style="height: 100%; background: var(--gradient); width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div id="cloudUploadedFiles" style="margin-top: 16px;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Показываем модальное окно
            setTimeout(() => modal.classList.add('show'), 10);
            
            // Обработчики
            const dropZone = document.getElementById('cloudDropZone');
            const fileInput = document.getElementById('cloudFileInput');
            
            dropZone.onclick = (e) => {
                e.stopPropagation();
                fileInput.click();
            };
            fileInput.onchange = (e) => uploadFilesToCloud(e.target.files);
            
            dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
            dropZone.ondragleave = () => dropZone.classList.remove('dragover');
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                uploadFilesToCloud(e.dataTransfer.files);
            };
        }
        
        async function uploadFilesToCloud(files) {
            const progressDiv = document.getElementById('cloudUploadProgress');
            const fileNameEl = document.getElementById('cloudUploadFileName');
            const percentEl = document.getElementById('cloudUploadPercent');
            const barEl = document.getElementById('cloudUploadBar');
            const uploadedDiv = document.getElementById('cloudUploadedFiles');
            
            progressDiv.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                fileNameEl.textContent = file.name;
                percentEl.textContent = '0%';
                barEl.style.width = '0%';
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // Используем XMLHttpRequest для отслеживания прогресса
                    const result = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        
                        // Отслеживаем прогресс загрузки
                        xhr.upload.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                barEl.style.width = percent + '%';
                                percentEl.textContent = percent + '%';
                            }
                        });
                        
                        // Обработка завершения
                        xhr.addEventListener('load', () => {
                            if (xhr.status === 200) {
                                try {
                                    resolve(JSON.parse(xhr.responseText));
                                } catch (e) {
                                    reject(new Error('Ошибка парсинга ответа'));
                                }
                            } else {
                                reject(new Error(`Ошибка ${xhr.status}`));
                            }
                        });
                        
                        // Обработка ошибок
                        xhr.addEventListener('error', () => {
                            reject(new Error('Ошибка сети'));
                        });
                        
                        xhr.addEventListener('abort', () => {
                            reject(new Error('Загрузка отменена'));
                        });
                        
                        // Отправляем запрос
                        xhr.open('POST', '/api/yandex/upload');
                        xhr.send(formData);
                    });
                    
                    if (result.success) {
                        barEl.style.width = '100%';
                        percentEl.textContent = '100%';
                        
                        uploadedDiv.innerHTML += `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 8px;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="#10b981"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                <span>${result.file.title || file.name}</span>
                            </div>
                        `;
                        showToast(`Файл "${result.file.title}" загружен`, 'success');
                    } else {
                        showToast(result.error || 'Ошибка загрузки', 'error');
                    }
                } catch (e) {
                    console.error('Upload error:', e);
                    showToast(`Ошибка загрузки файла: ${e.message}`, 'error');
                    barEl.style.width = '0%';
                    percentEl.textContent = '0%';
                }
                
                // Небольшая задержка между файлами
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            progressDiv.style.display = 'none';
            loadCloudFiles(); // Обновляем список файлов
        }
        
        function renderPlaylists() {
            const container = document.getElementById('playlistsList');
            if (allPlaylists.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div><p>Нет плейлистов. Создайте первый!</p></div>';
                return;
            }
            container.innerHTML = allPlaylists.map(p => `
                <div class="card playlist-card" onclick="openPlaylist(${p.id}, '${p.name}')">
                    <div class="playlist-cover"><svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                    <div class="playlist-name">${p.name}</div>
                    <div class="playlist-meta">${p.tracks_count} ${getTracksWord(p.tracks_count)}</div>
                </div>
            `).join('');
        }
        
        function getTracksWord(n) {
            if (n % 10 === 1 && n % 100 !== 11) return 'трек';
            if ([2,3,4].includes(n % 10) && ![12,13,14].includes(n % 100)) return 'трека';
            return 'треков';
        }
        
        async function openPlaylist(id, name) {
            currentPlaylist = { id, name };
            document.getElementById('tracksTitle').textContent = name;
            document.getElementById('playlistsHeader').style.display = 'none';
            document.getElementById('playlistsList').style.display = 'none';
            document.getElementById('tracksSection').style.display = 'block';
            await loadTracks(id);
        }
        
        function closeTracksSection() {
            document.getElementById('tracksSection').style.display = 'none';
            document.getElementById('playlistsHeader').style.display = 'flex';
            document.getElementById('playlistsList').style.display = 'grid';
            currentPlaylist = null;
        }
        
        async function loadTracks(playlistId) {
            const res = await fetch(`/api/playlists/${playlistId}/tracks`);
            currentTracks = await res.json();
            renderTracks();
        }
        
        function renderTracks() {
            const container = document.getElementById('tracksList');
            if (currentTracks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">🎶</div><p>Плейлист пуст. Добавьте треки!</p></div>';
                return;
            }
            container.innerHTML = currentTracks.map((t, i) => `
                <div class="track-item ${currentTrackIndex === i ? 'playing' : ''}" onclick="playTrack(${i})">
                    <div class="track-number">${currentTrackIndex === i ? (isPlaying ? '<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>' : '<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>') : i + 1}</div>
                    <div class="track-info">
                        <div class="track-title">${t.title}</div>
                        <div class="track-artist">${t.artist || 'Неизвестный исполнитель'}</div>
                    </div>
                    <div class="track-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteTrack(${t.id})" title="Удалить">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function playTrack(index) {
            // Если кликнули на текущий играющий трек — ставим на паузу/продолжаем
            if (currentTrackIndex === index) {
                togglePlay();
                return;
            }
            
            // Получаем выбранный трек
            const selectedTrack = currentTracks[index];
            
            // Если включён shuffle - перемешиваем треки, ставя выбранный первым
            if (shuffleMode) {
                const otherTracks = currentTracks.filter((_, i) => i !== index);
                shuffleArray(otherTracks);
                currentTracks = [selectedTrack, ...otherTracks];
                currentTrackIndex = 0;
            } else {
                currentTrackIndex = index;
            }
            
            const track = currentTracks[currentTrackIndex];
            
            document.getElementById('playerPanel').style.display = 'flex';
            document.getElementById('playerTrackName').textContent = track.title;
            document.getElementById('playerArtist').textContent = track.artist || '';
            
            // Проверяем, облачный ли это файл
            if (track.url.startsWith('cloud:')) {
                // Получаем ссылку на облачный файл
                const cloudFileId = track.url.split(':')[1];
                playCloudTrack(cloudFileId);
            } else {
                // Воспроизводим локальный аудиофайл
                audioPlayer.src = track.url;
                audioPlayer.load();
                audioPlayer.play().catch(err => {
                    console.error('Playback error:', err);
                });
            }
            
            isPlaying = true;
            updatePlayPauseIcon();
            renderTracks();
        }
        
        function updatePlayPauseIcon() {
            const btn = document.getElementById('playPauseBtn');
            if (isPlaying) {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
                btn.title = 'Пауза';
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                btn.title = 'Воспроизвести';
            }
            // Синхронизируем иконку на треке в списке
            renderTracks();
        }
        
        function togglePlay() {
            if (currentTrackIndex === -1 && currentTracks.length > 0) {
                playTrack(0);
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play();
            }
            
            isPlaying = !isPlaying;
            updatePlayPauseIcon();
        }
        
        function nextTrack() {
            if (currentTracks.length === 0) return;
            
            // Режим повтора трека
            if (repeatMode === 'track') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                return;
            }
            
            // Следующий трек
            let nextIndex = currentTrackIndex + 1;
            
            // Если дошли до конца
            if (nextIndex >= currentTracks.length) {
                if (repeatMode === 'playlist') {
                    nextIndex = 0; // Начинаем сначала
                } else {
                    // Останавливаемся на последнем треке
                    isPlaying = false;
                    updatePlayPauseIcon();
                    return;
                }
            }
            
            playTrack(nextIndex);
        }
        
        function prevTrack() {
            if (currentTracks.length === 0) return;
            // Если прошло больше 3 секунд - перемотка в начало, иначе предыдущий трек
            if (audioPlayer.currentTime > 3) {
                audioPlayer.currentTime = 0;
            } else {
                const prevIndex = currentTrackIndex <= 0 ? currentTracks.length - 1 : currentTrackIndex - 1;
                playTrack(prevIndex);
            }
        }
        
        function skipForward() {
            if (audioPlayer.src) {
                audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 5, audioPlayer.duration);
            }
        }
        
        function skipBackward() {
            if (audioPlayer.src) {
                audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 5, 0);
            }
        }
        
        async function deleteTrack(id) {
            const confirmed = await showConfirm('Вы уверены, что хотите удалить этот трек?', 'Удаление трека', { icon: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', danger: true, okText: 'Удалить' });
            if (confirmed) {
                await fetch(`/api/tracks/${id}`, { method: 'DELETE' });
                loadTracks(currentPlaylist.id);
                loadPlaylists();
                showToast('Трек удалён', 'success');
            }
        }
        
        async function deletePlaylist(id) {
            const confirmed = await showConfirm('Вы уверены, что хотите удалить этот плейлист?', 'Удаление плейлиста', { icon: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', danger: true, okText: 'Удалить' });
            if (confirmed) {
                await fetch(`/api/playlists/${id}`, { method: 'DELETE' });
                loadPlaylists();
                showToast('Плейлист удалён', 'success');
            }
        }
        
        // ==================== РАСШИРЕННЫЕ НАСТРОЙКИ ПЛЕЕРА ====================
        let repeatMode = 'none'; // none, track, playlist
        let shuffleMode = false;
        let originalTracksOrder = [];
        let playerVolume = 100;
        
        // Громкость
        function setVolume(value) {
            playerVolume = value;
            audioPlayer.volume = value / 100;
            updateVolumeIcon();
        }
        
        function toggleMute() {
            if (audioPlayer.volume > 0) {
                audioPlayer.dataset.prevVolume = audioPlayer.volume;
                audioPlayer.volume = 0;
                document.getElementById('volumeSlider').value = 0;
            } else {
                audioPlayer.volume = audioPlayer.dataset.prevVolume || 1;
                document.getElementById('volumeSlider').value = audioPlayer.volume * 100;
            }
            updateVolumeIcon();
        }
        
        function updateVolumeIcon() {
            const btn = document.getElementById('volumeBtn');
            let iconPath;
            if (audioPlayer.volume === 0) {
                // Muted
                iconPath = 'M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z';
            } else if (audioPlayer.volume < 0.5) {
                // Low volume
                iconPath = 'M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z';
            } else {
                // High volume
                iconPath = 'M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z';
            }
            btn.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="${iconPath}"/></svg>`;
        }
        
        // Повтор
        function toggleRepeat() {
            const modes = ['none', 'track', 'playlist'];
            const currentIndex = modes.indexOf(repeatMode);
            repeatMode = modes[(currentIndex + 1) % modes.length];
            updateRepeatIcon();
            updateRepeatMenu();
            
            const modeNames = { none: 'Повтор выключен', track: 'Повтор трека', playlist: 'Повтор плейлиста' };
            showToast(modeNames[repeatMode], 'info', 'Режим повтора');
        }
        
        function setRepeatMode(mode) {
            repeatMode = mode;
            updateRepeatIcon();
            updateRepeatMenu();
            closePlayerMenu();
        }
        
        function updateRepeatIcon() {
            const btn = document.getElementById('repeatBtn');
            btn.classList.toggle('active', repeatMode !== 'none');
            let iconPath;
            if (repeatMode === 'track') {
                // Repeat one
                iconPath = 'M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z';
            } else {
                // Repeat all
                iconPath = 'M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z';
            }
            btn.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="${iconPath}"/></svg>`;
        }
        
        function updateRepeatMenu() {
            document.getElementById('repeatNoneCheck').style.display = repeatMode === 'none' ? 'inline' : 'none';
            document.getElementById('repeatTrackCheck').style.display = repeatMode === 'track' ? 'inline' : 'none';
            document.getElementById('repeatPlaylistCheck').style.display = repeatMode === 'playlist' ? 'inline' : 'none';
        }
        
        // Случайный порядок
        function toggleShuffle() {
            shuffleMode = !shuffleMode;
            document.getElementById('shuffleBtn').classList.toggle('active', shuffleMode);
            
            if (shuffleMode) {
                originalTracksOrder = [...currentTracks];
                // Перемешиваем, но оставляем текущий трек на месте
                const currentTrack = currentTracks[currentTrackIndex];
                const otherTracks = currentTracks.filter((_, i) => i !== currentTrackIndex);
                shuffleArray(otherTracks);
                currentTracks = [currentTrack, ...otherTracks];
                currentTrackIndex = 0;
                showToast('Случайный порядок включён', 'info');
                renderTracksWithAnimation();
            } else {
                // Восстанавливаем оригинальный порядок
                const currentTrack = currentTracks[currentTrackIndex];
                currentTracks = [...originalTracksOrder];
                currentTrackIndex = currentTracks.findIndex(t => t.id === currentTrack.id);
                showToast('Случайный порядок выключен', 'info');
                renderTracksWithAnimation();
            }
        }
        
        function renderTracksWithAnimation() {
            const container = document.getElementById('tracksList');
            container.classList.add('shuffling');
            renderTracks();
            setTimeout(() => {
                container.classList.remove('shuffling');
            }, 500);
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // Сортировка
        function sortTracks(mode) {
            if (shuffleMode) {
                shuffleMode = false;
                document.getElementById('shuffleBtn').classList.remove('active');
            }
            
            switch (mode) {
                case 'title':
                    currentTracks.sort((a, b) => a.title.localeCompare(b.title));
                    showToast('Отсортировано по названию', 'info');
                    break;
                case 'artist':
                    currentTracks.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
                    showToast('Отсортировано по исполнителю', 'info');
                    break;
                case 'reverse':
                    currentTracks.reverse();
                    showToast('Обратный порядок', 'info');
                    break;
                case 'default':
                    loadTracks(currentPlaylist.id);
                    showToast('Порядок по умолчанию', 'info');
                    closePlayerMenu();
                    return;
            }
            
            // Обновляем индекс текущего трека
            if (currentTrackIndex >= 0) {
                const currentTrackId = currentTracks[currentTrackIndex]?.id;
                currentTrackIndex = currentTracks.findIndex(t => t.id === currentTrackId);
            }
            
            renderTracks();
            closePlayerMenu();
        }
        
        // Меню настроек
        function togglePlayerMenu() {
            const menu = document.getElementById('playerMenu');
            menu.classList.toggle('show');
            
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closePlayerMenuOnClickOutside);
                }, 10);
            }
        }
        
        function closePlayerMenu() {
            document.getElementById('playerMenu').classList.remove('show');
            document.removeEventListener('click', closePlayerMenuOnClickOutside);
        }
        
        function closePlayerMenuOnClickOutside(e) {
            const menu = document.getElementById('playerMenu');
            const btn = document.getElementById('playerMenuBtn');
            if (!menu.contains(e.target) && e.target !== btn) {
                closePlayerMenu();
            }
        }
        
        // Информация о треке
        function showTrackInfo() {
            if (currentTrackIndex < 0 || !currentTracks[currentTrackIndex]) {
                showToast('Сначала выберите трек', 'warning');
                return;
            }
            
            const track = currentTracks[currentTrackIndex];
            const duration = audioPlayer.duration ? formatTime(audioPlayer.duration) : 'Неизвестно';
            
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-dialog track-info-modal">
                    <div class="confirm-icon"><svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                    <div class="confirm-title">Информация о треке</div>
                    <div style="text-align: left;">
                        <div class="track-info-row">
                            <span class="track-info-label">Название</span>
                            <span class="track-info-value">${escapeHtml(track.title)}</span>
                        </div>
                        <div class="track-info-row">
                            <span class="track-info-label">Исполнитель</span>
                            <span class="track-info-value">${escapeHtml(track.artist || 'Неизвестен')}</span>
                        </div>
                        <div class="track-info-row">
                            <span class="track-info-label">Длительность</span>
                            <span class="track-info-value">${duration}</span>
                        </div>
                        <div class="track-info-row">
                            <span class="track-info-label">Формат</span>
                            <span class="track-info-value">${track.url?.split('.').pop()?.toUpperCase() || 'Неизвестен'}</span>
                        </div>
                    </div>
                    <div class="confirm-buttons" style="margin-top: 20px;">
                        <button class="btn btn-outline" onclick="this.closest('.confirm-overlay').remove()">Закрыть</button>
                        <button class="btn btn-primary" onclick="editCurrentTrack(); this.closest('.confirm-overlay').remove();">Редактировать</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            closePlayerMenu();
        }
        
        // Редактирование трека
        async function editCurrentTrack() {
            if (currentTrackIndex < 0 || !currentTracks[currentTrackIndex]) {
                showToast('Сначала выберите трек', 'warning');
                return;
            }
            
            const track = currentTracks[currentTrackIndex];
            
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-dialog">
                    <div class="confirm-icon">✏️</div>
                    <div class="confirm-title">Редактировать трек</div>
                    <div class="form-group">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-input" id="editTrackTitle" value="${escapeHtml(track.title)}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Исполнитель</label>
                        <input type="text" class="form-input" id="editTrackArtist" value="${escapeHtml(track.artist || '')}">
                    </div>
                    <div class="confirm-buttons">
                        <button class="btn btn-outline" onclick="this.closest('.confirm-overlay').remove()">Отмена</button>
                        <button class="btn btn-primary" onclick="saveTrackEdit(${track.id})">Сохранить</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            document.getElementById('editTrackTitle').focus();
            closePlayerMenu();
        }
        
        async function saveTrackEdit(trackId) {
            const title = document.getElementById('editTrackTitle').value.trim();
            const artist = document.getElementById('editTrackArtist').value.trim();
            
            if (!title) {
                showToast('Название не может быть пустым', 'warning');
                return;
            }
            
            try {
                const res = await fetch(`/api/tracks/${trackId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, artist })
                });
                
                if (res.ok) {
                    // Обновляем локальные данные
                    const track = currentTracks.find(t => t.id === trackId);
                    if (track) {
                        track.title = title;
                        track.artist = artist;
                    }
                    
                    // Обновляем плеер
                    if (currentTracks[currentTrackIndex]?.id === trackId) {
                        document.getElementById('playerTrackName').textContent = title;
                        document.getElementById('playerArtist').textContent = artist;
                    }
                    
                    renderTracks();
                    document.querySelector('.confirm-overlay').remove();
                    showToast('Трек обновлён', 'success');
                } else {
                    await handleApiError(res);
                }
            } catch (err) {
                showToast('Не удалось сохранить изменения', 'error', 'Ошибка сети');
            }
        }
        
        // Обновляем nextTrack с учётом режима повтора
        const originalNextTrack = nextTrack;
        
        // Загрузка файлов
        const fileUpload = document.getElementById('fileUpload');
        const audioFileInput = document.getElementById('audioFile');
        
        let selectedFiles = [];
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleFilesSelect(files);
            }
        });
        
        audioFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFilesSelect(Array.from(e.target.files));
            }
        });
        
        let filesListCollapsed = false;
        
        function handleFilesSelect(files) {
            const allowedExts = ['mp3', 'wav', 'ogg', 'm4a', 'flac'];
            const validFiles = [];
            const invalidFiles = [];
            
            files.forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                if (allowedExts.includes(ext)) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push(file.name);
                }
            });
            
            if (invalidFiles.length > 0) {
                showToast(`Пропущены файлы: ${invalidFiles.join(', ')}`, 'warning', 'Недопустимый формат');
            }
            
            if (validFiles.length === 0) return;
            
            selectedFiles = validFiles;
            
            // Обновляем input
            const dataTransfer = new DataTransfer();
            validFiles.forEach(f => dataTransfer.items.add(f));
            audioFileInput.files = dataTransfer.files;
            
            // Показываем выбранные файлы со сворачиваемым списком
            document.querySelector('.file-upload-content').style.display = 'none';
            const container = document.getElementById('filesSelected');
            container.style.display = 'block';
            
            const filesHtml = validFiles.map((f, i) => `
                <div class="file-item-small">
                    <span class="file-name">${f.name}</span>
                    <button type="button" class="file-remove" onclick="removeFileAt(${i})"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>
            `).join('');
            
            container.innerHTML = `
                <div class="files-selected-header" onclick="toggleFilesList()">
                    <span class="files-selected-count">Выбрано файлов: ${validFiles.length}</span>
                    <span class="files-selected-toggle">${filesListCollapsed ? '▼ Показать' : '▲ Скрыть'}</span>
                </div>
                <div class="files-selected-list ${filesListCollapsed ? 'collapsed' : ''}">
                    ${filesHtml}
                </div>
                <button type="button" class="btn btn-outline" style="width: 100%; margin-top: 8px; padding: 8px;" onclick="removeAllFiles()">Очистить все</button>
            `;
        }
        
        function toggleFilesList() {
            filesListCollapsed = !filesListCollapsed;
            const list = document.querySelector('.files-selected-list');
            const toggle = document.querySelector('.files-selected-toggle');
            if (list) {
                list.classList.toggle('collapsed', filesListCollapsed);
            }
            if (toggle) {
                toggle.textContent = filesListCollapsed ? '▼ Показать' : '▲ Скрыть';
            }
        }
        
        function removeFileAt(index) {
            selectedFiles.splice(index, 1);
            if (selectedFiles.length === 0) {
                removeAllFiles();
            } else {
                handleFilesSelect(selectedFiles);
            }
        }
        
        function removeAllFiles() {
            selectedFiles = [];
            audioFileInput.value = '';
            document.querySelector('.file-upload-content').style.display = 'block';
            document.getElementById('filesSelected').style.display = 'none';
            document.getElementById('filesSelected').innerHTML = '';
        }
        
        // Навигация
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(item.dataset.section + '-section').classList.add('active');
                
                // Загружаем данные для секции прогресса
                if (item.dataset.section === 'progress') {
                    loadProgressData();
                }
                
                // Загружаем данные для секции облака
                if (item.dataset.section === 'cloud') {
                    checkYandexDiskStatus();
                }
            });
        });
        
        // Модальные окна
        function openTaskModal() { 
            loadPlaylistsForTask();
            document.getElementById('taskModal').classList.add('show'); 
        }
        function openNoteModal() { document.getElementById('noteModal').classList.add('show'); }
        function openPlaylistModal() { document.getElementById('playlistModal').classList.add('show'); }
        let currentTrackSource = 'local';
        let selectedCloudTracks = [];
        
        function openTrackModal() { 
            document.getElementById('trackPlaylistId').value = currentPlaylist.id;
            
            // Сбрасываем на локальную загрузку
            switchTrackSource('local');
            
            // Показываем/скрываем опцию облака
            const cloudOption = document.getElementById('uploadToCloudOption');
            const cloudTab = document.getElementById('trackCloudTab');
            if (yandexDiskConnected) {
                cloudOption.style.display = 'flex';
                cloudTab.classList.remove('disabled');
            } else {
                cloudOption.style.display = 'none';
                cloudTab.classList.add('disabled');
            }
            
            document.getElementById('trackModal').classList.add('show'); 
        }
        
        function switchTrackSource(source) {
            if (source === 'cloud' && !yandexDiskConnected) {
                showToast('Сначала подключите Яндекс.Диск в разделе "Облако"', 'warning');
                return;
            }
            
            currentTrackSource = source;
            
            // Обновляем табы
            document.querySelectorAll('.track-source-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.source === source);
            });
            
            // Показываем нужную форму
            document.getElementById('trackLocalUpload').style.display = source === 'local' ? 'block' : 'none';
            document.getElementById('trackCloudSelect').style.display = source === 'cloud' ? 'block' : 'none';
            
            if (source === 'cloud') {
                loadCloudTracksForPlaylist();
            }
        }
        
        async function loadCloudTracksForPlaylist() {
            const container = document.getElementById('trackCloudFiles');
            const statusEl = document.getElementById('trackCloudStatus');
            
            if (!yandexDiskConnected) {
                statusEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Яндекс.Диск не подключен</p>';
                container.innerHTML = '';
                return;
            }
            
            statusEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 10px;">Загрузка...</p>';
            
            try {
                const res = await fetch('/api/yandex/files?type=music');
                const files = await res.json();
                
                selectedCloudTracks = [];
                
                if (files.length === 0) {
                    statusEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Нет музыки в облаке. Загрузите файлы в разделе "Облако".</p>';
                    container.innerHTML = '';
                    return;
                }
                
                statusEl.innerHTML = '';
                container.innerHTML = files.map(file => `
                    <label class="cloud-file-select-item" data-id="${file.id}">
                        <input type="checkbox" onchange="toggleCloudTrack(${file.id}, this.checked)">
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${file.title || file.filename}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${file.artist || 'Неизвестный исполнитель'} • ${formatDuration(file.duration || 0)}
                            </div>
                        </div>
                    </label>
                `).join('');
            } catch (e) {
                statusEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Ошибка загрузки</p>';
            }
        }
        
        function toggleCloudTrack(fileId, checked) {
            if (checked) {
                if (!selectedCloudTracks.includes(fileId)) {
                    selectedCloudTracks.push(fileId);
                }
            } else {
                selectedCloudTracks = selectedCloudTracks.filter(id => id !== fileId);
            }
            
            // Визуальное выделение
            document.querySelectorAll('.cloud-file-select-item').forEach(item => {
                const id = parseInt(item.dataset.id);
                item.classList.toggle('selected', selectedCloudTracks.includes(id));
            });
        }
        
        async function addTracksFromCloud() {
            if (selectedCloudTracks.length === 0) {
                showToast('Выберите треки для добавления', 'warning');
                return;
            }
            
            const playlistId = document.getElementById('trackPlaylistId').value;
            
            try {
                const res = await fetch('/api/playlists/' + playlistId + '/tracks/from-cloud', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_ids: selectedCloudTracks })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`Добавлено ${data.added} треков`, 'success');
                    closeModal('trackModal');
                    // Обновляем список треков, если открыт этот плейлист
                    if (currentPlaylist && currentPlaylist.id == playlistId) {
                        await loadTracks(playlistId);
                    }
                    // Обновляем список плейлистов для обновления счетчика треков
                    await loadPlaylists();
                } else {
                    showToast(data.error || 'Ошибка добавления', 'error');
                }
            } catch (e) {
                console.error('Error adding tracks from cloud:', e);
                showToast('Ошибка добавления треков', 'error');
            }
        }
        
        function closeModal(id) { 
            document.getElementById(id).classList.remove('show'); 
            // Сбрасываем выбор при закрытии
            if (id === 'trackModal') {
                selectedCloudTracks = [];
            }
        }
        
        // Пресеты фокуса
        const focusPresets = {
            pomodoro: { work: 25, break: 5, sessions: 4 },
            deep: { work: 50, break: 10, sessions: 3 },
            short: { work: 15, break: 3, sessions: 6 },
            custom: null
        };
        let selectedPreset = 'pomodoro';
        let selectedTaskAmbient = 'none';
        
        function selectFocusPreset(preset) {
            selectedPreset = preset;
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.preset-btn[data-preset="${preset}"]`).classList.add('active');
            
            const customSettings = document.getElementById('customFocusSettings');
            if (preset === 'custom') {
                customSettings.style.display = 'block';
            } else {
                customSettings.style.display = 'none';
                // Устанавливаем значения из пресета
                const p = focusPresets[preset];
                if (p) {
                    document.querySelector('input[name="work_duration"]').value = p.work;
                    document.querySelector('input[name="break_duration"]').value = p.break;
                    document.querySelector('input[name="sessions_count"]').value = p.sessions;
                }
            }
        }
        
        // Ambient звук в модалке задачи
        document.querySelectorAll('.ambient-select-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ambient-select-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedTaskAmbient = btn.dataset.sound;
                document.querySelector('input[name="ambient_sound"]').value = btn.dataset.sound;
            });
        });
        
        // Загрузка плейлистов в селект задачи
        async function loadPlaylistsForTask() {
            try {
                const res = await fetch('/api/playlists');
                const playlists = await res.json();
                const select = document.querySelector('#taskForm select[name="playlist_id"]');
                select.innerHTML = '<option value="">Без музыки</option>' + 
                    playlists.map(p => `<option value="${p.id}">${p.name} (${p.tracks_count} треков)</option>`).join('');
            } catch (err) {}
        }
        
        // Формы
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Добавляем настройки фокуса
            data.focus_preset = selectedPreset;
            if (selectedPreset !== 'custom') {
                const p = focusPresets[selectedPreset];
                data.timer_minutes = p.work;
                data.break_minutes = p.break;
                data.sessions_count = p.sessions;
            } else {
                data.timer_minutes = parseInt(data.work_duration) || 25;
                data.break_minutes = parseInt(data.break_duration) || 5;
                data.sessions_count = parseInt(data.sessions_count) || 4;
            }
            
            try {
                const res = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('taskModal');
                    e.target.reset();
                    selectFocusPreset('pomodoro'); // Сброс пресета
                    loadTasks();
                    showToast('Задача создана', 'success');
                } else {
                    await handleApiError(res, {
                        400: { title: 'Ошибка', msg: 'Заполните название задачи' }
                    });
                }
            } catch (err) {
                showToast('Не удалось подключиться к серверу', 'error', 'Ошибка сети');
            }
        });
        
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            try {
                const res = await fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('noteModal');
                    e.target.reset();
                    loadNotes();
                    showToast('Заметка сохранена', 'success');
                } else {
                    await handleApiError(res, {
                        400: { title: 'Ошибка', msg: 'Заполните содержимое заметки' }
                    });
                }
            } catch (err) {
                showToast('Не удалось подключиться к серверу', 'error', 'Ошибка сети');
            }
        });
        
        document.getElementById('playlistForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target));
            try {
                const res = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('playlistModal');
                    e.target.reset();
                    loadPlaylists();
                    showToast('Плейлист создан', 'success');
                } else {
                    await handleApiError(res, {
                        400: { title: 'Ошибка', msg: 'Заполните название плейлиста' }
                    });
                }
            } catch (err) {
                showToast('Не удалось подключиться к серверу', 'error', 'Ошибка сети');
            }
        });
        
        document.getElementById('trackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const playlistId = formData.get('playlist_id');
            
            // Показываем прогресс
            const progressEl = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBarUpload');
            const progressText = document.getElementById('progressText');
            progressEl.style.display = 'block';
            
            try {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });
                
                xhr.addEventListener('load', async () => {
                    progressEl.style.display = 'none';
                    progressBar.style.width = '0%';
                    
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        closeModal('trackModal');
                        e.target.reset();
                        
                        // Сбрасываем UI выбора файлов
                        removeAllFiles();
                        
                        // Показываем результат
                        if (result.errors && result.errors.length > 0) {
                            showToast(`Загружено ${result.added_count} треков. Ошибки: ${result.errors.join(', ')}`, 'warning', 'Частичная загрузка');
                        } else {
                            showToast(`Загружено ${result.added_count} треков`, 'success');
                        }
                        
                        // Обновляем список треков текущего плейлиста
                        if (currentPlaylist && currentPlaylist.id) {
                            await loadTracks(currentPlaylist.id);
                        }
                        await loadPlaylists();
                    } else {
                        // Детальные сообщения об ошибках
                        let errorMsg = 'Ошибка загрузки';
                        let errorTitle = 'Ошибка';
                        
                        switch (xhr.status) {
                            case 413:
                                errorMsg = 'Файл слишком большой. Максимальный размер: 500 МБ';
                                errorTitle = 'Превышен лимит размера';
                                break;
                            case 400:
                                errorMsg = 'Неверный формат файла или данных';
                                errorTitle = 'Неверный запрос';
                                break;
                            case 401:
                                errorMsg = 'Необходимо войти в аккаунт';
                                errorTitle = 'Не авторизован';
                                break;
                            case 403:
                                errorMsg = 'Нет доступа к этому плейлисту';
                                errorTitle = 'Доступ запрещён';
                                break;
                            case 404:
                                errorMsg = 'Плейлист не найден';
                                errorTitle = 'Не найдено';
                                break;
                            case 500:
                                errorMsg = 'Внутренняя ошибка сервера. Попробуйте позже';
                                errorTitle = 'Ошибка сервера';
                                break;
                            case 502:
                            case 503:
                            case 504:
                                errorMsg = 'Сервер временно недоступен. Попробуйте позже';
                                errorTitle = 'Сервер недоступен';
                                break;
                            default:
                                try {
                                    const result = JSON.parse(xhr.responseText);
                                    if (result.error) errorMsg = result.error;
                                } catch {}
                        }
                        
                        showToast(errorMsg, 'error', errorTitle);
                    }
                });
                
                xhr.addEventListener('error', () => {
                    showToast('Не удалось подключиться к серверу. Проверьте интернет-соединение', 'error', 'Ошибка сети');
                    progressEl.style.display = 'none';
                });
                
                xhr.addEventListener('timeout', () => {
                    showToast('Превышено время ожидания. Файл слишком большой или соединение медленное', 'error', 'Таймаут');
                    progressEl.style.display = 'none';
                });
                
                xhr.open('POST', `/api/playlists/${playlistId}/tracks`);
                xhr.send(formData);
                
            } catch (err) {
                showToast('Ошибка: ' + err.message, 'error');
                progressEl.style.display = 'none';
            }
        });
        
        async function deleteTask(id) {
            const confirmed = await showConfirm('Вы уверены, что хотите удалить эту задачу?', 'Удаление задачи', { icon: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', danger: true, okText: 'Удалить' });
            if (confirmed) {
                try {
                    const res = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        loadTasks();
                        showToast('Задача удалена', 'success');
                    } else {
                        await handleApiError(res, {
                            404: { title: 'Не найдено', msg: 'Задача уже была удалена' }
                        });
                    }
                } catch (err) {
                    showToast('Не удалось подключиться к серверу', 'error', 'Ошибка сети');
                }
            }
        }
        
        async function deleteNote(id) {
            const confirmed = await showConfirm('Вы уверены, что хотите удалить эту заметку?', 'Удаление заметки', { icon: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', danger: true, okText: 'Удалить' });
            if (confirmed) {
                try {
                    const res = await fetch(`/api/notes/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        loadNotes();
                        showToast('Заметка удалена', 'success');
                    } else {
                        await handleApiError(res, {
                            404: { title: 'Не найдено', msg: 'Заметка уже была удалена' }
                        });
                    }
                } catch (err) {
                    showToast('Не удалось подключиться к серверу', 'error', 'Ошибка сети');
                }
            }
        }
        
        // ==================== РЕЖИМ ФОКУСИРОВКИ ====================
        let focusSettings = { work_duration: 25, short_break: 5, long_break: 15, sessions_before_long_break: 4 };
        let focusTree = { level: 1, experience: 0, health: 100 };
        let focusMode = 'work'; // work, short, long
        let focusSessionId = null;
        let focusSessionCount = 1;
        let focusDistractions = 0;
        let ambientAudio = null;
        let currentAmbientSound = 'none';
        
        // Ambient звуки - локальные файлы
        const ambientSounds = {
            rain: '/uploads/ambient/rain.mp3',
            forest: '/uploads/ambient/forest.mp3',
            waves: '/uploads/ambient/waves.mp3',
            cafe: '/uploads/ambient/cafe.mp3',
            fire: '/uploads/ambient/fire.mp3'
        };
        
        // Web Audio API для генерации белого шума как fallback
        let audioContext = null;
        let noiseNode = null;
        
        function createNoiseGenerator(type) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            
            // Разные типы шума
            if (type === 'rain' || type === 'waves') {
                // Розовый шум (более мягкий)
                let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                    b6 = white * 0.115926;
                }
            } else if (type === 'fire') {
                // Коричневый шум (низкочастотный)
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = output[i];
                    output[i] *= 3.5;
                }
            } else {
                // Белый шум
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
            }
            
            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            // Фильтр для разных звуков
            const filter = audioContext.createBiquadFilter();
            if (type === 'rain') {
                filter.type = 'lowpass';
                filter.frequency.value = 3000;
            } else if (type === 'waves') {
                filter.type = 'lowpass';
                filter.frequency.value = 1500;
            } else if (type === 'fire') {
                filter.type = 'lowpass';
                filter.frequency.value = 500;
            } else if (type === 'forest') {
                filter.type = 'bandpass';
                filter.frequency.value = 2000;
                filter.Q.value = 0.5;
            } else {
                filter.type = 'lowpass';
                filter.frequency.value = 4000;
            }
            
            const gainNode = audioContext.createGain();
            gainNode.gain.value = document.getElementById('ambientVolume').value / 100 * 0.3;
            
            whiteNoise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            return { source: whiteNoise, gain: gainNode };
        }
        
        async function loadFocusData() {
            try {
                const [treeRes, settingsRes, statsRes] = await Promise.all([
                    fetch('/api/focus/tree'),
                    fetch('/api/focus/settings'),
                    fetch('/api/focus/stats')
                ]);
                
                focusTree = await treeRes.json();
                focusSettings = await settingsRes.json();
                const stats = await statsRes.json();
                
                // Проверяем, чахнет ли дерево
                if (focusTree.health_changed && focusTree.health < 50) {
                    setTimeout(() => {
                        showToast('Ваше дерево чахнет без внимания! Начните сессию фокуса.', 'warning');
                    }, 1000);
                }
                
                updateTreeVisual();
                updateFocusStats(stats);
                updateTimerDisplay();
                renderWeeklyChart(stats.week.daily);
                
                // Применяем настройки
                document.getElementById('settingWorkDuration').value = focusSettings.work_duration;
                document.getElementById('settingShortBreak').value = focusSettings.short_break;
                document.getElementById('settingLongBreak').value = focusSettings.long_break;
                document.getElementById('settingSessionsCount').value = focusSettings.sessions_before_long_break;
                document.getElementById('settingBlockNotifications').checked = focusSettings.block_notifications;
                
                // Настройки здоровья
                document.getElementById('settingWaterReminder').checked = focusSettings.water_reminder !== false;
                document.getElementById('settingWaterInterval').value = focusSettings.water_interval || 30;
                document.getElementById('settingEyeReminder').checked = focusSettings.eye_reminder !== false;
                document.getElementById('settingEyeInterval').value = focusSettings.eye_interval || 20;
                
                // Ambient
                if (focusSettings.ambient_sound !== 'none') {
                    setAmbientSound(focusSettings.ambient_sound);
                }
                document.getElementById('ambientVolume').value = focusSettings.ambient_volume;
                
                // Применяем тему
                applyTheme(focusSettings.theme || 'dark');
                
                // Запускаем напоминания о здоровье
                initHealthReminders();
                
                // Загружаем настроение и шаблоны
                loadMoodData();
                loadTemplates();
            } catch (err) {
                console.error('Error loading focus data:', err);
            }
        }
        
        // Переменные для превью дерева
        let treePreviewMode = false;
        let treePreviewLevel = 1;
        let treePreviewHealth = 100;
        let treePreviewGarden = 0;
        
        function previewTreeLevel(val) {
            treePreviewMode = true;
            treePreviewLevel = parseInt(val);
            document.getElementById('treePreviewLevelText').textContent = `Ур. ${val}`;
            updateTreeVisual(false);
        }
        
        function previewTreeHealth(val) {
            treePreviewMode = true;
            treePreviewHealth = parseInt(val);
            document.getElementById('treePreviewHealthText').textContent = `${val}%`;
            document.getElementById('treePreviewHealthText').style.color = val > 60 ? '#22c55e' : (val > 30 ? '#f59e0b' : '#ef4444');
            updateTreeVisual(false);
        }
        
        function previewTreeGarden(val) {
            treePreviewMode = true;
            treePreviewGarden = parseInt(val);
            treePreviewLevel = 10; // Сад только при макс уровне
            document.getElementById('treePreviewLevel').value = 10;
            document.getElementById('treePreviewLevelText').textContent = 'Ур. 10';
            document.getElementById('treePreviewGardenText').textContent = `Сад ${val}`;
            updateTreeVisual(false);
        }
        
        function resetTreePreview() {
            treePreviewMode = false;
            document.getElementById('treePreviewLevel').value = focusTree.level || 1;
            document.getElementById('treePreviewHealth').value = focusTree.health || 100;
            document.getElementById('treePreviewGarden').value = focusTree.garden_level || 0;
            document.getElementById('treePreviewLevelText').textContent = `Ур. ${focusTree.level || 1}`;
            document.getElementById('treePreviewHealthText').textContent = `${focusTree.health || 100}%`;
            document.getElementById('treePreviewGardenText').textContent = `Сад ${focusTree.garden_level || 0}`;
            updateTreeVisual(false);
        }
        
        function updateTreeVisual(animate = false) {
            const container = document.getElementById('treeVisual');
            const level = treePreviewMode ? treePreviewLevel : (focusTree.level || 1);
            const health = treePreviewMode ? treePreviewHealth : (focusTree.health || 100);
            const gardenLevel = treePreviewMode ? treePreviewGarden : (focusTree.garden_level || 0);
            const totalSessions = focusTree.total_sessions || 0;
            
            const healthFactor = health / 100;
            const seed = totalSessions * 7 + level * 13;
            
            // Цвета листьев зависят от здоровья
            const leafHue = 70 + healthFactor * 50; // От жёлто-коричневого до изумрудного
            const leafSat = 40 + healthFactor * 40;
            const leafLight = 20 + healthFactor * 25;
            
            const leafMain = `hsl(${leafHue}, ${leafSat}%, ${leafLight}%)`;
            const leafLight1 = `hsl(${leafHue + 10}, ${leafSat + 15}%, ${leafLight + 25}%)`;
            const leafDark = `hsl(${leafHue - 10}, ${leafSat - 10}%, ${leafLight - 15}%)`;
            const leafGlow = `hsla(${leafHue}, ${leafSat + 20}%, ${leafLight + 30}%, 0.5)`;
            
            // Цвета ствола
            const bark1 = health > 25 ? '#5D4037' : '#4A3728';
            const bark2 = health > 25 ? '#795548' : '#5D4037';
            const bark3 = health > 25 ? '#3E2723' : '#2E1F1A';
            
            // Стадии роста дерева
            const stages = {
                1: { name: 'Росток', trunkH: 30, trunkW: 4, crownR: 15, branches: 0 },
                2: { name: 'Саженец', trunkH: 45, trunkW: 6, crownR: 22, branches: 2 },
                3: { name: 'Молодое дерево', trunkH: 60, trunkW: 8, crownR: 30, branches: 3 },
                4: { name: 'Растущее дерево', trunkH: 75, trunkW: 10, crownR: 38, branches: 4 },
                5: { name: 'Зрелое дерево', trunkH: 88, trunkW: 12, crownR: 45, branches: 5 },
                6: { name: 'Крепкое дерево', trunkH: 100, trunkW: 14, crownR: 52, branches: 6 },
                7: { name: 'Могучее дерево', trunkH: 110, trunkW: 16, crownR: 58, branches: 7 },
                8: { name: 'Древнее дерево', trunkH: 118, trunkW: 18, crownR: 64, branches: 8 },
                9: { name: 'Великое дерево', trunkH: 125, trunkW: 20, crownR: 70, branches: 9 },
                10: { name: 'Мировое дерево', trunkH: 130, trunkW: 22, crownR: 76, branches: 10 }
            };
            
            const stage = stages[level] || stages[1];
            const trunkH = stage.trunkH;
            const trunkW = stage.trunkW;
            const crownR = stage.crownR;
            const numBranches = stage.branches;
            const baseY = 200;
            const crownY = baseY - trunkH - crownR * 0.3;
            
            let svg = '';
            
            // === УРОВЕНЬ 1: Росток ===
            if (level === 1) {
                svg = `
                    <!-- Земля с травой -->
                    <ellipse cx="110" cy="205" rx="40" ry="8" fill="#3d2817"/>
                    <ellipse cx="110" cy="203" rx="35" ry="6" fill="#4a3520"/>
                    
                    <!-- Маленький стебель -->
                    <path d="M110,200 Q108,185 110,${baseY - trunkH}" stroke="${bark2}" stroke-width="3" fill="none"/>
                    
                    <!-- Два первых листочка -->
                    ${health > 20 ? `
                        <ellipse cx="103" cy="${baseY - trunkH + 5}" rx="12" ry="8" fill="url(#leaf1)" transform="rotate(-30 103 ${baseY - trunkH + 5})"/>
                        <ellipse cx="117" cy="${baseY - trunkH + 5}" rx="12" ry="8" fill="url(#leaf2)" transform="rotate(30 117 ${baseY - trunkH + 5})"/>
                        <ellipse cx="110" cy="${baseY - trunkH - 5}" rx="8" ry="10" fill="url(#leaf1)"/>
                    ` : ''}
                `;
            }
            // === УРОВЕНЬ 2: Саженец ===
            else if (level === 2) {
                svg = `
                    <ellipse cx="110" cy="206" rx="45" ry="8" fill="#3d2817"/>
                    
                    <!-- Тонкий ствол -->
                    <path d="M110,200 Q108,175 110,${baseY - trunkH}" stroke="url(#trunk)" stroke-width="${trunkW}" fill="none" stroke-linecap="round"/>
                    
                    <!-- Веточки -->
                    <path d="M110,175 Q95,165 85,170" stroke="${bark2}" stroke-width="2" fill="none"/>
                    <path d="M110,175 Q125,165 135,170" stroke="${bark2}" stroke-width="2" fill="none"/>
                    
                    <!-- Листья -->
                    ${health > 15 ? `
                        <ellipse cx="85" cy="168" rx="15" ry="10" fill="url(#leaf1)" transform="rotate(-20 85 168)"/>
                        <ellipse cx="135" cy="168" rx="15" ry="10" fill="url(#leaf2)" transform="rotate(20 135 168)"/>
                        <ellipse cx="110" cy="${baseY - trunkH - 8}" rx="18" ry="14" fill="url(#leaf1)"/>
                        <ellipse cx="105" cy="${baseY - trunkH - 3}" rx="14" ry="11" fill="url(#leaf2)"/>
                        <ellipse cx="115" cy="${baseY - trunkH - 3}" rx="14" ry="11" fill="url(#leaf1)"/>
                    ` : ''}
                `;
            }
            // === УРОВНИ 3-10: Полноценное дерево ===
            else {
                // Генерация веток
                let branches = '';
                let branchLeaves = '';
                const branchAngles = [-55, 55, -40, 45, -30, 35, -50, 50, -25, 30];
                const branchHeights = [0.7, 0.7, 0.5, 0.5, 0.35, 0.35, 0.25, 0.25, 0.15, 0.15];
                
                for (let i = 0; i < numBranches && i < branchAngles.length; i++) {
                    const angle = branchAngles[i];
                    const heightRatio = branchHeights[i];
                    const branchY = baseY - trunkH * heightRatio;
                    const len = 20 + level * 3 + (10 - i) * 2;
                    const rad = angle * Math.PI / 180;
                    const endX = 110 + Math.sin(rad) * len;
                    const endY = branchY - Math.cos(rad) * len * 0.5;
                    const ctrlX = 110 + Math.sin(rad) * len * 0.6;
                    const ctrlY = branchY - 10;
                    const thickness = Math.max(2, trunkW * 0.4 - i * 0.3);
                    
                    branches += `<path d="M110,${branchY} Q${ctrlX},${ctrlY} ${endX},${endY}" 
                                      stroke="url(#trunk)" stroke-width="${thickness}" fill="none" stroke-linecap="round"/>`;
                    
                    // Листья на ветках
                    if (health > 25) {
                        const leafSize = 10 + level;
                        branchLeaves += `
                            <ellipse cx="${endX}" cy="${endY - 5}" rx="${leafSize}" ry="${leafSize * 0.8}" 
                                     fill="url(#leaf${i % 3 + 1})" opacity="${healthFactor * 0.9}"/>
                        `;
                    }
                }
                
                // Крона - множество слоёв
                let crown = '';
                if (health > 10) {
                    const layers = [
                        { dx: 0, dy: crownR * 0.4, rx: crownR * 1.1, ry: crownR * 0.8 },
                        { dx: -crownR * 0.4, dy: crownR * 0.1, rx: crownR * 0.8, ry: crownR * 0.7 },
                        { dx: crownR * 0.4, dy: crownR * 0.15, rx: crownR * 0.75, ry: crownR * 0.65 },
                        { dx: -crownR * 0.2, dy: -crownR * 0.2, rx: crownR * 0.7, ry: crownR * 0.6 },
                        { dx: crownR * 0.2, dy: -crownR * 0.15, rx: crownR * 0.65, ry: crownR * 0.55 },
                        { dx: 0, dy: -crownR * 0.4, rx: crownR * 0.55, ry: crownR * 0.5 },
                        { dx: -crownR * 0.15, dy: -crownR * 0.55, rx: crownR * 0.4, ry: crownR * 0.35 },
                        { dx: crownR * 0.1, dy: -crownR * 0.6, rx: crownR * 0.3, ry: crownR * 0.28 }
                    ];
                    
                    const numLayers = Math.min(3 + level, layers.length);
                    for (let i = 0; i < numLayers; i++) {
                        const l = layers[i];
                        const opacity = healthFactor * (0.95 - i * 0.05);
                        crown += `<ellipse cx="${110 + l.dx}" cy="${crownY + l.dy}" rx="${l.rx}" ry="${l.ry}" 
                                          fill="url(#leaf${(i % 3) + 1})" opacity="${opacity}"/>`;
                    }
                }
                
                // Декорации для высоких уровней
                let decorations = '';
                
                // Корона для уровня 10
                if (level === 10 && health > 80) {
                    decorations += `
                        <g transform="translate(110, ${crownY - crownR - 15})">
                            <path d="M-12,0 L-8,-12 L0,-5 L8,-12 L12,0 Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
                            <circle cx="-8" cy="-10" r="2" fill="#ef4444"/>
                            <circle cx="0" cy="-5" r="2" fill="#22c55e"/>
                            <circle cx="8" cy="-10" r="2" fill="#10b981"/>
                            <animate attributeName="opacity" values="0.8;1;0.8" dur="2s" repeatCount="indefinite"/>
                        </g>
                    `;
                }
                
                // Падающие листья при низком здоровье
                let fallingLeaves = '';
                if (health < 40) {
                    const numFalling = Math.floor((40 - health) / 8);
                    for (let i = 0; i < numFalling; i++) {
                        const fx = 70 + (seed * (i + 1)) % 80;
                        const fy = 50 + (seed * (i + 2)) % 130;
                        fallingLeaves += `
                            <ellipse cx="${fx}" cy="${fy}" rx="4" ry="6" fill="${leafDark}" opacity="0.5">
                                <animateTransform attributeName="transform" type="translate" 
                                    values="0,0;${5 - i * 2},30;${-3 + i},60" dur="${2 + i * 0.3}s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.6;0.3;0" dur="${2 + i * 0.3}s" repeatCount="indefinite"/>
                            </ellipse>
                        `;
                    }
                }
                
                svg = `
                    <!-- Тень на земле -->
                    <ellipse cx="110" cy="208" rx="${30 + level * 3}" ry="8" fill="rgba(0,0,0,0.2)"/>
                    
                    <!-- Трава -->
                    ${health > 35 ? `
                        <path d="M70,205 Q72,195 75,205" stroke="${leafDark}" stroke-width="2" fill="none"/>
                        <path d="M80,206 Q83,193 86,206" stroke="${leafMain}" stroke-width="2" fill="none"/>
                        <path d="M135,205 Q138,192 141,205" stroke="${leafMain}" stroke-width="2" fill="none"/>
                        <path d="M145,206 Q147,196 150,206" stroke="${leafDark}" stroke-width="2" fill="none"/>
                    ` : ''}
                    
                    <!-- Ствол -->
                    <path d="M${110 - trunkW/2},${baseY} 
                             C${110 - trunkW/2 - 2},${baseY - trunkH * 0.3} ${110 - trunkW/3},${baseY - trunkH * 0.7} ${110},${baseY - trunkH}
                             C${110 + trunkW/3},${baseY - trunkH * 0.7} ${110 + trunkW/2 + 2},${baseY - trunkH * 0.3} ${110 + trunkW/2},${baseY} Z" 
                          fill="url(#trunk)"/>
                    
                    <!-- Текстура коры -->
                    ${level >= 3 ? `
                        <path d="M${107},${baseY - trunkH * 0.3} Q${105},${baseY - trunkH * 0.45} ${107},${baseY - trunkH * 0.6}" 
                              stroke="${bark3}" stroke-width="1.5" fill="none" opacity="0.5"/>
                        <path d="M${113},${baseY - trunkH * 0.5} Q${115},${baseY - trunkH * 0.65} ${112},${baseY - trunkH * 0.8}" 
                              stroke="${bark3}" stroke-width="1" fill="none" opacity="0.4"/>
                    ` : ''}
                    
                    <!-- Корни -->
                    <path d="M${110 - trunkW/2},${baseY} Q${95 - level * 2},${baseY + 8} ${80 - level * 2},${baseY + 3}" 
                          stroke="url(#trunk)" stroke-width="${3 + level * 0.3}" fill="none" stroke-linecap="round"/>
                    <path d="M${110 + trunkW/2},${baseY} Q${125 + level * 2},${baseY + 8} ${140 + level * 2},${baseY + 3}" 
                          stroke="url(#trunk)" stroke-width="${3 + level * 0.3}" fill="none" stroke-linecap="round"/>
                    
                    <!-- Ветки -->
                    ${branches}
                    
                    <!-- Листья на ветках -->
                    ${branchLeaves}
                    
                    <!-- Крона -->
                    ${crown}
                    
                    <!-- Падающие листья -->
                    ${fallingLeaves}
                    
                    <!-- Декорации -->
                    ${decorations}
                    
                `;
            }
            
            // Генерируем растения сада (только при level 10)
            let gardenPlants = '';
            if (level >= 10 && gardenLevel > 0) {
                // Типы растений для сада
                const plantTypes = [
                    // Маленький цветок (уровень 1-3)
                    (x, y, size, hue) => `
                        <g transform="translate(${x}, ${y})">
                            <path d="M0,0 Q-1,-${size*3} 0,-${size*6}" stroke="#4a7c23" stroke-width="1.5" fill="none"/>
                            <circle cx="0" cy="-${size*6}" r="${size*2}" fill="hsl(${hue}, 70%, 60%)"/>
                            <circle cx="0" cy="-${size*6}" r="${size}" fill="#fef08a"/>
                        </g>`,
                    // Тюльпан (уровень 4-6)
                    (x, y, size, hue) => `
                        <g transform="translate(${x}, ${y})">
                            <path d="M0,0 Q1,-${size*4} 0,-${size*8}" stroke="#3d6b1e" stroke-width="2" fill="none"/>
                            <ellipse cx="-${size*1.5}" cy="-${size*8}" rx="${size*1.5}" ry="${size*3}" fill="hsl(${hue}, 75%, 55%)" transform="rotate(-15 -${size*1.5} -${size*8})"/>
                            <ellipse cx="${size*1.5}" cy="-${size*8}" rx="${size*1.5}" ry="${size*3}" fill="hsl(${hue}, 75%, 55%)" transform="rotate(15 ${size*1.5} -${size*8})"/>
                            <ellipse cx="0" cy="-${size*9}" rx="${size}" ry="${size*2.5}" fill="hsl(${hue}, 75%, 50%)"/>
                        </g>`,
                    // Кустик (уровень 7-10)
                    (x, y, size, hue) => `
                        <g transform="translate(${x}, ${y})">
                            <ellipse cx="0" cy="-${size*2}" rx="${size*3}" ry="${size*2.5}" fill="hsl(${hue}, 60%, 35%)"/>
                            <ellipse cx="-${size*1.5}" cy="-${size*3}" rx="${size*2}" ry="${size*2}" fill="hsl(${hue}, 65%, 40%)"/>
                            <ellipse cx="${size*1.5}" cy="-${size*3}" rx="${size*2}" ry="${size*2}" fill="hsl(${hue}, 65%, 40%)"/>
                            <ellipse cx="0" cy="-${size*4}" rx="${size*1.5}" ry="${size*1.5}" fill="hsl(${hue}, 70%, 45%)"/>
                        </g>`,
                    // Гриб (уровень 11-14)
                    (x, y, size, hue) => `
                        <g transform="translate(${x}, ${y})">
                            <rect x="-${size*0.8}" y="-${size*3}" width="${size*1.6}" height="${size*3}" fill="#d4a574" rx="1"/>
                            <ellipse cx="0" cy="-${size*3.5}" rx="${size*2.5}" ry="${size*1.8}" fill="hsl(${hue}, 65%, 45%)"/>
                            <circle cx="-${size}" cy="-${size*4}" r="${size*0.5}" fill="white" opacity="0.7"/>
                            <circle cx="${size*0.8}" cy="-${size*3.2}" r="${size*0.4}" fill="white" opacity="0.7"/>
                        </g>`,
                    // Маленькое деревце (уровень 15-20)
                    (x, y, size, hue) => `
                        <g transform="translate(${x}, ${y})">
                            <rect x="-${size}" y="-${size*6}" width="${size*2}" height="${size*6}" fill="#6b4423" rx="1"/>
                            <ellipse cx="0" cy="-${size*8}" rx="${size*4}" ry="${size*3.5}" fill="hsl(${hue}, 55%, 35%)"/>
                            <ellipse cx="-${size*1.5}" cy="-${size*9}" rx="${size*2.5}" ry="${size*2}" fill="hsl(${hue}, 60%, 40%)"/>
                            <ellipse cx="${size*1.5}" cy="-${size*9}" rx="${size*2.5}" ry="${size*2}" fill="hsl(${hue}, 60%, 40%)"/>
                            <ellipse cx="0" cy="-${size*10}" rx="${size*2}" ry="${size*1.5}" fill="hsl(${hue}, 65%, 45%)"/>
                        </g>`
                ];
                
                // Позиции для растений (слева и справа от дерева)
                const positions = [
                    { x: 25, y: 205 },   // 1 - далеко слева
                    { x: 195, y: 205 },  // 2 - далеко справа
                    { x: 40, y: 207 },   // 3 - слева
                    { x: 180, y: 207 },  // 4 - справа
                    { x: 15, y: 203 },   // 5 - край слева
                    { x: 205, y: 203 },  // 6 - край справа
                    { x: 50, y: 206 },   // 7 - ближе к центру слева
                    { x: 170, y: 206 },  // 8 - ближе к центру справа
                    { x: 30, y: 208 },   // 9
                    { x: 190, y: 208 },  // 10
                    { x: 10, y: 206 },   // 11
                    { x: 210, y: 206 },  // 12
                    { x: 55, y: 204 },   // 13
                    { x: 165, y: 204 },  // 14
                    { x: 20, y: 207 },   // 15
                    { x: 200, y: 207 },  // 16
                    { x: 45, y: 203 },   // 17
                    { x: 175, y: 203 },  // 18
                    { x: 35, y: 205 },   // 19
                    { x: 185, y: 205 },  // 20
                ];
                
                // Цвета для разнообразия
                const hues = [120, 90, 140, 340, 280, 45, 200, 160, 30, 310];
                
                for (let i = 0; i < Math.min(gardenLevel, 20); i++) {
                    const pos = positions[i];
                    // Выбираем тип растения в зависимости от номера
                    let typeIndex;
                    if (i < 3) typeIndex = 0;      // Цветочки
                    else if (i < 6) typeIndex = 1; // Тюльпаны
                    else if (i < 10) typeIndex = 2; // Кустики
                    else if (i < 14) typeIndex = 3; // Грибы
                    else typeIndex = 4;             // Деревца
                    
                    const size = 2 + (i % 3) * 0.5;
                    const hue = hues[i % hues.length];
                    gardenPlants += plantTypes[typeIndex](pos.x, pos.y, size, hue);
                }
            }
            
            // Собираем финальный SVG
            container.innerHTML = `
                <div class="tree-ground"></div>
                <svg viewBox="0 0 220 220" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <!-- Градиент ствола -->
                        <linearGradient id="trunk" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:${bark3}"/>
                            <stop offset="30%" style="stop-color:${bark2}"/>
                            <stop offset="70%" style="stop-color:${bark2}"/>
                            <stop offset="100%" style="stop-color:${bark3}"/>
                        </linearGradient>
                        
                        <!-- Градиенты листьев -->
                        <radialGradient id="leaf1" cx="30%" cy="30%">
                            <stop offset="0%" style="stop-color:${leafLight1}"/>
                            <stop offset="60%" style="stop-color:${leafMain}"/>
                            <stop offset="100%" style="stop-color:${leafDark}"/>
                        </radialGradient>
                        <radialGradient id="leaf2" cx="40%" cy="25%">
                            <stop offset="0%" style="stop-color:${leafLight1}"/>
                            <stop offset="50%" style="stop-color:${leafMain}"/>
                            <stop offset="100%" style="stop-color:${leafDark}"/>
                        </radialGradient>
                        <radialGradient id="leaf3" cx="50%" cy="30%">
                            <stop offset="0%" style="stop-color:${leafLight1}"/>
                            <stop offset="55%" style="stop-color:${leafMain}"/>
                            <stop offset="100%" style="stop-color:${leafDark}"/>
                        </radialGradient>
                        
                        <!-- Фильтр свечения -->
                        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    
                    <!-- Растения сада -->
                    ${gardenPlants}
                    
                    ${svg}
                </svg>
            `;
            
            // Добавляем класс анимации
            if (animate) {
                container.classList.add('growing');
                setTimeout(() => container.classList.remove('growing'), 1500);
            }
            
            // Класс увядания для низкого здоровья
            if (health < 40) {
                container.classList.add('wilting');
            } else {
                container.classList.remove('wilting');
            }
            
            // Обновляем индикаторы (только если не в режиме превью)
            if (!treePreviewMode) {
                document.getElementById('treeHealthFill').style.width = `${health}%`;
                document.getElementById('treeLevel').textContent = level;
                
                const expForNext = level * 100;
                document.getElementById('expFill').style.width = `${(focusTree.experience / expForNext) * 100}%`;
                document.getElementById('expText').textContent = `${focusTree.experience}/${expForNext} XP`;
            } else {
                document.getElementById('treeHealthFill').style.width = `${health}%`;
                document.getElementById('treeLevel').textContent = level;
            }
        }
        
        function updateFocusStats(stats) {
            document.getElementById('statStreak').textContent = stats.all_time?.streak_days || focusTree.streak_days || 0;
            document.getElementById('statTotalMinutes').textContent = stats.all_time?.total_minutes || focusTree.total_focus_minutes || 0;
            document.getElementById('statTotalSessions').textContent = stats.all_time?.total_sessions || focusTree.total_sessions || 0;
            document.getElementById('totalSessions').textContent = focusSettings.sessions_before_long_break;
        }
        
        function renderWeeklyChart(dailyData) {
            const container = document.getElementById('weeklyChart');
            const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            const today = new Date();
            
            let maxMinutes = 10; // Минимум для масштаба
            const weekData = [];
            
            // Собираем данные за последние 7 дней
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = dailyData[dateStr] || { minutes: 0 };
                const dayName = dayNames[date.getDay()];
                const isToday = i === 0;
                
                weekData.push({ 
                    day: dayName, 
                    minutes: dayData.minutes, 
                    date: dateStr,
                    isToday: isToday
                });
                
                if (dayData.minutes > maxMinutes) maxMinutes = dayData.minutes;
            }
            
            container.innerHTML = weekData.map(d => {
                const heightPercent = Math.max(4, (d.minutes / maxMinutes) * 100);
                const todayClass = d.isToday ? 'today' : '';
                const hasData = d.minutes > 0;
                
                return `
                    <div class="chart-bar ${todayClass} ${hasData ? 'has-data' : ''}" 
                         style="height: ${heightPercent}px;" 
                         data-label="${d.day}" 
                         data-value="${d.minutes} мин">
                    </div>
                `;
            }).join('');
        }
        
        function selectTaskForFocus(id, title, minutes, task = null) {
            currentTask = { id, title, minutes, ...task };
            
            // Если задача имеет свои настройки фокуса - применяем их
            if (task && task.focus_preset) {
                focusSettings.work_duration = task.timer_minutes || 25;
                focusSettings.short_break = task.break_minutes || 5;
                document.getElementById('totalSessions').textContent = task.sessions_count || 4;
                
                // Устанавливаем ambient звук
                if (task.ambient_sound && task.ambient_sound !== 'none') {
                    setAmbientSound(task.ambient_sound);
                }
            }
            
            timerSeconds = focusSettings.work_duration * 60;
            focusMode = 'work';
            document.querySelectorAll('.focus-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.focus-tab[data-mode="work"]').classList.add('active');
            
            updateTimerDisplay();
            document.getElementById('focusTaskName').textContent = title;
            
            // Переключаемся на секцию фокуса
            showSection('focus');
        }
        
        function updateTimerDisplay() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Табы режимов
        document.querySelectorAll('.focus-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (timerInterval) return; // Не менять во время работы
                document.querySelectorAll('.focus-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                focusMode = tab.dataset.mode;
                
                const duration = focusMode === 'work' ? focusSettings.work_duration : 
                                 focusMode === 'short' ? focusSettings.short_break : focusSettings.long_break;
                timerSeconds = duration * 60;
                updateTimerDisplay();
            });
        });
        
        async function startFocusTimer() {
            if (timerInterval) {
                pauseFocusTimer();
                return;
            }
            
            const btn = document.getElementById('startTimerBtn');
            btn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg> Пауза';
            
            // Начинаем сессию на сервере
            if (focusMode === 'work' && !focusSessionId) {
                try {
                    const res = await fetch('/api/focus/session/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            task_id: currentTask?.id,
                            duration_minutes: focusSettings.work_duration
                        })
                    });
                    const data = await res.json();
                    focusSessionId = data.session_id;
                    focusDistractions = 0;
                } catch (err) {
                    console.error('Error starting session:', err);
                }
            }
            
            // Блокируем уведомления
            if (focusSettings.block_notifications && 'Notification' in window) {
                // Просто не показываем уведомления во время фокуса
            }
            
            timerRunning = true;
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerRunning = false;
                    onTimerComplete();
                }
            }, 1000);
        }
        
        function pauseFocusTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerRunning = false;
            document.getElementById('startTimerBtn').innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Продолжить';
        }
        
        function resetFocusTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerRunning = false;
            
            const duration = focusMode === 'work' ? focusSettings.work_duration : 
                             focusMode === 'short' ? focusSettings.short_break : focusSettings.long_break;
            timerSeconds = duration * 60;
            updateTimerDisplay();
            document.getElementById('startTimerBtn').innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Начать';
            
            // Отменяем сессию
            if (focusSessionId) {
                endFocusSession(false);
            }
        }
        
        async function onTimerComplete() {
            // Звук завершения
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAA');
                audio.volume = 0.5;
                audio.play().catch(() => {});
            } catch {}
            
            if (focusMode === 'work') {
                // Завершаем рабочую сессию
                await endFocusSession(true);
                
                focusSessionCount++;
                document.getElementById('sessionCount').textContent = focusSessionCount;
                
                // Определяем тип перерыва
                if (focusSessionCount > focusSettings.sessions_before_long_break) {
                    focusSessionCount = 1;
                    focusMode = 'long';
                    showToast('Отличная работа! Время для длинного перерыва', 'success');
                } else {
                    focusMode = 'short';
                    showToast('Сессия завершена! Короткий перерыв', 'success');
                }
                
                // Обновляем UI
                document.querySelectorAll('.focus-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.focus-tab[data-mode="${focusMode}"]`).classList.add('active');
            } else {
                // Перерыв закончился
                focusMode = 'work';
                document.querySelectorAll('.focus-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.focus-tab[data-mode="work"]').classList.add('active');
                showToast('Перерыв окончен! Время работать', 'info');
            }
            
            const duration = focusMode === 'work' ? focusSettings.work_duration : 
                             focusMode === 'short' ? focusSettings.short_break : focusSettings.long_break;
            timerSeconds = duration * 60;
            updateTimerDisplay();
            document.getElementById('startTimerBtn').innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;"><polygon points="5 3 19 12 5 21 5 3"/></svg> Начать';
            
            // Обновляем данные
            loadFocusData();
        }
        
        async function endFocusSession(completed) {
            if (!focusSessionId) return;
            
            try {
                const res = await fetch(`/api/focus/session/${focusSessionId}/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed, distractions: focusDistractions })
                });
                const data = await res.json();
                
                if (completed && data.tree) {
                    focusTree = { ...focusTree, ...data.tree };
                    updateTreeVisual(true); // Анимация роста
                    if (data.tree.exp_gained > 0) {
                        showToast(`+${data.tree.exp_gained} XP для дерева!`, 'success');
                    }
                    
                    // Показываем разблокированные достижения
                    if (data.unlocked && data.unlocked.length > 0) {
                        data.unlocked.forEach((a, i) => {
                            setTimeout(() => showAchievementToast(a), (i + 1) * 3500);
                        });
                    }
                } else if (!completed) {
                    // Дерево чахнет при незавершённой сессии
                    updateTreeVisual(false);
                }
            } catch (err) {
                console.error('Error ending session:', err);
            }
            
            focusSessionId = null;
        }
        
        // Ambient звуки
        document.querySelectorAll('.ambient-btn').forEach(btn => {
            btn.addEventListener('click', () => setAmbientSound(btn.dataset.sound));
        });
        
        function setAmbientSound(sound) {
            document.querySelectorAll('.ambient-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.ambient-btn[data-sound="${sound}"]`)?.classList.add('active');
            
            // Останавливаем текущий звук
            if (ambientAudio) {
                ambientAudio.pause();
                ambientAudio.src = '';
                ambientAudio = null;
            }
            
            // Останавливаем генератор шума
            if (noiseNode) {
                noiseNode.source.stop();
                noiseNode = null;
            }
            
            currentAmbientSound = sound;
            
            if (sound !== 'none') {
                // Используем Web Audio API для генерации звуков
                try {
                    noiseNode = createNoiseGenerator(sound);
                    noiseNode.source.start();
                    showToast(`${getSoundName(sound)}`, 'success');
                } catch (err) {
                    console.error('Ошибка создания звука:', err);
                    showToast('Кликните ещё раз для воспроизведения', 'info');
                }
            }
            
            // Сохраняем настройку
            fetch('/api/focus/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ambient_sound: sound })
            }).catch(() => {});
        }
        
        function getSoundName(sound) {
            const names = {
                rain: 'Дождь',
                forest: 'Лес',
                waves: 'Волны',
                cafe: 'Кафе',
                fire: 'Камин'
            };
            return names[sound] || sound;
        }
        
        document.getElementById('ambientVolume').addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            
            if (ambientAudio) {
                ambientAudio.volume = volume;
            }
            
            // Обновляем громкость для Web Audio API
            if (noiseNode && noiseNode.gain) {
                noiseNode.gain.gain.value = volume * 0.3;
            }
            
            fetch('/api/focus/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ambient_volume: parseInt(e.target.value) })
            }).catch(() => {});
        });
        
        // Полноэкранный режим
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            } else {
                document.exitFullscreen();
            }
        }
        
        // Настройки фокуса
        function openFocusSettings() {
            document.getElementById('focusSettingsModal').classList.add('show');
        }
        
        document.getElementById('focusSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                work_duration: parseInt(document.getElementById('settingWorkDuration').value),
                short_break: parseInt(document.getElementById('settingShortBreak').value),
                long_break: parseInt(document.getElementById('settingLongBreak').value),
                sessions_before_long_break: parseInt(document.getElementById('settingSessionsCount').value),
                block_notifications: document.getElementById('settingBlockNotifications').checked,
                water_reminder: document.getElementById('settingWaterReminder').checked,
                water_interval: parseInt(document.getElementById('settingWaterInterval').value),
                eye_reminder: document.getElementById('settingEyeReminder').checked,
                eye_interval: parseInt(document.getElementById('settingEyeInterval').value)
            };
            
            try {
                await fetch('/api/focus/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                focusSettings = { ...focusSettings, ...settings };
                
                // Обновляем таймер если не запущен
                if (!timerInterval) {
                    const duration = focusMode === 'work' ? settings.work_duration : 
                                     focusMode === 'short' ? settings.short_break : settings.long_break;
                    timerSeconds = duration * 60;
                    updateTimerDisplay();
                }
                
                document.getElementById('totalSessions').textContent = settings.sessions_before_long_break;
                
                // Перезапускаем напоминания о здоровье
                initHealthReminders();
                
                closeModal('focusSettingsModal');
                showToast('Настройки сохранены', 'success');
            } catch (err) {
                showToast('Ошибка сохранения', 'error');
            }
        });
        
        // Отслеживание отвлечений (при потере фокуса окна)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && timerInterval && focusMode === 'work' && focusSessionId) {
                focusDistractions++;
                fetch(`/api/focus/session/${focusSessionId}/distraction`, { method: 'POST' }).catch(() => {});
            }
        });
        
        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }
        
        // ==================== ЧАТЫ ====================
        let allChats = [];
        let currentChat = null;
        let chatMessages = [];
        let chatPollingInterval = null;
        let lastMessageId = 0;
        
        async function loadChats() {
            try {
                const res = await fetch('/api/chats');
                allChats = await res.json();
                renderChatList();
                updateChatBadge();
            } catch (err) {
                console.error('Error loading chats:', err);
            }
        }
        
        function renderChatList() {
            const container = document.getElementById('chatList');
            if (allChats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                        <p>Нет чатов</p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Найдите пользователя для начала общения</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allChats.map(chat => `
                <div class="chat-item ${currentChat && currentChat.id === chat.id ? 'active' : ''}" onclick="openChat(${chat.id})">
                    <div class="chat-avatar" style="${chat.is_group ? 'border-radius: 12px;' : ''}">
                        ${chat.avatar ? `<img src="${chat.avatar}" alt="" style="${chat.is_group ? 'border-radius: 12px;' : ''}">` : 
                            (chat.is_group ? `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5">
                                ${chat.chat_type === 'channel' ? 
                                    '<path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/>' :
                                    '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>'
                                }
                            </svg>` : chat.avatar_letter)
                        }
                    </div>
                    <div class="chat-item-info">
                        <div class="chat-item-header">
                            <span class="chat-item-name">
                                ${chat.chat_type === 'channel' ? '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>' : ''}
                                ${escapeHtml(chat.name)}
                            </span>
                            <span class="chat-item-time">${chat.last_message ? formatChatTime(chat.last_message.created_at) : ''}</span>
                        </div>
                        <div class="chat-item-preview">
                            ${chat.last_message ? (chat.last_message.is_mine ? 'Вы: ' : '') + escapeHtml(chat.last_message.content).substring(0, 50) : (chat.is_group ? (chat.members_count || 0) + ' участников' : 'Нет сообщений')}
                        </div>
                    </div>
                    ${chat.unread_count > 0 ? `<span class="chat-unread">${chat.unread_count}</span>` : ''}
                </div>
            `).join('');
        }
        
        function formatChatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000 && date.getDate() === now.getDate()) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 604800000) {
                return date.toLocaleDateString('ru-RU', { weekday: 'short' });
            } else {
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            }
        }
        
        function formatMessageTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function openChat(chatId) {
            try {
                // Загружаем информацию о чате
                const chatRes = await fetch(`/api/chats/${chatId}`);
                currentChat = await chatRes.json();
                
                // Загружаем сообщения
                const messagesRes = await fetch(`/api/chats/${chatId}/messages`);
                const data = await messagesRes.json();
                chatMessages = data.messages;
                
                if (chatMessages.length > 0) {
                    lastMessageId = chatMessages[chatMessages.length - 1].id;
                }
                
                renderChatMain();
                renderChatList();
                
                // Запускаем polling для новых сообщений
                startChatPolling();
                
                // Обновляем список чатов для сброса счётчика непрочитанных
                loadChats();
            } catch (err) {
                console.error('Error opening chat:', err);
            }
        }
        
        let replyToMessage = null;
        let showProfile = false;
        let userProfile = null;
        
        function renderChatMain() {
            const container = document.getElementById('chatMain');
            
            if (!currentChat) {
                container.innerHTML = `
                    <div class="chat-empty">
                        <div class="chat-empty-icon"><svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                        <p>Выберите чат для начала общения</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="chat-header">
                    <div class="chat-header-clickable" onclick="toggleProfile()">
                        <div class="chat-avatar" style="width: 44px; height: 44px; ${currentChat.is_group ? 'border-radius: 12px;' : ''}">
                            ${currentChat.is_group ? 
                                (currentChat.avatar_url ? `<img src="${currentChat.avatar_url}" alt="" style="border-radius: 12px;">` : 
                                    `<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        ${currentChat.chat_type === 'channel' ? 
                                            '<path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/>' :
                                            '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>'
                                        }
                                    </svg>`) :
                                (currentChat.other_user?.avatar_url ? `<img src="${currentChat.other_user.avatar_url}" alt="">` : (currentChat.name ? currentChat.name[0].toUpperCase() : 'Ч'))
                            }
                        </div>
                        <div class="chat-header-info">
                            <div class="chat-header-name">${escapeHtml(currentChat.name)}</div>
                            <div class="chat-header-status" id="chatStatus">${currentChat.is_group ? 
                                (currentChat.chat_type === 'channel' ? 'Канал' : 'Группа') + ' • ' + (currentChat.members?.length || 0) + ' участников' : 
                                'загрузка...'}</div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-action-btn" onclick="toggleChatSearch()" title="Поиск по чату">
                            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        </button>
                        ${currentChat.is_group && (currentChat.user_role === 'owner' || currentChat.user_role === 'admin') ? `
                        <button class="chat-action-btn" onclick="openChatSettings()" title="Настройки">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                        </button>
                        ` : ''}
                        <div style="position: relative;">
                            <button class="chat-action-btn" onclick="toggleChatMenu()" title="Ещё">
                                <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                            </button>
                            <div class="chat-menu" id="chatMenu">
                                <div class="chat-menu-item" onclick="toggleProfile(); closeChatMenu();">
                                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                    Просмотр профиля
                                </div>
                                ${currentChat.is_group && (currentChat.user_role === 'owner' || currentChat.user_role === 'admin') ? `
                                <div class="chat-menu-item" onclick="openChatSettings(); closeChatMenu();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                    Настройки
                                </div>
                                ` : ''}
                                <div class="chat-menu-item" onclick="toggleChatNotifications(); closeChatMenu();">
                                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                                    Уведомления
                                </div>
                                ${!currentChat.is_group ? `
                                <div class="chat-menu-item" onclick="blockContact(); closeChatMenu();">
                                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/></svg>
                                    Заблокировать
                                </div>
                                ` : ''}
                                <div class="chat-menu-divider"></div>
                                <div class="chat-menu-item danger" onclick="deleteCurrentChat(); closeChatMenu();">
                                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                    ${currentChat.is_group ? 'Выйти из чата' : 'Удалить чат'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-search-panel" id="chatSearchPanel">
                    <input type="text" class="chat-search-input" id="chatMessageSearch" placeholder="Поиск сообщений..." oninput="searchInChat(this.value)">
                </div>
                <div style="display: flex; flex: 1; overflow: hidden;">
                    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <div class="chat-messages" id="chatMessages">
                            ${renderMessages()}
                        </div>
                        ${(() => {
                            const canSend = !currentChat.is_group || currentChat.members_can_send || 
                                currentChat.user_role === 'owner' || currentChat.user_role === 'admin';
                            
                            if (!canSend) {
                                return `<div class="chat-input-area" style="position: relative; justify-content: center;">
                                    <div style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; padding: 12px;">
                                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                        Только администраторы могут писать в этот ${currentChat.chat_type === 'channel' ? 'канал' : 'чат'}
                                    </div>
                                </div>`;
                            }
                            
                            return `<div class="chat-input-area" style="position: relative;">
                                <div id="emojiPickerContainer" class="emoji-picker-container"></div>
                                <button class="emoji-btn" onclick="toggleEmojiPicker()" title="Смайлики и стикеры">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/><line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/></svg>
                                </button>
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <div id="replyPreview" style="display: none;"></div>
                                    <textarea class="chat-input" id="messageInput" placeholder="Написать сообщение..." rows="1" onkeydown="handleMessageKeydown(event)" oninput="handleTyping()"></textarea>
                                </div>
                                <button class="chat-send-btn" onclick="sendMessage()" id="sendBtn">
                                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                </button>
                            </div>`;
                        })()}
                    </div>
                    <div class="profile-panel ${showProfile ? 'show' : ''}" id="profilePanel">
                        <div id="profileContent"></div>
                    </div>
                </div>
            `;
            
            // Прокручиваем к последнему сообщению
            scrollToBottom();
            
            // Автоматическое изменение высоты textarea
            const input = document.getElementById('messageInput');
            input.addEventListener('input', autoResizeTextarea);
            
            // Загружаем статус пользователя
            if (currentChat.other_user) {
                loadUserStatus(currentChat.other_user.id);
            }
            
            // Обновляем превью ответа если есть
            updateReplyPreview();
        }
        
        function renderMessages() {
            if (chatMessages.length === 0) {
                return `
                    <div class="chat-empty" style="flex: 1;">
                        <p style="color: var(--text-secondary);">Начните общение!</p>
                    </div>
                `;
            }
            
            let html = '';
            let lastDate = '';
            
            chatMessages.forEach(msg => {
                const msgDate = new Date(msg.created_at).toLocaleDateString('ru-RU');
                
                // Добавляем разделитель даты
                if (msgDate !== lastDate) {
                    html += `<div class="message-date"><span>${formatDateSeparator(msg.created_at)}</span></div>`;
                    lastDate = msgDate;
                }
                
                const replyHtml = msg.reply_to ? `
                    <div class="message-reply" onclick="scrollToMessage(${msg.reply_to.id})" style="cursor: pointer;">
                        <div class="message-reply-name">${escapeHtml(msg.reply_to.sender_name)}</div>
                        <div class="message-reply-text">${escapeHtml(msg.reply_to.content)}</div>
                    </div>
                ` : '';
                
                const editedHtml = msg.edited_at ? '<span class="message-edited">ред.</span>' : '';
                
                // Проверяем, является ли сообщение стикером (одиночный emoji или кастомный)
                const isSticker = isSingleEmoji(msg.content) || isCustomSticker(msg.content);
                const contentClass = isSticker ? 'sticker-message' : 'message-content';
                
                // Рендерим контент (кастомный стикер или обычный текст)
                let messageContent;
                const customStickerSvg = renderStickerInMessage(msg.content);
                if (customStickerSvg) {
                    messageContent = customStickerSvg;
                } else {
                    messageContent = escapeHtml(msg.content);
                }
                
                html += `
                    <div class="message ${msg.is_mine ? 'message-outgoing' : 'message-incoming'} ${isSticker ? 'sticker-msg' : ''}" 
                         id="message-${msg.id}"
                         data-message-id="${msg.id}"
                         oncontextmenu="showMessageMenu(event, ${msg.id}, ${msg.is_mine}, '${escapeHtml(msg.content).replace(/'/g, "\\'")}', '${escapeHtml(msg.sender_name)}')"
                         ondblclick="replyToMsg(${msg.id}, '${escapeHtml(msg.sender_name)}', '${escapeHtml(msg.content).replace(/'/g, "\\'")}')">
                        ${!msg.is_mine && currentChat.is_group ? `<div class="message-sender">${escapeHtml(msg.sender_name)}</div>` : ''}
                        ${replyHtml}
                        <div class="${contentClass}">${messageContent}</div>
                        <div class="message-time">${formatMessageTime(msg.created_at)}${editedHtml}</div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function formatDateSeparator(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000 && date.getDate() === now.getDate()) {
                return 'Сегодня';
            } else if (diff < 172800000 && date.getDate() === now.getDate() - 1) {
                return 'Вчера';
            } else {
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
            }
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                const container = document.getElementById('chatMessages');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 50);
        }
        
        function scrollToMessage(messageId) {
            event.stopPropagation();
            const messageEl = document.getElementById(`message-${messageId}`);
            const chatMessages = document.getElementById('chatMessages');
            
            if (messageEl && chatMessages) {
                messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Добавляем подсветку на сообщение
                messageEl.classList.add('message-highlight');
                
                // Создаём полосу подсветки внутри области сообщений
                setTimeout(() => {
                    const bar = document.createElement('div');
                    bar.className = 'message-highlight-bar';
                    bar.style.top = (messageEl.offsetTop + messageEl.offsetHeight / 2 - 25) + 'px';
                    chatMessages.appendChild(bar);
                    
                    setTimeout(() => {
                        bar.remove();
                        messageEl.classList.remove('message-highlight');
                    }, 2000);
                }, 300);
            }
        }
        
        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // ==================== EMOJI И СТИКЕРЫ ====================
        // Проверка, является ли строка одиночным emoji (стикером)
        function isSingleEmoji(str) {
            if (!str) return false;
            const trimmed = str.trim();
            // Regex для emoji
            const emojiRegex = /^(?:\p{Emoji_Presentation}|\p{Emoji}\uFE0F)(?:\u200D(?:\p{Emoji_Presentation}|\p{Emoji}\uFE0F))*$/u;
            return emojiRegex.test(trimmed) && [...trimmed].length <= 3;
        }
        
        const emojiData = {
            smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '🥴', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐', '😕', '😟', '🙁', '😮', '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😰', '😥', '😢', '😭', '😱', '😖', '😣', '😞', '😓', '😩', '😫', '🥱', '😤', '😡', '😠', '🤬', '😈', '👿', '💀', '☠️', '💩', '🤡', '👹', '👺', '👻', '👽', '👾', '🤖'],
            gestures: ['👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄'],
            hearts: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '♥️'],
            animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵', '🙈', '🙉', '🙊', '🐔', '🐧', '🐦', '🐤', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷️', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🦙', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐈‍⬛', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊️', '🐇', '🦝', '🦨', '🦡', '🦫', '🦦', '🦥', '🐁', '🐀', '🐿️', '🦔'],
            food: ['🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥪', '🥙', '🧆', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '☕', '🫖', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊'],
            objects: ['⌚', '📱', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '🖲️', '💽', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽️', '🎞️', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🧭', '⏱️', '⏲️', '⏰', '🕰️', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '💸', '💵', '💴', '💶', '💷', '💰', '💳', '💎', '⚖️', '🧰', '🔧', '🔨', '⚒️', '🛠️', '⛏️', '🔩', '⚙️', '🧱', '⛓️', '🧲', '🔫', '💣', '🧨', '🪓', '🔪', '🗡️', '⚔️', '🛡️', '🚬', '⚰️', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳️', '🩹', '🩺', '💊', '💉', '🩸', '🧬', '🦠', '🧫', '🧪'],
            symbols: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💯', '💢', '💥', '💫', '💦', '💨', '🕳️', '💣', '💬', '👁️‍🗨️', '🗨️', '🗯️', '💭', '💤', '🔥', '✨', '🌟', '💫', '⭐', '🌈', '☀️', '🌤️', '⛅', '🌥️', '☁️', '🌦️', '🌧️', '⛈️', '🌩️', '🌨️', '❄️', '☃️', '⛄', '🌬️', '💨', '🌪️', '🌫️', '🌊', '💧', '💦', '☔', '☂️', '🌂', '⚡', '🎉', '🎊', '🎈', '🎁', '🏆', '🥇', '🥈', '🥉', '⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛼', '🛷', '⛸️', '🥌', '🎿', '⛷️', '🏂', '🪂', '🏋️', '🤼', '🤸', '🤺', '⛹️', '🤾', '🏌️', '🏇', '🧘', '🏄', '🏊', '🤽', '🚣', '🧗', '🚵', '🚴', '🎪', '🎭', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🪘', '🎷', '🎺', '🪗', '🎸', '🪕', '🎻', '🎲', '♟️', '🎯', '🎳', '🎮', '🎰', '🧩']
        };
        
        // Кастомные SVG стикеры FocusFlow
        const customStickers = {
            'ff-fire': `<svg viewBox="0 0 64 64"><defs><linearGradient id="fireGrad" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" style="stop-color:#f97316"/><stop offset="50%" style="stop-color:#ef4444"/><stop offset="100%" style="stop-color:#fbbf24"/></linearGradient></defs><path d="M32 4c0 0-16 14-16 32 0 12 8 20 16 24 8-4 16-12 16-24C48 18 32 4 32 4z" fill="url(#fireGrad)"/><ellipse cx="32" cy="44" rx="8" ry="12" fill="#fef3c7"/></svg>`,
            'ff-rocket': `<svg viewBox="0 0 64 64"><defs><linearGradient id="rocketGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#14b8a6"/></linearGradient></defs><path d="M32 4L24 24v20l8 12 8-12V24L32 4z" fill="url(#rocketGrad)"/><path d="M24 32l-8 16 8-4v-12z" fill="#f97316"/><path d="M40 32l8 16-8-4v-12z" fill="#f97316"/><circle cx="32" cy="24" r="4" fill="#fff"/><path d="M28 44l4 16 4-16" fill="#fbbf24"/></svg>`,
            'ff-star': `<svg viewBox="0 0 64 64"><defs><linearGradient id="starGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f97316"/></linearGradient></defs><path d="M32 4l7 20h21l-17 12 7 20-18-13-18 13 7-20L4 24h21z" fill="url(#starGrad)"/></svg>`,
            'ff-heart': `<svg viewBox="0 0 64 64"><defs><linearGradient id="heartGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ec4899"/><stop offset="100%" style="stop-color:#ef4444"/></linearGradient></defs><path d="M32 56S8 40 8 22c0-8 6-14 14-14 5 0 8 2 10 6 2-4 5-6 10-6 8 0 14 6 14 14 0 18-24 34-24 34z" fill="url(#heartGrad)"/></svg>`,
            'ff-trophy': `<svg viewBox="0 0 64 64"><defs><linearGradient id="trophyGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f59e0b"/></linearGradient></defs><path d="M16 8h32v8c0 12-8 20-16 24-8-4-16-12-16-24V8z" fill="url(#trophyGrad)"/><rect x="24" y="40" width="16" height="8" fill="#d97706"/><rect x="20" y="48" width="24" height="8" rx="2" fill="#92400e"/><path d="M8 8h8v8c0 4-4 8-8 8V8z" fill="#fbbf24"/><path d="M48 8h8v16c-4 0-8-4-8-8V8z" fill="#fbbf24"/><circle cx="32" cy="20" r="6" fill="#fff" opacity="0.3"/></svg>`,
            'ff-lightning': `<svg viewBox="0 0 64 64"><defs><linearGradient id="lightGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f97316"/></linearGradient></defs><path d="M36 4L16 32h12l-4 28 24-36H36l4-20z" fill="url(#lightGrad)"/></svg>`,
            'ff-target': `<svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="none" stroke="#ef4444" stroke-width="4"/><circle cx="32" cy="32" r="20" fill="none" stroke="#f97316" stroke-width="4"/><circle cx="32" cy="32" r="12" fill="none" stroke="#fbbf24" stroke-width="4"/><circle cx="32" cy="32" r="4" fill="#10b981"/></svg>`,
            'ff-brain': `<svg viewBox="0 0 64 64"><defs><linearGradient id="brainGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ec4899"/><stop offset="100%" style="stop-color:#8b5cf6"/></linearGradient></defs><path d="M32 56c-12 0-20-8-20-20 0-8 4-14 10-18-2-4-2-10 2-14 4-4 10-4 14 0 4-4 10-4 14 0 4 4 4 10 2 14 6 4 10 10 10 18 0 12-8 20-20 20h-12z" fill="url(#brainGrad)"/><path d="M28 20c0 8 4 16 4 24M36 20c0 8-4 16-4 24" stroke="#fff" stroke-width="2" fill="none" opacity="0.5"/></svg>`,
            'ff-coffee': `<svg viewBox="0 0 64 64"><defs><linearGradient id="coffeeGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#78350f"/><stop offset="100%" style="stop-color:#451a03"/></linearGradient></defs><rect x="12" y="20" width="32" height="36" rx="4" fill="url(#coffeeGrad)"/><path d="M44 28h8c4 0 8 4 8 8s-4 8-8 8h-8" fill="none" stroke="#78350f" stroke-width="4"/><path d="M16 12c2-4 6-4 8 0M24 8c2-4 6-4 8 0M32 12c2-4 6-4 8 0" stroke="#9ca3af" stroke-width="2" fill="none"/></svg>`,
            'ff-moon': `<svg viewBox="0 0 64 64"><defs><linearGradient id="moonGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#14b8a6"/></linearGradient></defs><path d="M40 8c-16 4-24 20-20 36s20 24 36 20c-4 4-12 8-20 8-16 0-28-12-28-28S20 8 36 8c2 0 3 0 4 0z" fill="url(#moonGrad)"/><circle cx="44" cy="20" r="2" fill="#fbbf24"/><circle cx="52" cy="32" r="1.5" fill="#fbbf24"/><circle cx="48" cy="44" r="1" fill="#fbbf24"/></svg>`,
            'ff-timer': `<svg viewBox="0 0 64 64"><defs><linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#14b8a6"/></linearGradient></defs><circle cx="32" cy="36" r="24" fill="url(#timerGrad)"/><rect x="28" y="4" width="8" height="8" rx="2" fill="#10b981"/><line x1="32" y1="36" x2="32" y2="20" stroke="#fff" stroke-width="3" stroke-linecap="round"/><line x1="32" y1="36" x2="44" y2="36" stroke="#fff" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="36" r="3" fill="#fff"/></svg>`,
            'ff-check': `<svg viewBox="0 0 64 64"><defs><linearGradient id="checkGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#059669"/></linearGradient></defs><circle cx="32" cy="32" r="28" fill="url(#checkGrad)"/><path d="M20 32l8 8 16-16" stroke="#fff" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            'ff-thumbsup': `<svg viewBox="0 0 64 64"><defs><linearGradient id="thumbGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#14b8a6"/></linearGradient></defs><path d="M20 28h-8c-2 0-4 2-4 4v24c0 2 2 4 4 4h8V28z" fill="#059669"/><path d="M20 28l8-16c2-4 8-4 8 2v10h16c4 0 6 4 4 8l-6 20c-1 3-4 8-8 8H20V28z" fill="url(#thumbGrad)"/></svg>`,
            'ff-party': `<svg viewBox="0 0 64 64"><defs><linearGradient id="partyGrad" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#f97316"/><stop offset="50%" style="stop-color:#ec4899"/><stop offset="100%" style="stop-color:#8b5cf6"/></linearGradient></defs><path d="M8 56L24 8l8 8-16 48-8-8z" fill="url(#partyGrad)"/><circle cx="44" cy="12" r="4" fill="#fbbf24"/><circle cx="52" cy="24" r="3" fill="#ec4899"/><circle cx="36" cy="20" r="3" fill="#10b981"/><rect x="48" y="36" width="6" height="6" fill="#6366f1" transform="rotate(45 51 39)"/><circle cx="40" cy="44" r="2" fill="#f97316"/></svg>`,
            'ff-gem': `<svg viewBox="0 0 64 64"><defs><linearGradient id="gemGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="50%" style="stop-color:#14b8a6"/><stop offset="100%" style="stop-color:#06b6d4"/></linearGradient></defs><path d="M32 4L8 24l24 36 24-36L32 4z" fill="url(#gemGrad)"/><path d="M32 4L20 24h24L32 4z" fill="#fff" opacity="0.3"/><path d="M20 24L32 60l12-36H20z" fill="#fff" opacity="0.1"/></svg>`,
            'ff-crown': `<svg viewBox="0 0 64 64"><defs><linearGradient id="crownGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f59e0b"/></linearGradient></defs><path d="M8 48V24l12 8 12-20 12 20 12-8v24H8z" fill="url(#crownGrad)"/><circle cx="8" cy="24" r="4" fill="#ef4444"/><circle cx="32" cy="12" r="4" fill="#ef4444"/><circle cx="56" cy="24" r="4" fill="#ef4444"/><rect x="8" y="48" width="48" height="8" fill="#d97706"/></svg>`,
            'ff-tree': `<svg viewBox="0 0 64 64"><defs><linearGradient id="treeGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#059669"/></linearGradient></defs><path d="M32 4L12 28h8L8 48h48L44 28h8L32 4z" fill="url(#treeGrad)"/><rect x="28" y="48" width="8" height="12" fill="#78350f"/></svg>`,
            'ff-music': `<svg viewBox="0 0 64 64"><defs><linearGradient id="musicGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ec4899"/><stop offset="100%" style="stop-color:#8b5cf6"/></linearGradient></defs><circle cx="16" cy="48" r="10" fill="url(#musicGrad)"/><circle cx="48" cy="40" r="10" fill="url(#musicGrad)"/><rect x="24" y="8" width="4" height="40" fill="url(#musicGrad)"/><rect x="56" y="8" width="4" height="32" fill="url(#musicGrad)"/><path d="M24 8h36v8H24z" fill="url(#musicGrad)"/></svg>`,
            'ff-sun': `<svg viewBox="0 0 64 64"><defs><linearGradient id="sunGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f97316"/></linearGradient></defs><circle cx="32" cy="32" r="14" fill="url(#sunGrad)"/><g stroke="#fbbf24" stroke-width="4" stroke-linecap="round"><line x1="32" y1="4" x2="32" y2="12"/><line x1="32" y1="52" x2="32" y2="60"/><line x1="4" y1="32" x2="12" y2="32"/><line x1="52" y1="32" x2="60" y2="32"/><line x1="12" y1="12" x2="18" y2="18"/><line x1="46" y1="46" x2="52" y2="52"/><line x1="12" y1="52" x2="18" y2="46"/><line x1="46" y1="18" x2="52" y2="12"/></g></svg>`,
            'ff-idea': `<svg viewBox="0 0 64 64"><defs><linearGradient id="ideaGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f59e0b"/></linearGradient></defs><path d="M32 4C20 4 12 14 12 24c0 8 4 14 8 18v6c0 2 2 4 4 4h16c2 0 4-2 4-4v-6c4-4 8-10 8-18 0-10-8-20-20-20z" fill="url(#ideaGrad)"/><rect x="24" y="52" width="16" height="4" rx="2" fill="#d97706"/><rect x="24" y="58" width="16" height="4" rx="2" fill="#92400e"/><path d="M28 24v12M36 24v12" stroke="#fff" stroke-width="2" opacity="0.5"/></svg>`,
            'ff-peace': `<svg viewBox="0 0 64 64"><defs><linearGradient id="peaceGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#14b8a6"/></linearGradient></defs><circle cx="32" cy="32" r="28" fill="none" stroke="url(#peaceGrad)" stroke-width="4"/><line x1="32" y1="4" x2="32" y2="60" stroke="url(#peaceGrad)" stroke-width="4"/><line x1="32" y1="32" x2="12" y2="52" stroke="url(#peaceGrad)" stroke-width="4"/><line x1="32" y1="32" x2="52" y2="52" stroke="url(#peaceGrad)" stroke-width="4"/></svg>`,
            'ff-wave': `<svg viewBox="0 0 64 64"><defs><linearGradient id="waveGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fcd34d"/><stop offset="100%" style="stop-color:#f59e0b"/></linearGradient></defs><path d="M12 32c0-12 8-24 20-24 8 0 12 8 12 16 0 6-4 12-8 12s-6-4-6-8c0-2 2-4 4-4" fill="url(#waveGrad)"/><circle cx="20" cy="48" r="4" fill="#f59e0b"/><circle cx="32" cy="52" r="3" fill="#f59e0b"/><circle cx="44" cy="48" r="4" fill="#f59e0b"/><path d="M8 56c4-4 8-4 12 0s8 4 12 0 8-4 12 0 8 4 12 0" stroke="#f59e0b" stroke-width="3" fill="none"/></svg>`,
            'ff-sparkle': `<svg viewBox="0 0 64 64"><defs><linearGradient id="sparkGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#fbbf24"/><stop offset="50%" style="stop-color:#10b981"/><stop offset="100%" style="stop-color:#14b8a6"/></linearGradient></defs><path d="M32 4l4 12 12-4-4 12 12 4-12 4 4 12-12-4-4 12-4-12-12 4 4-12-12-4 12-4-4-12 12 4z" fill="url(#sparkGrad)"/></svg>`,
        };
        
        // Популярные стикеры (кастомные + эмодзи)
        const popularStickers = [
            { type: 'custom', id: 'ff-fire', name: 'Огонь' },
            { type: 'custom', id: 'ff-heart', name: 'Сердце' },
            { type: 'custom', id: 'ff-thumbsup', name: 'Класс' },
            { type: 'custom', id: 'ff-star', name: 'Звезда' },
            { type: 'custom', id: 'ff-party', name: 'Праздник' },
            { type: 'custom', id: 'ff-rocket', name: 'Ракета' },
            { type: 'custom', id: 'ff-check', name: 'Готово' },
            { type: 'custom', id: 'ff-lightning', name: 'Молния' },
        ];
        
        // Категории FocusFlow стикеров
        const focusStickers = {
            motivation: {
                name: '💪 Мотивация',
                stickers: [
                    { type: 'custom', id: 'ff-fire', name: 'Огонь' },
                    { type: 'custom', id: 'ff-rocket', name: 'Ракета' },
                    { type: 'custom', id: 'ff-lightning', name: 'Молния' },
                    { type: 'custom', id: 'ff-trophy', name: 'Трофей' },
                    { type: 'custom', id: 'ff-crown', name: 'Корона' },
                    { type: 'custom', id: 'ff-gem', name: 'Кристалл' },
                    { type: 'custom', id: 'ff-star', name: 'Звезда' },
                    { type: 'custom', id: 'ff-target', name: 'Цель' },
                ]
            },
            focus: {
                name: '🧘 Концентрация',
                stickers: [
                    { type: 'custom', id: 'ff-brain', name: 'Мозг' },
                    { type: 'custom', id: 'ff-timer', name: 'Таймер' },
                    { type: 'custom', id: 'ff-coffee', name: 'Кофе' },
                    { type: 'custom', id: 'ff-moon', name: 'Луна' },
                    { type: 'custom', id: 'ff-target', name: 'Цель' },
                    { type: 'custom', id: 'ff-idea', name: 'Идея' },
                    { type: 'custom', id: 'ff-tree', name: 'Дерево' },
                    { type: 'custom', id: 'ff-music', name: 'Музыка' },
                ]
            },
            success: {
                name: '🎉 Успех',
                stickers: [
                    { type: 'custom', id: 'ff-check', name: 'Готово' },
                    { type: 'custom', id: 'ff-trophy', name: 'Трофей' },
                    { type: 'custom', id: 'ff-party', name: 'Праздник' },
                    { type: 'custom', id: 'ff-star', name: 'Звезда' },
                    { type: 'custom', id: 'ff-crown', name: 'Корона' },
                    { type: 'emoji', value: '🎉', name: 'Конфетти' },
                    { type: 'emoji', value: '🥳', name: 'Праздник' },
                    { type: 'emoji', value: '💯', name: '100' },
                ]
            },
            emotions: {
                name: '💜 Эмоции',
                stickers: [
                    { type: 'custom', id: 'ff-heart', name: 'Сердце' },
                    { type: 'custom', id: 'ff-thumbsup', name: 'Класс' },
                    { type: 'custom', id: 'ff-sparkle', name: 'Искры' },
                    { type: 'custom', id: 'ff-sun', name: 'Солнце' },
                    { type: 'custom', id: 'ff-peace', name: 'Мир' },
                    { type: 'custom', id: 'ff-wave', name: 'Привет' },
                    { type: 'emoji', value: '😊', name: 'Улыбка' },
                    { type: 'emoji', value: '🤗', name: 'Обнимашки' },
                ]
            }
        };
        
        let emojiPickerOpen = false;
        let currentEmojiTab = 'emoji';
        
        // Проверка, является ли строка одиночным эмодзи
        function isSingleEmoji(str) {
            if (!str) return false;
            const emojiRegex = /^(?:\p{Emoji_Presentation}|\p{Emoji}\uFE0F)(?:\u200D(?:\p{Emoji_Presentation}|\p{Emoji}\uFE0F))*$/u;
            return emojiRegex.test(str.trim()) && str.trim().length <= 8;
        }
        
        function toggleEmojiPicker() {
            const container = document.getElementById('emojiPickerContainer');
            emojiPickerOpen = !emojiPickerOpen;
            
            if (emojiPickerOpen) {
                renderEmojiPicker();
                container.classList.add('show');
            } else {
                container.classList.remove('show');
            }
        }
        
        function renderEmojiPicker() {
            const container = document.getElementById('emojiPickerContainer');
            container.innerHTML = `
                <div class="emoji-picker-tabs">
                    <button class="emoji-picker-tab ${currentEmojiTab === 'emoji' ? 'active' : ''}" data-tab="emoji" onclick="switchEmojiTab('emoji', event)">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9" stroke-width="3" stroke-linecap="round"/><line x1="15" y1="9" x2="15.01" y2="9" stroke-width="3" stroke-linecap="round"/></svg>
                        Эмодзи
                    </button>
                    <button class="emoji-picker-tab ${currentEmojiTab === 'stickers' ? 'active' : ''}" data-tab="stickers" onclick="switchEmojiTab('stickers', event)">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                        Стикеры
                    </button>
                </div>
                <div class="emoji-picker-content">
                    ${currentEmojiTab === 'emoji' ? renderEmojiContent() : renderStickerContent()}
                </div>
            `;
        }
        
        function renderEmojiContent() {
            const categories = [
                { key: 'smileys', name: 'Смайлики' },
                { key: 'gestures', name: 'Жесты' },
                { key: 'hearts', name: 'Сердечки' },
                { key: 'animals', name: 'Животные' },
                { key: 'food', name: 'Еда' },
                { key: 'objects', name: 'Объекты' },
                { key: 'symbols', name: 'Символы' }
            ];
            
            return categories.map(cat => `
                <div class="emoji-category">
                    <div class="emoji-category-title">${cat.name}</div>
                    <div class="emoji-grid">
                        ${emojiData[cat.key].slice(0, 24).map(emoji => `
                            <button class="emoji-item" onclick="insertEmoji('${emoji}', event)">${emoji}</button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function renderStickerContent() {
            let html = `
                <div class="emoji-category">
                    <div class="emoji-category-title">⚡ Популярные</div>
                    <div class="sticker-grid">
                        ${popularStickers.map(sticker => renderStickerButton(sticker)).join('')}
                    </div>
                </div>
            `;
            
            // Добавляем категории FocusFlow стикеров
            Object.values(focusStickers).forEach(category => {
                html += `
                    <div class="emoji-category">
                        <div class="emoji-category-title">${category.name}</div>
                        <div class="sticker-grid">
                            ${category.stickers.map(sticker => renderStickerButton(sticker)).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function renderStickerButton(sticker) {
            if (sticker.type === 'custom') {
                return `<button class="sticker-item" onclick="sendSticker('${sticker.id}', event)" title="${sticker.name}">${customStickers[sticker.id]}</button>`;
            } else {
                return `<button class="sticker-item" onclick="sendSticker('${sticker.value}', event)" title="${sticker.name}"><span class="sticker-emoji">${sticker.value}</span></button>`;
            }
        }
        
        function switchEmojiTab(tab, event) {
            if (event) {
                event.stopPropagation();
            }
            currentEmojiTab = tab;
            // Обновляем только содержимое, не перерисовывая весь контейнер
            const content = document.querySelector('.emoji-picker-content');
            if (content) {
                content.innerHTML = currentEmojiTab === 'emoji' ? renderEmojiContent() : renderStickerContent();
            }
            // Обновляем активную вкладку
            document.querySelectorAll('.emoji-picker-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
        }
        
        function insertEmoji(emoji, event) {
            if (event) event.stopPropagation();
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.focus();
        }
        
        function sendSticker(stickerId, event) {
            if (event) event.stopPropagation();
            const input = document.getElementById('messageInput');
            // Если это кастомный стикер (начинается с ff-), отправляем специальный формат
            if (stickerId.startsWith('ff-')) {
                input.value = `[sticker:${stickerId}]`;
            } else {
                input.value = stickerId;
            }
            sendMessage();
            toggleEmojiPicker();
        }
        
        // Функция для рендеринга стикера в сообщении
        function renderStickerInMessage(content) {
            const stickerMatch = content.match(/^\[sticker:(ff-[a-z]+)\]$/);
            if (stickerMatch && customStickers[stickerMatch[1]]) {
                return customStickers[stickerMatch[1]];
            }
            return null;
        }
        
        // Проверка, является ли сообщение кастомным стикером
        function isCustomSticker(content) {
            return /^\[sticker:ff-[a-z]+\]$/.test(content) && customStickers[content.match(/ff-[a-z]+/)?.[0]];
        }
        
        // Закрытие emoji picker при клике вне его
        document.addEventListener('click', (e) => {
            const container = document.getElementById('emojiPickerContainer');
            const btn = e.target.closest('.emoji-btn');
            if (container && emojiPickerOpen && !container.contains(e.target) && !btn) {
                emojiPickerOpen = false;
                container.classList.remove('show');
            }
        });
        
        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChat) return;
            
            // Проверяем права на отправку сообщений
            if (currentChat.is_group) {
                const canSend = currentChat.members_can_send || 
                    currentChat.user_role === 'owner' || 
                    currentChat.user_role === 'admin';
                
                if (!canSend) {
                    showToast('Вы не можете отправлять сообщения в этот чат', 'error');
                    return;
                }
            }
            
            input.value = '';
            input.style.height = 'auto';
            
            const messageData = { content };
            if (replyToMessage) {
                messageData.reply_to_id = replyToMessage.id;
            }
            
            // Сбрасываем ответ
            cancelReply();
            
            try {
                const res = await fetch(`/api/chats/${currentChat.id}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });
                
                if (res.ok) {
                    const data = await res.json();
                    
                    if (data.success) {
                        chatMessages.push(data.message);
                        lastMessageId = data.message.id;
                        
                        // Обновляем только сообщения
                        document.getElementById('chatMessages').innerHTML = renderMessages();
                        scrollToBottom();
                        
                        // Обновляем список чатов
                        loadChats();
                    }
                } else {
                    await handleApiError(res, {
                        400: { title: 'Ошибка', msg: 'Сообщение не может быть пустым' },
                        404: { title: 'Не найдено', msg: 'Чат был удалён' }
                    });
                }
            } catch (err) {
                showToast('Не удалось отправить сообщение', 'error', 'Ошибка сети');
            }
        }
        
        // Ответ на сообщение
        function replyToMsg(msgId, senderName, content) {
            replyToMessage = { id: msgId, sender_name: senderName, content: content };
            updateReplyPreview();
            document.getElementById('messageInput').focus();
        }
        
        function updateReplyPreview() {
            const preview = document.getElementById('replyPreview');
            if (!preview) return;
            
            if (replyToMessage) {
                preview.style.display = 'flex';
                preview.innerHTML = `
                    <div class="reply-preview">
                        <div class="reply-preview-content">
                            <div class="reply-preview-name">${escapeHtml(replyToMessage.sender_name)}</div>
                            <div class="reply-preview-text">${escapeHtml(replyToMessage.content)}</div>
                        </div>
                        <button class="reply-cancel" onclick="cancelReply()"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                `;
            } else {
                preview.style.display = 'none';
                preview.innerHTML = '';
            }
        }
        
        function cancelReply() {
            replyToMessage = null;
            updateReplyPreview();
        }
        
        // Контекстное меню сообщения
        let contextMenu = null;
        
        function showMessageMenu(e, msgId, isMine, content, senderName) {
            e.preventDefault();
            hideMessageMenu();
            
            contextMenu = document.createElement('div');
            contextMenu.className = 'message-context-menu show';
            contextMenu.innerHTML = `
                <div class="context-menu-item" onclick="replyToMsg(${msgId}, '${senderName}', '${content}'); hideMessageMenu();">
                    <span><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg></span> Ответить
                </div>
                <div class="context-menu-item" onclick="copyMessage('${content}'); hideMessageMenu();">
                    <span><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span> Копировать
                </div>
                ${isMine ? `
                    <div class="context-menu-item" onclick="editMessage(${msgId}, '${content}'); hideMessageMenu();">
                        <span><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> Редактировать
                    </div>
                    <div class="context-menu-item danger" onclick="deleteMessage(${msgId}); hideMessageMenu();">
                        <span><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></span> Удалить
                    </div>
                ` : ''}
            `;
            
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            document.body.appendChild(contextMenu);
            
            // Закрываем по клику вне меню
            setTimeout(() => {
                document.addEventListener('click', hideMessageMenu, { once: true });
            }, 10);
        }
        
        function hideMessageMenu() {
            if (contextMenu) {
                contextMenu.remove();
                contextMenu = null;
            }
        }
        
        function copyMessage(content) {
            navigator.clipboard.writeText(content);
        }
        
        async function deleteMessage(msgId) {
            const confirmed = await showConfirm('Удалить это сообщение?', 'Удаление', { icon: '<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>', danger: true, okText: 'Удалить' });
            if (!confirmed) return;
            
            try {
                await fetch(`/api/chats/${currentChat.id}/messages/${msgId}`, { method: 'DELETE' });
                chatMessages = chatMessages.filter(m => m.id !== msgId);
                document.getElementById('chatMessages').innerHTML = renderMessages();
            } catch (err) {
                console.error('Error deleting message:', err);
            }
        }
        
        async function editMessage(msgId, oldContent) {
            const newContent = await showPrompt('Редактировать сообщение', oldContent);
            if (!newContent || newContent === oldContent) return;
            
            try {
                const res = await fetch(`/api/chats/${currentChat.id}/messages/${msgId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: newContent })
                });
                
                if (res.ok) {
                    const msg = chatMessages.find(m => m.id === msgId);
                    if (msg) {
                        msg.content = newContent;
                        msg.edited_at = new Date().toISOString();
                    }
                    document.getElementById('chatMessages').innerHTML = renderMessages();
                    showToast('Сообщение отредактировано', 'success');
                } else {
                    await handleApiError(res);
                }
            } catch (err) {
                showToast('Не удалось отредактировать сообщение', 'error', 'Ошибка сети');
            }
        }
        
        // Профиль пользователя
        async function toggleProfile() {
            showProfile = !showProfile;
            const panel = document.getElementById('profilePanel');
            
            if (showProfile) {
                panel.classList.add('show');
                if (currentChat.is_group) {
                    renderGroupProfile();
                } else if (currentChat.other_user) {
                    await loadUserProfile(currentChat.other_user.id);
                }
            } else {
                panel.classList.remove('show');
            }
        }
        
        function renderGroupProfile() {
            const container = document.getElementById('profileContent');
            if (!currentChat) return;
            
            const isOwner = currentChat.owner_id === currentUser.id;
            const isAdmin = currentChat.user_role === 'admin';
            const canManage = isOwner || isAdmin;
            
            container.innerHTML = `
                <div class="profile-avatar-large" style="border-radius: 16px;">
                    ${currentChat.avatar_url ? `<img src="${currentChat.avatar_url}" alt="" style="border-radius: 16px;">` : `
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                            ${currentChat.chat_type === 'channel' ? 
                                '<path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/>' :
                                '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>'
                            }
                        </svg>
                    `}
                </div>
                <div class="profile-name-large">${escapeHtml(currentChat.name)}</div>
                <div class="profile-username-large" style="color: var(--text-secondary);">
                    ${currentChat.chat_type === 'channel' ? 'Канал' : 'Группа'} • ${currentChat.members?.length || 0} участников
                </div>
                ${currentChat.username ? `<div class="profile-username-large">@${currentChat.username}</div>` : ''}
                ${currentChat.description ? `<div class="profile-bio">${escapeHtml(currentChat.description)}</div>` : ''}
                
                <div class="profile-info-section">
                    <div class="profile-info-item">
                        <span class="profile-info-label">Тип</span>
                        <span>${currentChat.is_public ? 'Публичный' : 'Приватный'}</span>
                    </div>
                    ${currentChat.is_work_chat ? `
                    <div class="profile-info-item">
                        <span class="profile-info-label">Рабочий чат</span>
                        <span style="color: var(--primary-light);">Да</span>
                    </div>
                    ` : ''}
                    ${currentChat.slow_mode > 0 ? `
                    <div class="profile-info-item">
                        <span class="profile-info-label">Медленный режим</span>
                        <span>${formatSlowMode(currentChat.slow_mode)}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${canManage ? `
                <button class="btn btn-outline" style="width: 100%; margin-top: 16px;" onclick="openChatSettings()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                    Настройки
                </button>
                ` : ''}
                
                <div class="profile-members-section" style="margin-top: 20px;">
                    <div class="profile-section-title">Участники (${currentChat.members?.length || 0})</div>
                    <div class="profile-members-list">
                        ${(currentChat.members || []).slice(0, 10).map(m => `
                            <div class="profile-member-item">
                                <div class="member-avatar-small">
                                    ${m.avatar_url ? `<img src="${m.avatar_url}" alt="">` : (m.name || m.username)[0].toUpperCase()}
                                </div>
                                <span>${escapeHtml(m.name || m.username)}</span>
                            </div>
                        `).join('')}
                        ${(currentChat.members?.length || 0) > 10 ? `
                            <div class="profile-member-item" style="color: var(--primary-light); cursor: pointer;" onclick="openChatSettings(); switchSettingsTab('members');">
                                Показать всех...
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        function formatSlowMode(seconds) {
            if (seconds < 60) return seconds + ' сек';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' мин';
            return Math.floor(seconds / 3600) + ' ч';
        }
        
        let userPinnedPlaylist = null;
        
        async function loadUserProfile(userId) {
            try {
                const res = await fetch(`/api/users/${userId}/profile`);
                userProfile = await res.json();
                
                // Загружаем закреплённый плейлист
                try {
                    console.log('Loading pinned playlist for user:', userId);
                    const playlistRes = await fetch(`/api/users/${userId}/pinned-playlist`);
                    console.log('Playlist response status:', playlistRes.status);
                    if (playlistRes.ok) {
                        const data = await playlistRes.json();
                        console.log('Playlist data:', data);
                        userPinnedPlaylist = data.playlist;
                    } else {
                        console.log('Playlist response not ok');
                        userPinnedPlaylist = null;
                    }
                } catch (e) {
                    console.error('Error loading playlist:', e);
                    userPinnedPlaylist = null;
                }
                
                renderProfile();
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }
        
        function renderProfile() {
            const container = document.getElementById('profileContent');
            if (!userProfile) return;
            
            let pinnedPlaylistHtml = '';
            if (userPinnedPlaylist && userPinnedPlaylist.tracks && userPinnedPlaylist.tracks.length > 0) {
                const firstTrack = userPinnedPlaylist.tracks[0];
                pinnedPlaylistHtml = `
                    <div class="profile-pinned-playlist" onclick="openUserPlaylist()">
                        <div class="pinned-playlist-icon"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                        <div class="pinned-playlist-info">
                            <div class="pinned-playlist-name">${escapeHtml(userPinnedPlaylist.name)}</div>
                            <div class="pinned-playlist-track">${escapeHtml(firstTrack.title)} • ${userPinnedPlaylist.tracks.length} треков</div>
                        </div>
                        <button class="pinned-play-btn" onclick="event.stopPropagation(); playUserPlaylist();">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="profile-avatar-large">
                    ${userProfile.avatar_url ? `<img src="${userProfile.avatar_url}" alt="">` : (userProfile.name || userProfile.username)[0].toUpperCase()}
                </div>
                <div class="profile-name-large">${escapeHtml(userProfile.name || userProfile.username)}</div>
                <div class="profile-username-large">@${userProfile.username}</div>
                <div class="profile-status">
                    <span class="status-dot ${userProfile.is_online ? 'online' : ''}"></span>
                    <span>${userProfile.last_seen_text}</span>
                </div>
                ${userProfile.bio ? `<div class="profile-bio">${escapeHtml(userProfile.bio)}</div>` : ''}
                ${pinnedPlaylistHtml}
                <div class="profile-info-item">
                    <span class="profile-info-label">Зарегистрирован</span>
                    <span>${new Date(userProfile.created_at).toLocaleDateString('ru-RU')}</span>
                </div>
            `;
        }
        
        function playUserPlaylist() {
            if (!userPinnedPlaylist || !userPinnedPlaylist.tracks || userPinnedPlaylist.tracks.length === 0) {
                showToast('Плейлист пуст', 'error');
                return;
            }
            
            // Загружаем треки в плеер
            currentPlaylistTracks = userPinnedPlaylist.tracks;
            currentTrackIndex = 0;
            playTrackByIndex(0);
            showToast(`Воспроизводится: ${userPinnedPlaylist.name}`);
        }
        
        function playUserTrack(index) {
            if (!userPinnedPlaylist || !userPinnedPlaylist.tracks) return;
            currentPlaylistTracks = userPinnedPlaylist.tracks;
            currentTrackIndex = index;
            playTrackByIndex(index);
        }
        
        function openUserPlaylist() {
            if (!userProfile || !userPinnedPlaylist) return;
            window.open(`/playlist/${userProfile.id}/${userPinnedPlaylist.id}`, '_blank');
        }
        
        async function loadUserStatus(userId) {
            try {
                const res = await fetch(`/api/users/${userId}/profile`);
                const profile = await res.json();
                const statusEl = document.getElementById('chatStatus');
                if (statusEl) {
                    statusEl.innerHTML = profile.is_online 
                        ? '<span style="color: #22c55e;">в сети</span>' 
                        : profile.last_seen_text;
                }
            } catch (err) {
                console.error('Error loading status:', err);
            }
        }
        
        // Индикатор печати
        let typingTimeout = null;
        
        function handleTyping() {
            // Отправляем статус печатания
            if (currentChat) {
                fetch(`/api/chats/${currentChat.id}/typing`, { method: 'POST' });
            }
        }
        
        // Пинг онлайн-статуса
        setInterval(() => {
            fetch('/api/ping', { method: 'POST' });
        }, 60000);
        
        function startChatPolling() {
            stopChatPolling();
            chatPollingInterval = setInterval(pollNewMessages, 2000);
        }
        
        function stopChatPolling() {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
        }
        
        async function pollNewMessages() {
            if (!currentChat) return;
            
            try {
                const res = await fetch(`/api/chats/${currentChat.id}/messages`);
                const data = await res.json();
                
                // Проверяем, есть ли новые сообщения
                if (data.messages.length > 0) {
                    const newLastId = data.messages[data.messages.length - 1].id;
                    if (newLastId !== lastMessageId) {
                        chatMessages = data.messages;
                        lastMessageId = newLastId;
                        document.getElementById('chatMessages').innerHTML = renderMessages();
                        scrollToBottom();
                    }
                }
                
                // Также обновляем список чатов для бейджей
                loadChats();
            } catch (err) {
                console.error('Error polling messages:', err);
            }
        }
        
        async function deleteCurrentChat() {
            if (!currentChat) return;
            
            const isGroup = currentChat.is_group;
            const isOwner = currentChat.owner_id === currentUser.id;
            
            let confirmMsg, confirmTitle, confirmBtn;
            if (isGroup) {
                if (isOwner) {
                    confirmMsg = 'Вы владелец этой группы. Если вы выйдете, группа будет удалена для всех участников.';
                    confirmTitle = 'Удалить группу';
                    confirmBtn = 'Удалить';
                } else {
                    confirmMsg = 'Вы уверены, что хотите покинуть эту группу?';
                    confirmTitle = 'Выйти из группы';
                    confirmBtn = 'Выйти';
                }
            } else {
                confirmMsg = 'Вы уверены, что хотите удалить этот чат?';
                confirmTitle = 'Удаление чата';
                confirmBtn = 'Удалить';
            }
            
            const confirmed = await showConfirm(confirmMsg, confirmTitle, { danger: true, okText: confirmBtn });
            if (confirmed) {
                try {
                    const res = await fetch(`/api/chats/${currentChat.id}`, { method: 'DELETE' });
                    if (res.ok) {
                        currentChat = null;
                        stopChatPolling();
                        renderChatMain();
                        loadChats();
                        showToast(isGroup && !isOwner ? 'Вы покинули группу' : 'Чат удалён', 'success');
                    } else {
                        await handleApiError(res, {
                            404: { title: 'Не найдено', msg: 'Чат уже был удалён' }
                        });
                    }
                } catch (err) {
                    showToast('Не удалось подключиться к серверу', 'error', 'Ошибка сети');
                }
            }
        }
        
        // Меню чата (три точки)
        function toggleChatMenu() {
            const menu = document.getElementById('chatMenu');
            menu.classList.toggle('show');
            if (menu.classList.contains('show')) {
                setTimeout(() => document.addEventListener('click', closeChatMenuOnClickOutside), 10);
            }
        }
        
        function closeChatMenu() {
            const menu = document.getElementById('chatMenu');
            if (menu) menu.classList.remove('show');
            document.removeEventListener('click', closeChatMenuOnClickOutside);
        }
        
        function closeChatMenuOnClickOutside(e) {
            const menu = document.getElementById('chatMenu');
            if (menu && !menu.contains(e.target) && !e.target.closest('.chat-action-btn')) {
                closeChatMenu();
            }
        }
        
        // Поиск по чату
        function toggleChatSearch() {
            const panel = document.getElementById('chatSearchPanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                document.getElementById('chatMessageSearch').focus();
            }
        }
        
        function searchInChat(query) {
            if (!query.trim()) {
                document.getElementById('chatMessages').innerHTML = renderMessages();
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            const filtered = chatMessages.filter(msg => 
                msg.content.toLowerCase().includes(lowerQuery)
            );
            
            // Подсвечиваем найденные сообщения
            const container = document.getElementById('chatMessages');
            const messages = container.querySelectorAll('.message');
            messages.forEach(msg => {
                const content = msg.querySelector('.message-content');
                if (content && content.textContent.toLowerCase().includes(lowerQuery)) {
                    msg.style.background = 'rgba(99, 102, 241, 0.3)';
                } else {
                    msg.style.background = '';
                }
            });
        }
        
        // Уведомления чата
        function toggleChatNotifications() {
            showToast('Уведомления отключены для этого чата', 'info');
        }
        
        // Блокировка контакта
        async function blockContact() {
            if (!currentChat?.other_user) return;
            
            const confirmed = await showConfirm(
                `Заблокировать ${currentChat.name}? Вы не сможете получать от него сообщения.`,
                'Блокировка',
                { danger: true, okText: 'Заблокировать' }
            );
            
            if (confirmed) {
                showToast(`${currentChat.name} заблокирован`, 'success');
            }
        }
        
        // Поиск пользователей для нового чата
        const chatSearchInput = document.getElementById('chatSearch');
        const userSearchResults = document.getElementById('userSearchResults');
        let searchTimeout = null;
        
        chatSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                userSearchResults.classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(() => searchUsers(query), 300);
        });
        
        chatSearchInput.addEventListener('blur', () => {
            setTimeout(() => userSearchResults.classList.remove('show'), 200);
        });
        
        async function searchUsers(query) {
            try {
                const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                const users = await res.json();
                
                if (users.length === 0) {
                    userSearchResults.innerHTML = '<div style="padding: 16px; color: var(--text-secondary); text-align: center;">Пользователи не найдены</div>';
                } else {
                    userSearchResults.innerHTML = users.map(user => `
                        <div class="user-result-item" onclick="startChatWithUser(${user.id})">
                            <div class="user-result-avatar">
                                ${user.avatar_url ? `<img src="${user.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (user.name || user.username)[0].toUpperCase()}
                            </div>
                            <div class="user-result-info">
                                <div class="user-result-name">${escapeHtml(user.name || user.username)}</div>
                                <div class="user-result-username">@${user.username}</div>
                            </div>
                        </div>
                    `).join('');
                }
                
                userSearchResults.classList.add('show');
            } catch (err) {
                console.error('Error searching users:', err);
            }
        }
        
        async function startChatWithUser(userId) {
            try {
                const res = await fetch('/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    chatSearchInput.value = '';
                    userSearchResults.classList.remove('show');
                    await loadChats();
                    openChat(data.id);
                }
            } catch (err) {
                console.error('Error starting chat:', err);
            }
        }
        
        // Модальное окно нового чата
        function openNewChatModal() {
            document.getElementById('newChatModal').classList.add('show');
            document.getElementById('newChatUserSearch').value = '';
            document.getElementById('newChatUserResults').innerHTML = '';
        }
        
        const newChatUserSearch = document.getElementById('newChatUserSearch');
        let newChatSearchTimeout = null;
        
        newChatUserSearch.addEventListener('input', (e) => {
            clearTimeout(newChatSearchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('newChatUserResults').innerHTML = '';
                return;
            }
            
            newChatSearchTimeout = setTimeout(() => searchUsersForNewChat(query), 300);
        });
        
        async function searchUsersForNewChat(query) {
            try {
                const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                const users = await res.json();
                const container = document.getElementById('newChatUserResults');
                
                if (users.length === 0) {
                    container.innerHTML = '<div style="padding: 16px; color: var(--text-secondary); text-align: center;">Пользователи не найдены</div>';
                } else {
                    container.innerHTML = users.map(user => `
                        <div class="user-result-item" onclick="startChatFromModal(${user.id})">
                            <div class="user-result-avatar">
                                ${user.avatar_url ? `<img src="${user.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (user.name || user.username)[0].toUpperCase()}
                            </div>
                            <div class="user-result-info">
                                <div class="user-result-name">${escapeHtml(user.name || user.username)}</div>
                                <div class="user-result-username">@${user.username}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error searching users:', err);
            }
        }
        
        async function startChatFromModal(userId) {
            closeModal('newChatModal');
            await startChatWithUser(userId);
        }
        
        // ==================== ГРУППЫ И КАНАЛЫ ====================
        let currentChatType = 'private';
        let selectedGroupMembers = [];
        let editingChatId = null;
        
        function selectChatType(type) {
            currentChatType = type;
            document.querySelectorAll('.chat-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            document.getElementById('privateChatForm').style.display = type === 'private' ? 'block' : 'none';
            document.getElementById('groupChatForm').style.display = type === 'group' ? 'block' : 'none';
            document.getElementById('channelChatForm').style.display = type === 'channel' ? 'block' : 'none';
            
            if (type === 'group') {
                selectedGroupMembers = [];
                renderSelectedMembers();
            }
        }
        
        // Поиск участников для группы
        const groupMemberSearch = document.getElementById('groupMemberSearch');
        if (groupMemberSearch) {
            groupMemberSearch.addEventListener('input', (e) => {
                clearTimeout(newChatSearchTimeout);
                const query = e.target.value.trim();
                if (query.length < 2) {
                    document.getElementById('groupMemberResults').innerHTML = '';
                    return;
                }
                newChatSearchTimeout = setTimeout(() => searchUsersForGroup(query), 300);
            });
        }
        
        async function searchUsersForGroup(query) {
            try {
                const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                const users = await res.json();
                const container = document.getElementById('groupMemberResults');
                
                const filteredUsers = users.filter(u => !selectedGroupMembers.find(m => m.id === u.id));
                
                if (filteredUsers.length === 0) {
                    container.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); text-align: center; font-size: 0.9rem;">Не найдено</div>';
                } else {
                    container.innerHTML = filteredUsers.map(user => `
                        <div class="user-result-item" onclick="addGroupMember(${user.id}, '${escapeHtml(user.name || user.username)}', '${user.avatar_url || ''}')">
                            <div class="user-result-avatar">
                                ${user.avatar_url ? `<img src="${user.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (user.name || user.username)[0].toUpperCase()}
                            </div>
                            <div class="user-result-info">
                                <div class="user-result-name">${escapeHtml(user.name || user.username)}</div>
                                <div class="user-result-username">@${user.username}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        function addGroupMember(id, name, avatar) {
            if (!selectedGroupMembers.find(m => m.id === id)) {
                selectedGroupMembers.push({ id, name, avatar });
                renderSelectedMembers();
                document.getElementById('groupMemberSearch').value = '';
                document.getElementById('groupMemberResults').innerHTML = '';
            }
        }
        
        function removeGroupMember(id) {
            selectedGroupMembers = selectedGroupMembers.filter(m => m.id !== id);
            renderSelectedMembers();
        }
        
        function renderSelectedMembers() {
            const container = document.getElementById('selectedGroupMembers');
            if (!container) return;
            container.innerHTML = selectedGroupMembers.map(m => `
                <div class="selected-member-chip">
                    <span>${escapeHtml(m.name)}</span>
                    <span class="remove-chip" onclick="removeGroupMember(${m.id})">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </span>
                </div>
            `).join('');
        }
        
        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                showToast('Введите название группы', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_type: 'group',
                        name: name,
                        description: document.getElementById('groupDescription').value.trim(),
                        is_public: document.getElementById('groupIsPublic').checked,
                        member_ids: selectedGroupMembers.map(m => m.id)
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    closeModal('newChatModal');
                    showToast('Группа создана', 'success');
                    await loadChats();
                    openChat(data.id);
                    
                    // Сброс формы
                    document.getElementById('groupName').value = '';
                    document.getElementById('groupDescription').value = '';
                    document.getElementById('groupIsPublic').checked = false;
                    selectedGroupMembers = [];
                    renderSelectedMembers();
                } else {
                    showToast(data.error || 'Ошибка создания группы', 'error');
                }
            } catch (err) {
                console.error('Error creating group:', err);
                showToast('Ошибка создания группы', 'error');
            }
        }
        
        async function createChannel() {
            const name = document.getElementById('channelName').value.trim();
            if (!name) {
                showToast('Введите название канала', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_type: 'channel',
                        name: name,
                        description: document.getElementById('channelDescription').value.trim(),
                        username: document.getElementById('channelUsername').value.trim(),
                        is_public: document.getElementById('channelIsPublic').checked
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    closeModal('newChatModal');
                    showToast('Канал создан', 'success');
                    await loadChats();
                    openChat(data.id);
                    
                    // Сброс формы
                    document.getElementById('channelName').value = '';
                    document.getElementById('channelDescription').value = '';
                    document.getElementById('channelUsername').value = '';
                    document.getElementById('channelIsPublic').checked = false;
                } else {
                    showToast(data.error || 'Ошибка создания канала', 'error');
                }
            } catch (err) {
                console.error('Error creating channel:', err);
                showToast('Ошибка создания канала', 'error');
            }
        }
        
        // Настройки группы/канала
        async function openChatSettings() {
            if (!currentChat || !currentChat.is_group) return;
            
            editingChatId = currentChat.id;
            document.getElementById('chatSettingsTitle').textContent = 
                currentChat.chat_type === 'channel' ? 'Настройки канала' : 'Настройки группы';
            
            document.getElementById('settingsChatName').value = currentChat.name || '';
            document.getElementById('settingsChatDescription').value = currentChat.description || '';
            document.getElementById('settingsChatUsername').value = currentChat.username || '';
            document.getElementById('settingsInviteLink').value = currentChat.invite_link ? 
                `${window.location.origin}/join/${currentChat.invite_link}` : '';
            document.getElementById('settingsIsPublic').checked = currentChat.is_public || false;
            document.getElementById('settingsMembersCanSend').checked = currentChat.members_can_send !== false;
            document.getElementById('settingsMembersCanAdd').checked = currentChat.members_can_add || false;
            document.getElementById('settingsMembersCanPin').checked = currentChat.members_can_pin || false;
            document.getElementById('settingsSlowMode').value = currentChat.slow_mode || 0;
            
            // Аватар чата
            const avatarPreview = document.getElementById('settingsChatAvatar');
            if (currentChat.avatar_url) {
                avatarPreview.innerHTML = `<img src="${currentChat.avatar_url}" alt="">`;
            } else {
                avatarPreview.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`;
            }
            
            // Рабочий чат
            const workChatCheckbox = document.getElementById('settingsIsWorkChat');
            if (workChatCheckbox) {
                workChatCheckbox.checked = currentChat.is_work_chat || false;
            }
            
            switchSettingsTab('general');
            document.getElementById('chatSettingsModal').classList.add('show');
            
            // Загружаем участников
            loadChatMembers();
        }
        
        async function uploadChatAvatar(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            if (!file.type.startsWith('image/')) {
                showToast('Выберите изображение', 'error');
                return;
            }
            
            // Показываем превью сразу
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('settingsChatAvatar').innerHTML = `<img src="${e.target.result}" alt="">`;
            };
            reader.readAsDataURL(file);
            
            // Загружаем на сервер
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch(`/api/chats/${editingChatId}/avatar`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                if (data.success) {
                    showToast('Аватар обновлён', 'success');
                } else {
                    showToast(data.error || 'Ошибка загрузки', 'error');
                }
            } catch (err) {
                console.error('Error uploading avatar:', err);
                showToast('Ошибка загрузки', 'error');
            }
        }
        
        function switchSettingsTab(tab) {
            document.querySelectorAll('.settings-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            document.getElementById('settingsGeneral').style.display = tab === 'general' ? 'block' : 'none';
            document.getElementById('settingsPermissions').style.display = tab === 'permissions' ? 'block' : 'none';
            document.getElementById('settingsMembers').style.display = tab === 'members' ? 'block' : 'none';
        }
        
        let currentChatMembers = [];
        
        async function loadChatMembers() {
            if (!editingChatId) return;
            
            try {
                const res = await fetch(`/api/chats/${editingChatId}/members`);
                const members = await res.json();
                currentChatMembers = members;
                
                const container = document.getElementById('settingsMembersList');
                const isOwner = currentChat && currentChat.owner_id === currentUser.id;
                const userMembership = members.find(m => m.id === currentUser.id);
                const canManage = isOwner || (userMembership && userMembership.role === 'admin');
                
                container.innerHTML = members.map(m => `
                    <div class="member-item">
                        <div class="member-avatar">
                            ${m.avatar_url ? `<img src="${m.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (m.name || m.username)[0].toUpperCase()}
                        </div>
                        <div class="member-info">
                            <div class="member-name">${escapeHtml(m.name || m.username)}</div>
                            <div class="member-role">@${m.username}</div>
                        </div>
                        ${m.role === 'owner' ? '<span class="role-badge owner">Владелец</span>' : 
                          m.role === 'admin' ? '<span class="role-badge admin">Админ</span>' : ''}
                        ${m.role !== 'owner' && canManage ? `
                            <div class="member-actions">
                                ${isOwner ? `<button class="icon-btn" onclick="toggleMemberRole(${m.id}, '${m.role}')" title="${m.role === 'admin' ? 'Снять админа' : 'Назначить админом'}">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                </button>` : ''}
                                <button class="icon-btn" onclick="removeMember(${m.id})" title="Удалить" style="color: #ef4444;">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading members:', err);
            }
        }
        
        // Поиск участников для добавления в настройках
        const settingsMemberSearch = document.getElementById('settingsMemberSearch');
        if (settingsMemberSearch) {
            let settingsSearchTimeout = null;
            settingsMemberSearch.addEventListener('input', (e) => {
                clearTimeout(settingsSearchTimeout);
                const query = e.target.value.trim();
                if (query.length < 2) {
                    document.getElementById('settingsMemberResults').innerHTML = '';
                    return;
                }
                settingsSearchTimeout = setTimeout(() => searchUsersForSettings(query), 300);
            });
        }
        
        async function searchUsersForSettings(query) {
            try {
                const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                const users = await res.json();
                const container = document.getElementById('settingsMemberResults');
                
                // Фильтруем уже добавленных участников
                const memberIds = currentChatMembers.map(m => m.id);
                const filteredUsers = users.filter(u => !memberIds.includes(u.id));
                
                if (filteredUsers.length === 0) {
                    container.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); text-align: center; font-size: 0.9rem;">Не найдено</div>';
                } else {
                    container.innerHTML = filteredUsers.map(user => `
                        <div class="user-result-item" onclick="addMemberFromSettings(${user.id})">
                            <div class="user-result-avatar">
                                ${user.avatar_url ? `<img src="${user.avatar_url}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (user.name || user.username)[0].toUpperCase()}
                            </div>
                            <div class="user-result-info">
                                <div class="user-result-name">${escapeHtml(user.name || user.username)}</div>
                                <div class="user-result-username">@${user.username}</div>
                            </div>
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="var(--primary)" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        async function addMemberFromSettings(userId) {
            try {
                const res = await fetch(`/api/chats/${editingChatId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const data = await res.json();
                if (data.success) {
                    document.getElementById('settingsMemberSearch').value = '';
                    document.getElementById('settingsMemberResults').innerHTML = '';
                    await loadChatMembers();
                    showToast('Участник добавлен', 'success');
                } else {
                    showToast(data.error || 'Ошибка добавления', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                showToast('Ошибка добавления', 'error');
            }
        }
        
        async function toggleMemberRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'member' : 'admin';
            try {
                await fetch(`/api/chats/${editingChatId}/members/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                loadChatMembers();
                showToast(newRole === 'admin' ? 'Назначен администратором' : 'Права администратора сняты', 'success');
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        async function removeMember(userId) {
            const confirmed = await showConfirm('Удалить участника из чата?', 'Удаление', { danger: true, okText: 'Удалить' });
            if (!confirmed) return;
            
            try {
                await fetch(`/api/chats/${editingChatId}/members/${userId}`, { method: 'DELETE' });
                loadChatMembers();
                showToast('Участник удалён', 'success');
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        async function saveChatSettings() {
            const name = document.getElementById('settingsChatName').value.trim();
            if (!name) {
                showToast('Введите название', 'error');
                return;
            }
            
            try {
                const res = await fetch(`/api/chats/${editingChatId}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: document.getElementById('settingsChatDescription').value.trim(),
                        username: document.getElementById('settingsChatUsername').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''),
                        is_public: document.getElementById('settingsIsPublic').checked,
                        is_work_chat: document.getElementById('settingsIsWorkChat')?.checked || false,
                        members_can_send: document.getElementById('settingsMembersCanSend').checked,
                        members_can_add: document.getElementById('settingsMembersCanAdd').checked,
                        members_can_pin: document.getElementById('settingsMembersCanPin').checked,
                        slow_mode: parseInt(document.getElementById('settingsSlowMode').value)
                    })
                });
                
                if (res.ok) {
                    closeModal('chatSettingsModal');
                    showToast('Настройки сохранены', 'success');
                    await loadChats();
                    if (currentChat) {
                        openChat(currentChat.id);
                    }
                } else {
                    const data = await res.json();
                    showToast(data.error || 'Ошибка сохранения', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                showToast('Ошибка сохранения', 'error');
            }
        }
        
        function copyInviteLink() {
            const input = document.getElementById('settingsInviteLink');
            navigator.clipboard.writeText(input.value);
            showToast('Ссылка скопирована', 'success');
        }
        
        async function regenerateInviteLink() {
            try {
                const res = await fetch(`/api/chats/${editingChatId}/invite-link`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('settingsInviteLink').value = 
                        `${window.location.origin}/join/${data.invite_link}`;
                    showToast('Ссылка обновлена', 'success');
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        async function deleteGroupOrChannel() {
            const confirmed = await showConfirm(
                'Вы уверены? Это действие нельзя отменить.',
                'Удаление',
                { danger: true, okText: 'Удалить навсегда' }
            );
            
            if (!confirmed) return;
            
            try {
                await fetch(`/api/chats/${editingChatId}`, { method: 'DELETE' });
                closeModal('chatSettingsModal');
                currentChat = null;
                await loadChats();
                renderChatUI();
                showToast('Удалено', 'success');
            } catch (err) {
                console.error('Error:', err);
            }
        }
        
        // Обновление бейджа непрочитанных в навигации
        function updateChatBadge() {
            const totalUnread = allChats.reduce((sum, chat) => sum + (chat.unread_count || 0), 0);
            const navItem = document.querySelector('.nav-item[data-section="chats"]');
            
            // Удаляем старый бейдж
            const oldBadge = navItem.querySelector('.nav-badge');
            if (oldBadge) oldBadge.remove();
            
            // Добавляем новый, если есть непрочитанные
            if (totalUnread > 0) {
                const badge = document.createElement('span');
                badge.className = 'nav-badge';
                badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                navItem.appendChild(badge);
            }
        }
        
        // Генерация звёздного фона
        function createStars() {
            const container = document.getElementById('starsBg');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 2 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                star.style.setProperty('--opacity', Math.random() * 0.5 + 0.3);
                star.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(star);
            }
        }
        
        // ==================== ТЕМА ====================
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const label = document.getElementById('themeLabel');
            if (label) {
                label.textContent = theme === 'dark' ? 'Тёмная тема' : 'Светлая тема';
            }
            localStorage.setItem('theme', theme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            
            // Сохраняем на сервере
            fetch('/api/focus/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme: newTheme })
            }).catch(() => {});
            
            showToast(newTheme === 'dark' ? 'Тёмная тема' : 'Светлая тема', 'success');
        }
        
        // ==================== НАПОМИНАНИЯ О ЗДОРОВЬЕ ====================
        let waterReminderTimer = null;
        let eyeReminderTimer = null;
        let eyeExerciseTimer = null;
        
        function initHealthReminders() {
            // Очищаем старые таймеры
            if (waterReminderTimer) clearInterval(waterReminderTimer);
            if (eyeReminderTimer) clearInterval(eyeReminderTimer);
            
            // Напоминание о воде
            if (focusSettings.water_reminder) {
                const waterInterval = (focusSettings.water_interval || 30) * 60 * 1000;
                waterReminderTimer = setInterval(() => {
                    if (timerRunning) { // Только во время фокуса
                        showWaterReminder();
                    }
                }, waterInterval);
            }
            
            // Напоминание для глаз (правило 20-20-20)
            if (focusSettings.eye_reminder) {
                const eyeInterval = (focusSettings.eye_interval || 20) * 60 * 1000;
                eyeReminderTimer = setInterval(() => {
                    if (timerRunning) { // Только во время фокуса
                        showEyeReminder();
                    }
                }, eyeInterval);
            }
        }
        
        function showWaterReminder() {
            document.getElementById('waterReminderModal').classList.add('show');
            // Звуковой сигнал
            playNotificationSound();
        }
        
        function showEyeReminder() {
            document.getElementById('eyeReminderModal').classList.add('show');
            document.getElementById('eyeExerciseContainer').style.display = 'none';
            document.getElementById('eyeExerciseActions').style.display = 'flex';
            playNotificationSound();
        }
        
        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 440;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) {}
        }
        
        function snoozeReminder(type, minutes) {
            closeModal(type === 'water' ? 'waterReminderModal' : 'eyeReminderModal');
            showToast(`Напомню через ${minutes} минут`, 'info');
            
            setTimeout(() => {
                if (type === 'water') {
                    showWaterReminder();
                } else {
                    showEyeReminder();
                }
            }, minutes * 60 * 1000);
        }
        
        function dismissReminder(type) {
            closeModal(type === 'water' ? 'waterReminderModal' : 'eyeReminderModal');
            if (type === 'water') {
                showToast('Отлично! Продолжайте работу', 'success');
            }
        }
        
        function startEyeExercise() {
            document.getElementById('eyeExerciseContainer').style.display = 'flex';
            document.getElementById('eyeExerciseActions').style.display = 'none';
            
            let seconds = 20;
            const timerEl = document.getElementById('eyeExerciseTimer');
            timerEl.textContent = seconds;
            
            eyeExerciseTimer = setInterval(() => {
                seconds--;
                timerEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(eyeExerciseTimer);
                    closeModal('eyeReminderModal');
                    showToast('Отлично! Глаза отдохнули', 'success');
                }
            }, 1000);
        }
        
        // ==================== ПОДЗАДАЧИ ====================
        async function toggleSubtask(subtaskId, isCompleted) {
            try {
                await fetch(`/api/subtasks/${subtaskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_completed: isCompleted })
                });
                loadTasks();
            } catch (err) {
                showToast('Ошибка обновления подзадачи', 'error');
            }
        }
        
        async function addSubtask(taskId) {
            const input = document.getElementById(`subtaskInput-${taskId}`);
            const title = input.value.trim();
            if (!title) return;
            
            try {
                await fetch(`/api/tasks/${taskId}/subtasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                input.value = '';
                loadTasks();
            } catch (err) {
                showToast('Ошибка добавления подзадачи', 'error');
            }
        }
        
        async function deleteSubtask(subtaskId) {
            try {
                await fetch(`/api/subtasks/${subtaskId}`, { method: 'DELETE' });
                loadTasks();
            } catch (err) {
                showToast('Ошибка удаления подзадачи', 'error');
            }
        }
        
        function showSubtaskInput(taskId) {
            const wrapper = document.getElementById(`subtaskInputWrapper-${taskId}`);
            const btn = document.getElementById(`addSubtaskBtn-${taskId}`);
            if (wrapper && btn) {
                wrapper.style.display = 'flex';
                btn.style.display = 'none';
                document.getElementById(`subtaskInput-${taskId}`).focus();
            }
        }
        
        function hideSubtaskInput(taskId) {
            const wrapper = document.getElementById(`subtaskInputWrapper-${taskId}`);
            const btn = document.getElementById(`addSubtaskBtn-${taskId}`);
            if (wrapper && btn) {
                wrapper.style.display = 'none';
                btn.style.display = 'flex';
            }
        }
        
        // ==================== ЖУРНАЛ НАСТРОЕНИЯ ====================
        let currentMood = null;
        
        async function loadMoodData() {
            try {
                const [entriesRes, statsRes] = await Promise.all([
                    fetch('/api/mood?days=14'),
                    fetch('/api/mood/stats?days=14')
                ]);
                const entries = await entriesRes.json();
                const stats = await statsRes.json();
                
                // Проверяем, есть ли запись за сегодня
                const today = new Date().toISOString().split('T')[0];
                const todayEntry = entries.find(e => e.date === today);
                if (todayEntry) {
                    currentMood = todayEntry.mood;
                    document.querySelectorAll('.mood-emoji-btn').forEach(btn => {
                        btn.classList.toggle('selected', parseInt(btn.dataset.mood) === currentMood);
                    });
                }
                
                // Рендерим график настроения
                renderMoodChart(entries);
            } catch (err) {
                console.error('Error loading mood:', err);
            }
        }
        
        async function setMood(mood) {
            try {
                await fetch('/api/mood', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mood, energy: 3 })
                });
                
                currentMood = mood;
                document.querySelectorAll('.mood-emoji-btn').forEach(btn => {
                    btn.classList.toggle('selected', parseInt(btn.dataset.mood) === mood);
                });
                
                const moodNames = ['', 'Очень плохо', 'Плохо', 'Нормально', 'Хорошо', 'Отлично'];
                showToast(`Настроение: ${moodNames[mood]}`, 'success');
                loadMoodData();
            } catch (err) {
                showToast('Ошибка сохранения', 'error');
            }
        }
        
        function renderMoodChart(entries) {
            const container = document.getElementById('moodChart');
            if (!container) return;
            
            // Последние 14 дней
            const days = [];
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d.toISOString().split('T')[0]);
            }
            
            const entryMap = {};
            entries.forEach(e => entryMap[e.date] = e.mood);
            
            container.innerHTML = days.map(day => {
                const mood = entryMap[day] || 0;
                const height = mood ? (mood * 20) : 4;
                const isToday = day === new Date().toISOString().split('T')[0];
                return `<div class="mood-bar mood-${mood || 0}" style="height: ${height}px; ${isToday ? 'box-shadow: 0 0 8px var(--primary);' : ''}" title="${day}: ${mood ? ['','😢','😔','😐','🙂','😄'][mood] : 'Нет данных'}"></div>`;
            }).join('');
        }
        
        // ==================== РАСШИРЕННАЯ СТАТИСТИКА ====================
        async function loadStats(period = 'week') {
            // Обновляем активный таб
            document.querySelectorAll('.stats-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.period === period);
            });
            
            try {
                let stats;
                if (period === 'week') {
                    const res = await fetch('/api/focus/stats');
                    stats = await res.json();
                    document.getElementById('summaryMinutes').textContent = stats.week.total_minutes;
                    document.getElementById('summarySessions').textContent = stats.week.total_sessions;
                    document.getElementById('summaryAvg').textContent = Math.round(stats.week.total_minutes / 7);
                    document.getElementById('summaryBestHour').textContent = '-';
                    renderWeeklyChart(stats.week.daily);
                } else {
                    const res = await fetch(`/api/focus/stats/extended?period=${period}`);
                    stats = await res.json();
                    document.getElementById('summaryMinutes').textContent = stats.summary.total_minutes;
                    document.getElementById('summarySessions').textContent = stats.summary.total_sessions;
                    document.getElementById('summaryAvg').textContent = stats.summary.avg_daily_minutes;
                    document.getElementById('summaryBestHour').textContent = stats.summary.best_hour.hour + ':00';
                    renderExtendedChart(stats.daily, period);
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }
        
        function renderExtendedChart(daily, period) {
            const container = document.getElementById('weeklyChart');
            if (!container) return;
            
            const days = Object.keys(daily).sort();
            if (days.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Нет данных за этот период</div>';
                return;
            }
            
            const maxMinutes = Math.max(...Object.values(daily).map(d => d.minutes), 1);
            const today = new Date().toISOString().split('T')[0];
            
            // Для месяца показываем каждый 3-й день, для года - каждую неделю
            const step = period === 'year' ? 7 : (period === 'month' ? 3 : 1);
            const filteredDays = days.filter((_, i) => i % step === 0 || i === days.length - 1);
            
            container.innerHTML = filteredDays.map(day => {
                const d = daily[day];
                const height = Math.max((d.minutes / maxMinutes) * 100, 4);
                const isToday = day === today;
                const label = new Date(day).toLocaleDateString('ru', { day: 'numeric', month: 'short' });
                return `<div class="chart-bar ${d.minutes > 0 ? 'has-data' : ''} ${isToday ? 'today' : ''}" 
                            style="height: ${height}%;" 
                            data-label="${label}" 
                            data-value="${d.minutes} мин"></div>`;
            }).join('');
        }
        
        // ==================== ШАБЛОНЫ ЗАДАЧ ====================
        let templates = [];
        
        async function loadTemplates() {
            try {
                const res = await fetch('/api/templates');
                templates = await res.json();
                renderTemplates();
            } catch (err) {
                console.error('Error loading templates:', err);
            }
        }
        
        // SVG иконки для шаблонов
        const templateIcons = {
            'document': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
            'laptop': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="2" y1="20" x2="22" y2="20"/></svg>',
            'screens': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="9" height="9" rx="1"/><rect x="13" y="2" width="9" height="9" rx="1" fill="currentColor" opacity="0.3"/><rect x="2" y="13" width="9" height="9" rx="1" fill="currentColor" opacity="0.3"/><rect x="13" y="13" width="9" height="9" rx="1"/></svg>',
            'pencil': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>',
            'palette': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="1.5" fill="currentColor"/><circle cx="17.5" cy="10.5" r="1.5" fill="currentColor"/><circle cx="8.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="6.5" cy="12.5" r="1.5" fill="currentColor"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/></svg>',
            'dumbbell': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.5 6.5h11M6.5 17.5h11"/><rect x="2" y="5" width="4" height="14" rx="1"/><rect x="18" y="5" width="4" height="14" rx="1"/><rect x="5" y="8" width="2" height="8" rx="0.5"/><rect x="17" y="8" width="2" height="8" rx="0.5"/></svg>',
            'meditation': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="2.5"/><path d="M12 8v3"/><path d="M8 21c0-3 1-5 4-5s4 2 4 5"/><path d="M6 14c1.5-1 3-1.5 6-1.5s4.5.5 6 1.5"/><path d="M4 17c1-1 2.5-2 4-2.5"/><path d="M20 17c-1-1-2.5-2-4-2.5"/></svg>',
            'target': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>',
            'book': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
            'coffee': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
            'brain': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M12 5v13"/></svg>',
            'rocket': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
            'timer': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2 2"/><path d="M5 3L2 6"/><path d="M22 6l-3-3"/><path d="M12 2v2"/></svg>',
            'lightning': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
        };
        
        function getTemplateIconSvg(iconName) {
            return templateIcons[iconName] || templateIcons['document'];
        }
        
        function renderTemplates() {
            const container = document.getElementById('templatesGrid');
            if (!container) return;
            
            // Дефолтные шаблоны (показываем только если нет шаблонов из БД)
            const defaultTemplates = [
                { id: 'default-pomodoro', icon: 'timer', name: 'Помодоро', description: 'Классический 25/5', timer_minutes: 25, break_minutes: 5, is_default: true },
                { id: 'default-deep', icon: 'brain', name: 'Глубокая работа', description: '50 минут фокуса', timer_minutes: 50, break_minutes: 10, is_default: true },
                { id: 'default-quick', icon: 'lightning', name: 'Быстрая задача', description: '15 минут спринт', timer_minutes: 15, break_minutes: 3, is_default: true }
            ];
            
            // Фильтруем: если из API пришли шаблоны с is_default, не добавляем локальные дефолтные
            const hasDbDefaults = templates.some(t => t.is_default);
            const allTemplates = hasDbDefaults ? templates : [...defaultTemplates, ...templates.filter(t => !t.is_default)];
            
            container.innerHTML = allTemplates.map(t => `
                <div class="template-card" onclick="createTaskFromTemplate(${typeof t.id === 'number' ? t.id : "'" + t.id + "'"})">
                    <div class="template-icon">${getTemplateIconSvg(t.icon)}</div>
                    <div class="template-name">${t.name}</div>
                    <div class="template-desc">${t.description || ''}</div>
                    <div class="template-meta">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span>${t.timer_minutes}/${t.break_minutes}</span>
                        ${!t.is_default && t.is_own ? `<span class="template-delete" onclick="event.stopPropagation(); deleteTemplate(${t.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('show');
            document.getElementById('templateForm').reset();
            selectTemplateIcon('document');
        }
        
        function selectTemplateIcon(icon) {
            document.querySelectorAll('.template-icon-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.icon === icon);
            });
            document.getElementById('templateIcon').value = icon;
        }
        
        document.getElementById('templateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const subtasksText = form.subtasks.value.trim();
            const subtasks = subtasksText ? subtasksText.split('\n').filter(s => s.trim()) : [];
            
            try {
                await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: form.name.value,
                        description: form.description.value,
                        icon: form.icon.value,
                        timer_minutes: parseInt(form.timer_minutes.value),
                        break_minutes: parseInt(form.break_minutes.value),
                        subtasks: subtasks
                    })
                });
                
                closeModal('templateModal');
                loadTemplates();
                showToast('Шаблон создан', 'success');
            } catch (err) {
                showToast('Ошибка создания шаблона', 'error');
            }
        });
        
        let isCreatingTask = false; // Защита от двойного клика
        let lastCreatedTemplateId = null; // Запоминаем последний созданный шаблон
        let lastCreatedTime = 0;
        
        async function createTaskFromTemplate(templateId) {
            // Защита от двойного клика - проверяем флаг и время
            const now = Date.now();
            if (isCreatingTask) {
                console.log('Blocked: isCreatingTask is true');
                return;
            }
            // Защита от повторного создания той же задачи в течение 2 секунд
            if (lastCreatedTemplateId === templateId && (now - lastCreatedTime) < 2000) {
                console.log('Blocked: same template within 2 seconds');
                return;
            }
            
            isCreatingTask = true;
            lastCreatedTemplateId = templateId;
            lastCreatedTime = now;
            
            // Визуальная блокировка - добавляем класс loading
            document.querySelectorAll('.template-card').forEach(card => {
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.6';
            });
            
            try {
                // Для дефолтных шаблонов создаём задачу напрямую
                if (typeof templateId === 'string' && templateId.startsWith('default-')) {
                    const defaults = {
                        'default-pomodoro': { title: 'Помодоро сессия', timer_minutes: 25, break_minutes: 5 },
                        'default-deep': { title: 'Глубокая работа', timer_minutes: 50, break_minutes: 10 },
                        'default-quick': { title: 'Быстрая задача', timer_minutes: 15, break_minutes: 3 }
                    };
                    const preset = defaults[templateId];
                    
                    await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(preset)
                    });
                    await loadTasks();
                    showToast('Задача создана из шаблона', 'success');
                    return;
                }
                
                // Для пользовательских шаблонов
                await fetch('/api/tasks/from-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ template_id: templateId })
                });
                await loadTasks();
                showToast('Задача создана из шаблона', 'success');
            } catch (err) {
                showToast('Ошибка создания задачи', 'error');
            } finally {
                // Разблокируем через 1 секунду
                setTimeout(() => { 
                    isCreatingTask = false;
                    document.querySelectorAll('.template-card').forEach(card => {
                        card.style.pointerEvents = '';
                        card.style.opacity = '';
                    });
                }, 1000);
            }
        }
        
        async function deleteTemplate(id) {
            if (!confirm('Удалить этот шаблон?')) return;
            try {
                await fetch(`/api/templates/${id}`, { method: 'DELETE' });
                loadTemplates();
                showToast('Шаблон удалён', 'success');
            } catch (err) {
                showToast('Ошибка удаления', 'error');
            }
        }
        
        // ==================== ФАЗА 3: ДОСТИЖЕНИЯ ====================
        
        // SVG иконки для достижений
        const achievementSvgIcons = {
            'first_session': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v6m0 0l-3-3m3 3l3-3"/><path d="M12 22c-4 0-7-2-7-5 0-2 1-4 3-5 1-1 2-2 2-4h4c0 2 1 3 2 4 2 1 3 3 3 5 0 3-3 5-7 5z"/></svg>`,
            'sessions_10': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18m-6-6c0 3 2.5 6 6 6s6-3 6-6c0-4-3-5-6-8-3 3-6 4-6 8z"/><path d="M9 8c-1-1-2-3-2-5m8 5c1-1 2-3 2-5"/></svg>`,
            'sessions_50': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c-4 0-8-2-8-6 0-3 2-5 4-7 1-1 2-3 2-5h4c0 2 1 4 2 5 2 2 4 4 4 7 0 4-4 6-8 6z"/><path d="M8 6c-1-2-1-4 0-5m8 5c1-2 1-4 0-5"/><path d="M12 22v-4"/></svg>`,
            'sessions_100': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3 6 6 1-4 4 1 6-6-3-6 3 1-6-4-4 6-1z"/></svg>`,
            'streak_3': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2c0 4-4 6-4 10 0 3 2 5 4 5s4-2 4-5c0-4-4-6-4-10z"/><path d="M12 22v-5"/></svg>`,
            'streak_7': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 17l2-7 4 4 4-8 4 6 2-3"/><circle cx="12" cy="12" r="10"/></svg>`,
            'streak_30': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg>`,
            'hours_10': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
            'hours_50': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3m10-10h-3M5 12H2"/></svg>`,
            'hours_100': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12c0-3 2-6 5-7l1 2c-2 1-3 3-3 5s1 4 3 5l-1 2c-3-1-5-4-5-7z"/><path d="M21 12c0 3-2 6-5 7l-1-2c2-1 3-3 3-5s-1-4-3-5l1-2c3 1 5 4 5 7z"/><path d="M9 12l2 2 4-4"/></svg>`,
            'perfect_session': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2 4 4 1-3 3 1 5-4-2-4 2 1-5-3-3 4-1z"/><circle cx="12" cy="18" r="3"/></svg>`,
            'early_bird': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.5-7.5l-1.5 1.5m-10 10l-1.5 1.5m13-1.5l-1.5-1.5m-10-10L4.5 4.5"/></svg>`,
            'night_owl': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="10" r="2"/><circle cx="15" cy="10" r="2"/><path d="M12 2C6 2 3 7 3 12c0 6 4 10 9 10s9-4 9-10c0-5-3-10-9-10z"/><path d="M8 16c1 1 2 2 4 2s3-1 4-2"/><path d="M3 7c2-1 4-1 6 0m6 0c2-1 4-1 6 0"/></svg>`,
            'tree_level_5': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22v-8"/><path d="M8 22h8"/><path d="M12 14c-4 0-6-3-6-6 0-2 1-4 3-5 1-1 2-2 3-3 1 1 2 2 3 3 2 1 3 3 3 5 0 3-2 6-6 6z"/></svg>`,
            'tree_level_10': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22v-6"/><path d="M9 22h6"/><path d="M12 16c-5 0-8-4-8-8 0-3 2-5 4-6 1-1 3-2 4-2s3 1 4 2c2 1 4 3 4 6 0 4-3 8-8 8z"/><path d="M8 10c0-2 2-4 4-4s4 2 4 4"/></svg>`,
            'tasks_10': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 12l2 2 4-4"/><path d="M3 9h18"/></svg>`,
            'tasks_50': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h4l3-9 4 18 3-9h4"/></svg>`,
            'gratitude_7': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21c-5-4-9-8-9-12 0-3 2-5 5-5 2 0 3 1 4 2 1-1 2-2 4-2 3 0 5 2 5 5 0 4-4 8-9 12z"/></svg>`,
            'mood_streak_7': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/></svg>`,
            'memory_master': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8 2 5 5 5 9c0 2 1 4 2 5v8h10v-8c1-1 2-3 2-5 0-4-3-7-7-7z"/><path d="M9 22h6"/><path d="M10 14h4"/></svg>`
        };
        
        function getAchievementSvg(type) {
            return achievementSvgIcons[type] || `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg>`;
        }
        
        async function loadAchievements() {
            try {
                const res = await fetch('/api/achievements');
                const data = await res.json();
                
                document.getElementById('achievementsCount').textContent = 
                    `${data.unlocked_count}/${data.total_count}`;
                
                const grid = document.getElementById('achievementsGrid');
                grid.innerHTML = data.achievements.map(a => `
                    <div class="achievement-card ${a.unlocked ? 'unlocked' : 'locked'}" title="${a.description}">
                        <div class="achievement-icon">${getAchievementSvg(a.type)}</div>
                        <div class="achievement-name">${a.name}</div>
                        <div class="achievement-desc">${a.description}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading achievements:', err);
            }
        }
        
        function showAchievementToast(achievement) {
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `
                <div class="achievement-toast-icon">${getAchievementSvg(achievement.type)}</div>
                <div class="achievement-toast-title">Достижение разблокировано!</div>
                <div class="achievement-toast-name">${achievement.name}</div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'achievementPop 0.3s ease reverse forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        async function checkAchievements() {
            try {
                const res = await fetch('/api/achievements/check', { method: 'POST' });
                const data = await res.json();
                
                if (data.unlocked && data.unlocked.length > 0) {
                    data.unlocked.forEach((a, i) => {
                        setTimeout(() => showAchievementToast(a), i * 3500);
                    });
                    loadAchievements();
                }
            } catch (err) {
                console.error('Error checking achievements:', err);
            }
        }
        
        // ==================== ФАЗА 3: ПРОГРЕСС ЗАДАЧ ====================
        
        async function loadTasksProgress() {
            try {
                const res = await fetch('/api/tasks/progress');
                const data = await res.json();
                
                // Обновляем статистику
                document.getElementById('tasksPending').textContent = data.status.pending;
                document.getElementById('tasksInProgress').textContent = data.status.in_progress;
                document.getElementById('tasksCompleted').textContent = data.status.completed;
                const total = data.status.pending + data.status.in_progress + data.status.completed;
                document.getElementById('tasksTotal').textContent = total;
                
                // Обновляем круговой прогресс
                const rate = data.completion_rate;
                document.getElementById('completionRate').textContent = rate + '%';
                const circle = document.getElementById('progressCircle');
                const offset = 314 - (314 * rate / 100);
                circle.style.strokeDashoffset = offset;
                
                // Обновляем недельный график
                const chart = document.getElementById('tasksWeeklyChart');
                const maxCompleted = Math.max(...data.weekly.map(d => d.completed), 1);
                const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
                
                chart.innerHTML = data.weekly.map((d, i) => {
                    const height = (d.completed / maxCompleted) * 80 + 4;
                    const dayIndex = new Date(d.date).getDay();
                    const dayName = days[dayIndex === 0 ? 6 : dayIndex - 1];
                    return `
                        <div class="progress-bar-day ${d.completed > 0 ? 'has-data' : ''}" 
                             style="height: ${height}px;" 
                             data-day="${dayName}"
                             title="${d.completed} задач"></div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Error loading tasks progress:', err);
            }
        }
        
        // ==================== ФАЗА 3: ЖУРНАЛ БЛАГОДАРНОСТИ ====================
        
        let selectedGratitudeCategory = 'general';
        const gratitudeIcons = {
            general: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg>`,
            work: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>`,
            health: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M12 21c-5-4-9-8-9-12a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 4-4 8-9 12z"/></svg>`,
            relationships: `<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 21c-5-4-9-8-9-12a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 4-4 8-9 12z"/></svg>`,
            growth: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 17l6-6 4 4 8-8"/><path d="M17 7h4v4"/></svg>`
        };
        
        function selectGratitudeCategory(cat) {
            selectedGratitudeCategory = cat;
            document.querySelectorAll('.gratitude-cat-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.cat === cat);
            });
        }
        
        async function loadGratitudeEntries() {
            try {
                const res = await fetch('/api/gratitude?days=30');
                const entries = await res.json();
                
                const list = document.getElementById('gratitudeList');
                if (entries.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state" style="padding: 30px;">
                            <div class="empty-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 21c-5-4-9-8-9-12a5 5 0 0 1 9-3 5 5 0 0 1 9 3c0 4-4 8-9 12z"/></svg></div>
                            <p>Начните записывать, за что вы благодарны</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = entries.map(e => `
                    <div class="gratitude-item">
                        <div class="gratitude-item-icon">${gratitudeIcons[e.category] || '🌟'}</div>
                        <div class="gratitude-item-content">
                            <div class="gratitude-item-text">${escapeHtml(e.content)}</div>
                            <div class="gratitude-item-date">${formatDate(e.date)}</div>
                        </div>
                        <span class="gratitude-item-delete" onclick="deleteGratitude(${e.id})"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading gratitude:', err);
            }
        }
        
        async function addGratitudeEntry() {
            const input = document.getElementById('gratitudeInput');
            const content = input.value.trim();
            
            if (!content) {
                showToast('Введите текст', 'warning');
                return;
            }
            
            try {
                const res = await fetch('/api/gratitude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        category: selectedGratitudeCategory
                    })
                });
                const data = await res.json();
                
                input.value = '';
                loadGratitudeEntries();
                showToast('Запись добавлена', 'success');
                
                // Проверяем достижения
                if (data.unlocked && data.unlocked.length > 0) {
                    data.unlocked.forEach((a, i) => {
                        setTimeout(() => showAchievementToast(a), i * 3500);
                    });
                    loadAchievements();
                }
            } catch (err) {
                showToast('Ошибка сохранения', 'error');
            }
        }
        
        async function deleteGratitude(id) {
            try {
                await fetch(`/api/gratitude/${id}`, { method: 'DELETE' });
                loadGratitudeEntries();
            } catch (err) {
                showToast('Ошибка удаления', 'error');
            }
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) return 'Сегодня';
            if (date.toDateString() === yesterday.toDateString()) return 'Вчера';
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== ФАЗА 3: ИГРА НА ПАМЯТЬ ====================
        
        let memorySequence = [];
        let playerSequence = [];
        let memoryLevel = 1;
        let memoryBest = 0;
        let memoryGameActive = false;
        
        async function loadMemoryScores() {
            try {
                const res = await fetch('/api/memory-game/scores?type=sequence');
                const data = await res.json();
                memoryBest = data.personal_best.level;
                document.getElementById('memoryBest').textContent = memoryBest;
            } catch (err) {
                console.error('Error loading memory scores:', err);
            }
        }
        
        function startMemoryGame() {
            memoryLevel = 1;
            memorySequence = [];
            document.getElementById('memoryLevel').textContent = memoryLevel;
            document.getElementById('memoryStartBtn').style.display = 'none';
            document.getElementById('memoryButtons').style.display = 'grid';
            nextMemoryRound();
        }
        
        function nextMemoryRound() {
            playerSequence = [];
            memoryGameActive = false;
            
            // Добавляем новое число в последовательность
            memorySequence.push(Math.floor(Math.random() * 9) + 1);
            
            document.getElementById('memoryMessage').textContent = 'Запоминайте...';
            
            // Показываем последовательность
            showSequence();
        }
        
        function showSequence() {
            const display = document.getElementById('sequenceDisplay');
            display.innerHTML = memorySequence.map(() => `
                <div class="sequence-item">?</div>
            `).join('');
            
            let i = 0;
            const interval = setInterval(() => {
                if (i > 0) {
                    display.children[i - 1].classList.remove('highlight');
                    display.children[i - 1].textContent = '?';
                }
                
                if (i < memorySequence.length) {
                    display.children[i].classList.add('highlight');
                    display.children[i].textContent = memorySequence[i];
                    
                    // Подсвечиваем кнопку
                    const btn = document.querySelector(`.memory-btn[data-num="${memorySequence[i]}"]`);
                    if (btn) {
                        btn.classList.add('flash');
                        setTimeout(() => btn.classList.remove('flash'), 400);
                    }
                    i++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        display.innerHTML = memorySequence.map(() => `
                            <div class="sequence-item">?</div>
                        `).join('');
                        document.getElementById('memoryMessage').textContent = 'Ваш ход!';
                        memoryGameActive = true;
                    }, 500);
                }
            }, 800);
        }
        
        function memoryInput(num) {
            if (!memoryGameActive) return;
            
            playerSequence.push(num);
            const display = document.getElementById('sequenceDisplay');
            const idx = playerSequence.length - 1;
            
            if (num === memorySequence[idx]) {
                // Правильно
                display.children[idx].textContent = num;
                display.children[idx].classList.add('correct');
                
                if (playerSequence.length === memorySequence.length) {
                    // Уровень пройден
                    memoryGameActive = false;
                    memoryLevel++;
                    document.getElementById('memoryLevel').textContent = memoryLevel;
                    document.getElementById('memoryMessage').textContent = '✨ Отлично!';
                    
                    setTimeout(() => nextMemoryRound(), 1000);
                }
            } else {
                // Неправильно
                display.children[idx].textContent = num;
                display.children[idx].classList.add('wrong');
                memoryGameActive = false;
                
                document.getElementById('memoryMessage').textContent = `Игра окончена! Уровень: ${memoryLevel - 1}`;
                
                // Сохраняем результат
                saveMemoryScore(memoryLevel - 1);
                
                setTimeout(() => {
                    document.getElementById('memoryButtons').style.display = 'none';
                    document.getElementById('memoryStartBtn').style.display = 'block';
                    document.getElementById('sequenceDisplay').innerHTML = '';
                }, 2000);
            }
        }
        
        async function saveMemoryScore(level) {
            if (level < 1) return;
            
            try {
                const res = await fetch('/api/memory-game/scores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        game_type: 'sequence',
                        score: level * 100,
                        level: level
                    })
                });
                const data = await res.json();
                
                if (level > memoryBest) {
                    memoryBest = level;
                    document.getElementById('memoryBest').textContent = memoryBest;
                    showToast(`Новый рекорд: ${level} уровень!`, 'success');
                }
                
                // Проверяем достижения
                if (data.unlocked && data.unlocked.length > 0) {
                    data.unlocked.forEach((a, i) => {
                        setTimeout(() => showAchievementToast(a), i * 3500);
                    });
                    loadAchievements();
                }
            } catch (err) {
                console.error('Error saving memory score:', err);
            }
        }
        
        // Загрузка данных прогресса при переключении на секцию
        function loadProgressData() {
            loadAchievements();
            loadTasksProgress();
            loadGratitudeEntries();
            loadMemoryScores();
        }
        
        // Enter для добавления благодарности
        document.getElementById('gratitudeInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addGratitudeEntry();
        });
        
        // Инициализация
        createStars();
        loadUser();
        loadTasks();
        loadNotes();
        loadPlaylists();
        loadChats();
        loadFocusData();
        
        // Применяем сохранённую тему из localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        }
        
        // Периодическое обновление чатов
        setInterval(loadChats, 10000);
    </script>
    
    <!-- Глобальный плеер - фиксированный внизу экрана -->
    <div class="player-panel" id="playerPanel" style="display: none;">
        <div class="player-info" style="cursor: pointer;" onclick="showTrackInfo()">
            <div class="player-track-name" id="playerTrackName">Трек не выбран</div>
            <div class="player-artist" id="playerArtist"></div>
        </div>
        
        <div class="player-controls">
            <button class="player-btn-small" id="shuffleBtn" onclick="toggleShuffle()" title="Случайный порядок">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
            </button>
            <button class="player-btn" onclick="prevTrack()" title="Предыдущий">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
            </button>
            <button class="player-btn-small" onclick="skipBackward()" title="Назад на 5 секунд">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2.5 12C2.5 7.5 6 4 10.5 4c3.5 0 6.5 2.2 7.8 5.3"/>
                    <path d="M2 9l.5 3 3-.5"/>
                    <text x="14" y="16" font-size="8" font-weight="bold" fill="currentColor" stroke="none" text-anchor="middle">5</text>
                </svg>
            </button>
            <button class="player-btn player-btn-main" id="playPauseBtn" onclick="togglePlay()" title="Воспроизвести">
                <svg viewBox="0 0 24 24" id="playIcon"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button class="player-btn-small" onclick="skipForward()" title="Вперед на 5 секунд">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 12c0 4.5-3.5 8-8 8-3.5 0-6.5-2.2-7.8-5.3"/>
                    <path d="M22 15l-.5-3-3 .5"/>
                    <text x="10" y="16" font-size="8" font-weight="bold" fill="currentColor" stroke="none" text-anchor="middle">5</text>
                </svg>
            </button>
            <button class="player-btn" onclick="nextTrack()" title="Следующий">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
            <button class="player-btn-small" id="repeatBtn" onclick="toggleRepeat()" title="Повтор">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" id="repeatIcon"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
            </button>
        </div>
        
        <div class="player-progress" onclick="seekTrack(event)" title="Перемотка">
            <div class="progress-bar-player" id="playerProgress"></div>
        </div>
        <div class="player-time" id="playerTime">0:00 / 0:00</div>
        
        <div class="player-extra">
            <div class="volume-control">
                <button class="player-btn-small" id="volumeBtn" onclick="toggleMute()" title="Громкость">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" id="volumeIcon"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                </button>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="100" oninput="setVolume(this.value)">
            </div>
            <div style="position: relative;">
                <button class="player-btn-small" id="playerMenuBtn" onclick="togglePlayerMenu()" title="Настройки">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </button>
                <div class="player-menu" id="playerMenu">
                    <div class="player-menu-header">Режим воспроизведения</div>
                    <div class="player-menu-item" onclick="setRepeatMode('none')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M5 12l1.41 1.41L11 8.83V20h2V8.83l4.59 4.58L19 12l-7-7-7 7z" transform="rotate(90 12 12)"/></svg>
                        Без повтора
                        <span style="margin-left: auto;" id="repeatNoneCheck"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>
                    </div>
                    <div class="player-menu-item" onclick="setRepeatMode('track')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/></svg>
                        Повтор трека
                        <span style="margin-left: auto; display: none;" id="repeatTrackCheck"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>
                    </div>
                    <div class="player-menu-item" onclick="setRepeatMode('playlist')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                        Повтор плейлиста
                        <span style="margin-left: auto; display: none;" id="repeatPlaylistCheck"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>
                    </div>
                    <div class="player-menu-divider"></div>
                    <div class="player-menu-header">Сортировка</div>
                    <div class="player-menu-item" onclick="sortTracks('default')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
                        По времени добавления
                    </div>
                    <div class="player-menu-item" onclick="sortTracks('title')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
                        По названию
                    </div>
                    <div class="player-menu-item" onclick="sortTracks('artist')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        По исполнителю
                    </div>
                    <div class="player-menu-item" onclick="sortTracks('reverse')">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M16 17.01V10h-2v7.01h-3L15 21l4-3.99h-3zM9 3L5 6.99h3V14h2V6.99h3L9 3z"/></svg>
                        Обратный порядок
                    </div>
                    <div class="player-menu-divider"></div>
                    <div class="player-menu-item" onclick="showTrackInfo()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                        Информация о треке
                    </div>
                    <div class="player-menu-item" onclick="editCurrentTrack()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        Редактировать трек
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Скрытый аудио плеер -->
    <audio id="audioPlayer" style="display: none;"></audio>
</body>
</html>
